<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0f1a">
    <meta name="apple-mobile-web-app-title" content="Life Tracker">
    <title>Life Tracker AI</title>
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #0a0f1a 0%, #111827 50%, #0a0f1a 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .container { max-width: 500px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .hidden { display: none !important; }
        
        /* Sync */
        .sync-status {
            position: fixed; top: 10px; right: 10px;
            padding: 6px 12px; border-radius: 20px; font-size: 11px; z-index: 1000;
            display: flex; align-items: center; gap: 6px;
        }
        .sync-status.synced { background: rgba(16,185,129,0.2); color: #10b981; }
        .sync-status.syncing { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .sync-status.offline { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        .settings-btn {
            position: fixed; top: 10px; left: 10px;
            padding: 6px 12px; border-radius: 20px; font-size: 11px; z-index: 1000;
            background: rgba(255,255,255,0.1); color: #94a3b8;
            border: none; cursor: pointer;
        }
        
        /* Cards */
        .card {
            background: rgba(255,255,255,0.04);
            border-radius: 16px; padding: 16px; margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card-title { font-size: 14px; font-weight: 600; color: #94a3b8; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        
        /* Header */
        .header { text-align: center; padding: 20px 0 24px; }
        .header-date { font-size: 14px; color: #64748b; margin-bottom: 4px; }
        .header-title { font-size: 24px; font-weight: 700; color: #fff; }
        .header-subtitle { font-size: 14px; color: #64748b; margin-top: 8px; }
        
        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .input-label { font-size: 13px; color: #94a3b8; margin-bottom: 6px; display: block; }
        .input-row { display: flex; gap: 8px; align-items: center; }
        .input-field {
            flex: 1; background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px; padding: 14px 16px;
            color: #fff; font-size: 16px; outline: none;
        }
        .input-field.center { text-align: center; font-size: 18px; font-weight: 600; }
        .input-field:focus { border-color: #3b82f6; background: rgba(59,130,246,0.1); }
        .input-field::placeholder { color: #64748b; font-weight: 400; }
        .input-unit { font-size: 14px; color: #64748b; min-width: 50px; }
        .input-separator { font-size: 24px; color: #64748b; }
        .input-hint { font-size: 12px; color: #64748b; margin-top: 8px; }
        
        /* Toggle */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .toggle-label { font-size: 14px; color: #e2e8f0; }
        .toggle { width: 48px; height: 28px; background: rgba(255,255,255,0.15); border-radius: 14px; position: relative; cursor: pointer; }
        .toggle.active { background: #3b82f6; }
        .toggle::after { content: ''; position: absolute; width: 22px; height: 22px; background: #fff; border-radius: 50%; top: 3px; left: 3px; transition: all 0.2s; }
        .toggle.active::after { left: 23px; }
        
        /* Buttons */
        .btn { width: 100%; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.08); color: #e2e8f0; border: 1px solid rgba(255,255,255,0.15); }
        .btn-danger { background: rgba(239,68,68,0.2); color: #f87171; }
        .btn-small { width: auto; padding: 10px 16px; font-size: 14px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn + .btn { margin-top: 10px; }
        
        /* Day badges */
        .day-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .day-badge.strong { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .day-badge.normal { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .day-badge.recovery { background: rgba(100,116,139,0.2); color: #94a3b8; }
        
        /* Chat */
        .chat-container { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; margin-top: 16px; overflow: hidden; }
        .chat-header { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.15)); padding: 14px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .chat-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .chat-info { flex: 1; }
        .chat-name { font-size: 15px; font-weight: 600; color: #fff; }
        .chat-status { font-size: 12px; color: #10b981; }
        .chat-messages { max-height: 400px; overflow-y: auto; padding: 16px; }
        .message { margin-bottom: 16px; display: flex; gap: 10px; }
        .message.user { flex-direction: row-reverse; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .message.ai .message-avatar { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .message.user .message-avatar { background: rgba(255,255,255,0.15); }
        .message-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; }
        .message.ai .message-bubble { background: rgba(255,255,255,0.08); border-bottom-left-radius: 4px; }
        .message.user .message-bubble { background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-bottom-right-radius: 4px; }
        .chat-input-container { display: flex; gap: 10px; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); }
        .chat-input { flex: 1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; padding: 12px 18px; color: #fff; font-size: 14px; outline: none; }
        .chat-input:focus { border-color: #3b82f6; }
        .chat-input::placeholder { color: #64748b; }
        .chat-send { width: 44px; height: 44px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 50%; color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .chat-send:disabled { opacity: 0.5; }
        .typing-indicator { display: flex; gap: 4px; padding: 8px 0; }
        .typing-dot { width: 8px; height: 8px; background: #64748b; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-4px); opacity: 1; } }
        .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.08); }
        .quick-btn { padding: 8px 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; color: #94a3b8; font-size: 12px; cursor: pointer; }
        .quick-btn:active { background: rgba(255,255,255,0.15); }
        
        /* Loading */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; gap: 16px; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; color: #94a3b8; }
        
        /* Life counter */
        .life-counter { background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(139,92,246,0.12)); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(99,102,241,0.2); }
        .life-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center; }
        .life-stat-number { font-size: 20px; font-weight: 700; color: #fff; }
        .life-stat-number.yellow { color: #fbbf24; }
        .life-stat-number.green { color: #10b981; }
        .life-stat-label { font-size: 11px; color: #64748b; margin-top: 2px; }
        
        /* Morning data */
        .morning-data { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .morning-data:last-child { border-bottom: none; }
        .morning-data-label { font-size: 14px; color: #94a3b8; }
        .morning-data-value { font-size: 14px; font-weight: 600; color: #fff; }
        .morning-data-value.good { color: #10b981; }
        .morning-data-value.warning { color: #fbbf24; }
        .morning-data-value.bad { color: #ef4444; }
        
        /* System status */
        .system-status { display: flex; align-items: center; gap: 14px; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .system-status.incomplete { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
        .system-status.complete { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1)); border: 1px solid rgba(16,185,129,0.3); }
        .system-icon { font-size: 32px; }
        .system-info { flex: 1; }
        .system-title { font-size: 16px; font-weight: 700; color: #e2e8f0; }
        .system-status.complete .system-title { color: #10b981; }
        .system-subtitle { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        .streak-badge { background: rgba(251,146,60,0.2); padding: 6px 10px; border-radius: 12px; font-size: 12px; color: #fb923c; font-weight: 600; }
        
        /* Habits */
        .habit-section { margin-bottom: 14px; border-radius: 16px; padding: 16px; background: rgba(255,255,255,0.03); }
        .habit-section.inactive { opacity: 0.4; }
        .habit-section.green { border: 1px solid rgba(16,185,129,0.4); }
        .habit-section.blue { border: 1px solid rgba(59,130,246,0.4); }
        .habit-section.purple { border: 1px solid rgba(139,92,246,0.4); }
        .habit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .habit-title { font-size: 15px; font-weight: 700; }
        .habit-title.green { color: #10b981; }
        .habit-title.blue { color: #3b82f6; }
        .habit-title.purple { color: #8b5cf6; }
        .habit-counter { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .habit-counter.green { background: rgba(16,185,129,0.25); color: #10b981; }
        .habit-counter.blue { background: rgba(59,130,246,0.25); color: #3b82f6; }
        .habit-counter.purple { background: rgba(139,92,246,0.25); color: #8b5cf6; }
        .habit-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 6px; cursor: pointer; background: rgba(255,255,255,0.02); }
        .habit-item:active { transform: scale(0.98); }
        .habit-item.checked.green { background: rgba(16,185,129,0.1); }
        .habit-item.checked.blue { background: rgba(59,130,246,0.1); }
        .habit-item.checked.purple { background: rgba(139,92,246,0.1); }
        .checkbox { width: 24px; height: 24px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        .habit-item.checked .checkbox { background: currentColor; border-color: currentColor; }
        .habit-item.checked.green .checkbox { color: #10b981; }
        .habit-item.checked.blue .checkbox { color: #3b82f6; }
        .habit-item.checked.purple .checkbox { color: #8b5cf6; }
        .checkbox-mark { color: #fff; font-size: 14px; display: none; }
        .habit-item.checked .checkbox-mark { display: block; }
        .habit-item-label { flex: 1; font-size: 14px; color: #e2e8f0; }
        .habit-item.checked .habit-item-label { text-decoration: line-through; opacity: 0.7; }
        
        /* Bottom nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,15,26,0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 12px 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #64748b; cursor: pointer; padding: 8px 16px; border-radius: 12px; }
        .nav-item.active { color: #3b82f6; background: rgba(59,130,246,0.1); }
        .nav-item-icon { font-size: 20px; }
        .nav-item-label { font-size: 11px; }
        
        /* Reminders */
        .reminders { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .reminders-title { font-size: 14px; font-weight: 600; color: #f87171; margin-bottom: 10px; }
        .reminder-item { display: flex; gap: 8px; font-size: 13px; color: #e2e8f0; padding: 4px 0; }
        
        /* Key status */
        .key-status { display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 12px; margin-bottom: 16px; }
        .key-status.valid { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); }
        .key-status.invalid { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); }
        .key-status-icon { font-size: 20px; }
        .key-status-text { font-size: 14px; }
        .key-status.valid .key-status-text { color: #10b981; }
        .key-status.invalid .key-status-text { color: #f87171; }
        
        /* ========== NUTRITION STYLES ========== */
        .nutrition-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .nutrition-card {
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            padding: 14px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .nutrition-card.calories {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.15));
            border-color: rgba(99,102,241,0.3);
        }
        
        .nutrition-value {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }
        
        .nutrition-card.calories .nutrition-value { font-size: 36px; }
        
        .nutrition-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
        
        .nutrition-progress {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .nutrition-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .nutrition-progress-bar.good { background: #10b981; }
        .nutrition-progress-bar.warning { background: #fbbf24; }
        .nutrition-progress-bar.over { background: #ef4444; }
        
        .nutrition-remaining {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        /* Photo upload */
        .photo-upload-area {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }
        
        .photo-upload-area:active {
            border-color: #3b82f6;
            background: rgba(59,130,246,0.1);
        }
        
        .photo-upload-icon { font-size: 48px; margin-bottom: 12px; }
        .photo-upload-text { font-size: 14px; color: #94a3b8; }
        .photo-upload-hint { font-size: 12px; color: #64748b; margin-top: 8px; }
        
        /* Photo buttons (camera/gallery) */
        .photo-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .photo-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 16px;
            background: rgba(59,130,246,0.1);
            border: 2px dashed rgba(59,130,246,0.3);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .photo-btn:active {
            background: rgba(59,130,246,0.2);
            border-color: #3b82f6;
            transform: scale(0.98);
        }
        
        .photo-btn-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }
        
        .photo-btn-text {
            font-size: 14px;
            font-weight: 600;
            color: #60a5fa;
        }
        
        .photo-hint {
            text-align: center;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 12px;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        /* Food log */
        .food-log-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        
        .food-log-icon { font-size: 28px; }
        
        .food-log-info { flex: 1; }
        
        .food-log-name {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .food-log-details {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }
        
        .food-log-calories {
            font-size: 16px;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .food-log-time {
            font-size: 11px;
            color: #64748b;
        }
        
        .food-log-delete {
            padding: 8px;
            background: rgba(239,68,68,0.1);
            border: none;
            border-radius: 8px;
            color: #f87171;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Nutrition table */
        .nutrition-table {
            width: 100%;
            font-size: 13px;
        }
        
        .nutrition-table-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .nutrition-table-row:last-child { border-bottom: none; }
        
        .nutrition-table-label { color: #94a3b8; }
        
        .nutrition-table-values {
            display: flex;
            gap: 16px;
        }
        
        .nutrition-table-plan { color: #64748b; }
        .nutrition-table-fact { color: #fff; font-weight: 600; }
        .nutrition-table-fact.good { color: #10b981; }
        .nutrition-table-fact.warning { color: #fbbf24; }
        .nutrition-table-fact.over { color: #ef4444; }
        
        /* Text input for food */
        .food-input-row {
            display: flex;
            gap: 10px;
        }
        
        .food-input {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 14px 16px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        
        .food-input:focus {
            border-color: #3b82f6;
        }
        
        .food-input::placeholder { color: #64748b; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }
        
        .tab.active {
            background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2));
            border-color: rgba(99,102,241,0.4);
            color: #fff;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state-text { font-size: 14px; }
        
        /* ========== EVENING STYLES ========== */
        .bp-comparison {
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 16px 0;
        }
        
        .bp-comparison-item { text-align: center; }
        .bp-comparison-label { font-size: 12px; color: #64748b; margin-bottom: 4px; }
        .bp-comparison-value { font-size: 20px; font-weight: 700; color: #fff; }
        .bp-comparison-arrow { font-size: 24px; color: #64748b; }
        
        .bp-comparison-change {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .bp-comparison-change.good { background: rgba(16,185,129,0.2); color: #10b981; }
        .bp-comparison-change.warning { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .bp-comparison-change.bad { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        .day-summary { padding: 8px 0; }
        
        .day-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .day-summary-row:last-child { border-bottom: none; }
        .day-summary-label { color: #94a3b8; font-size: 14px; }
        .day-summary-value { color: #fff; font-size: 14px; font-weight: 600; }
        .day-summary-value.good { color: #10b981; }
        .day-summary-value.warning { color: #fbbf24; }
        .day-summary-value.bad { color: #ef4444; }
        
        .day-rating {
            display: flex;
            justify-content: space-around;
            padding: 16px 0;
        }
        
        .rating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .rating-btn:active { transform: scale(0.9); }
        
        .rating-btn.selected {
            border-color: #3b82f6;
            background: rgba(59,130,246,0.2);
            transform: scale(1.1);
        }
        
        .day-rating-label {
            text-align: center;
            font-size: 13px;
            color: #64748b;
            margin-top: 8px;
        }
        
        .sleep-checklist { padding: 8px 0; }
        
        .sleep-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            background: rgba(255,255,255,0.02);
            font-size: 14px;
            color: #e2e8f0;
        }
        
        .sleep-item:active { transform: scale(0.98); }
        
        .sleep-item.checked {
            background: rgba(139,92,246,0.1);
        }
        
        .sleep-item.checked .checkbox {
            background: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        .sleep-item.checked span:last-child {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        /* Breathing sessions */
        .breathing-add { margin-bottom: 12px; }
        
        .breathing-log-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(139,92,246,0.08);
            border: 1px solid rgba(139,92,246,0.2);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .breathing-log-icon { font-size: 24px; }
        .breathing-log-info { flex: 1; }
        .breathing-log-type { font-size: 14px; font-weight: 600; color: #e2e8f0; }
        .breathing-log-details { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        .breathing-log-time { font-size: 11px; color: #64748b; }
        
        .breathing-log-delete {
            padding: 6px;
            background: rgba(239,68,68,0.1);
            border: none;
            border-radius: 6px;
            color: #f87171;
            cursor: pointer;
            font-size: 12px;
        }
        
        .bp-change-badge {
            text-align: center;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 12px;
        }
        
        .bp-change-badge.good { background: rgba(16,185,129,0.2); color: #10b981; }
        .bp-change-badge.warning { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .bp-change-badge.bad { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        /* ========== TRENDS STYLES ========== */
        .chart-container {
            position: relative;
            width: 100%;
            margin: 12px 0;
        }
        
        .chart-container canvas {
            width: 100% !important;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #94a3b8;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .chart-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        
        .chart-stat {
            text-align: center;
        }
        
        .chart-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }
        
        .chart-stat-value.good { color: #10b981; }
        .chart-stat-value.warning { color: #fbbf24; }
        .chart-stat-value.bad { color: #ef4444; }
        
        .chart-stat-label {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }
        
        .trends-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .trends-summary-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }
        
        .trends-summary-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .trends-summary-value {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            margin-top: 4px;
        }
        
        .no-data-message {
            text-align: center;
            padding: 30px;
            color: #64748b;
            font-size: 14px;
        }
        
        /* Oura data grid */
        .oura-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .oura-data-item {
            background: rgba(139,92,246,0.1);
            border: 1px solid rgba(139,92,246,0.2);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        
        .oura-data-value {
            font-size: 20px;
            font-weight: 700;
            color: #a78bfa;
        }
        
        .oura-data-value.good { color: #10b981; }
        .oura-data-value.warning { color: #fbbf24; }
        .oura-data-value.bad { color: #ef4444; }
        
        .oura-data-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .oura-import-success {
            background: rgba(16,185,129,0.1);
            border: 1px solid rgba(16,185,129,0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
            text-align: center;
            color: #10b981;
            font-size: 13px;
        }
        
        /* Date navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .date-nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            color: #e2e8f0;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .date-nav-btn:hover { background: rgba(255,255,255,0.2); }
        .date-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .date-nav-center {
            text-align: center;
        }
        
        .date-nav-label {
            font-size: 12px;
            color: #10b981;
            font-weight: 600;
            margin-top: 2px;
        }
        
        .date-nav-label.past {
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <button class="settings-btn" id="settingsBtn" onclick="showSettings()">‚öôÔ∏è</button>
    
    <div class="sync-status synced" id="syncStatus">
        <span id="syncIcon">‚òÅÔ∏è</span>
        <span id="syncText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</span>
    </div>

    <div class="container">
        <!-- Loading -->
        <div id="loadingScreen" class="loading">
            <div class="spinner"></div>
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- Setup Screen -->
        <div id="setupScreen" class="hidden">
            <div class="header">
                <div class="header-title">üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AI</div>
                <div class="header-subtitle">–í–≤–µ–¥–∏ API –∫–ª—é—á OpenRouter</div>
            </div>
            <div class="card">
                <div class="card-title">API –ö–ª—é—á</div>
                <div class="input-group">
                    <input type="password" class="input-field" id="apiKeyInput" placeholder="sk-or-v1-...">
                    <div class="input-hint">–ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveApiKey()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="skipApiKey()">–ë–µ–∑ AI</button>
        </div>
        
        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden">
            <div class="header">
                <div class="header-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            
            <!-- OpenRouter API -->
            <div class="card">
                <div class="card-title">ü§ñ OpenRouter API (AI)</div>
                <div class="key-status" id="keyStatus">
                    <span class="key-status-icon" id="keyStatusIcon">‚úÖ</span>
                    <span class="key-status-text" id="keyStatusText">–ö–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                </div>
                <div class="input-group">
                    <input type="password" class="input-field" id="apiKeyEdit" placeholder="sk-or-v1-...">
                </div>
                <button class="btn btn-secondary" onclick="updateApiKey()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-danger" onclick="deleteApiKey()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            
            <!-- Oura API -->
            <div class="card">
                <div class="card-title">üíç Oura Ring API</div>
                <div class="key-status" id="ouraKeyStatus">
                    <span class="key-status-icon" id="ouraKeyStatusIcon">‚ùå</span>
                    <span class="key-status-text" id="ouraKeyStatusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                </div>
                <div class="input-group">
                    <input type="password" class="input-field" id="ouraKeyEdit" placeholder="Oura Personal Access Token...">
                    <div class="input-hint">
                        <a href="https://cloud.ouraring.com/personal-access-tokens" target="_blank" style="color: #60a5fa;">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω ‚Üí</a>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="updateOuraKey()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å Oura</button>
                <button class="btn btn-danger" onclick="deleteOuraKey()">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
            
            <button class="btn btn-primary" onclick="closeSettings()" style="margin-top: 20px;">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        
        <!-- Morning Screen -->
        <div id="morningScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="morningDate"></div>
                <div class="header-title">üåÖ –£—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω</div>
            </div>
            
            <!-- Oura Import Button -->
            <div id="ouraImportSection" class="card hidden">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 32px;">üíç</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #e2e8f0;">Oura Ring</div>
                        <div style="font-size: 12px; color: #64748b;" id="ouraImportStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="importFromOura()" id="ouraImportBtn">
                        üì• –ò–º–ø–æ—Ä—Ç
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üíç Oura Readiness</div>
                <div class="input-row">
                    <input type="number" class="input-field center" id="ouraReadiness" placeholder="78" min="0" max="100">
                    <span class="input-unit">–∏–∑ 100</span>
                </div>
            </div>
            
            <!-- Sleep data from Oura -->
            <div class="card" id="sleepDataCard">
                <div class="card-title">üò¥ –°–æ–Ω (–∏–∑ Oura)</div>
                <div class="oura-data-grid">
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraSleepDuration">‚Äî</div>
                        <div class="oura-data-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraSleepEfficiency">‚Äî</div>
                        <div class="oura-data-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraHRV">‚Äî</div>
                        <div class="oura-data-label">HRV (–º—Å)</div>
                    </div>
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraRestingHR">‚Äî</div>
                        <div class="oura-data-label">–ü—É–ª—å—Å –ø–æ–∫–æ—è</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üíì –î–∞–≤–ª–µ–Ω–∏–µ –∏ –ø—É–ª—å—Å</div>
                <div class="input-group">
                    <div class="input-row">
                        <input type="number" class="input-field center" id="bpSystolic" placeholder="125" min="80" max="200">
                        <span class="input-separator">/</span>
                        <input type="number" class="input-field center" id="bpDiastolic" placeholder="82" min="50" max="130">
                    </div>
                </div>
                <div class="input-row">
                    <input type="number" class="input-field center" id="pulse" placeholder="65" min="40" max="150">
                    <span class="input-unit">—É–¥/–º–∏–Ω</span>
                </div>
            </div>
            
            <div class="card">
                <div class="toggle-row" onclick="toggleEliteHRV()">
                    <span class="toggle-label">üìä EliteHRV</span>
                    <div class="toggle" id="eliteToggle"></div>
                </div>
                <div id="eliteFields" class="hidden" style="margin-top: 12px;">
                    <div class="input-row">
                        <input type="number" class="input-field center" id="eliteScore" placeholder="7" min="1" max="10">
                        <span class="input-unit">–∏–∑ 10</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeMorning()">ü§ñ –ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑ AI</button>
            
            <div id="chatContainer" class="chat-container hidden">
                <div class="chat-header">
                    <div class="chat-avatar">ü§ñ</div>
                    <div class="chat-info">
                        <div class="chat-name">AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
                        <div class="chat-status" id="chatStatus">–æ–Ω–ª–∞–π–Ω</div>
                    </div>
                    <div id="dayBadge" class="day-badge normal">‚ö°</div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="askQuestion('–ß—Ç–æ –ø–æ–µ—Å—Ç—å –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫?')">üç≥ –ó–∞–≤—Ç—Ä–∞–∫</button>
                    <button class="quick-btn" onclick="askQuestion('–ú–æ–∂–Ω–æ –ª–∏ –∫–æ—Ñ–µ?')">‚òï –ö–æ—Ñ–µ</button>
                    <button class="quick-btn" onclick="askQuestion('–ö–∞–∫—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å..." onkeypress="handleChatKeypress(event)">
                    <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
                </div>
            </div>
            
            <button class="btn btn-primary hidden" id="startDayBtn" onclick="startDay()" style="margin-top: 16px;">–ù–∞—á–∞—Ç—å –¥–µ–Ω—å ‚Üí</button>
        </div>
        
        <!-- Main Screen -->
        <div id="mainScreen" class="hidden">
            <div class="header">
                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º -->
                <div class="date-nav">
                    <button class="date-nav-btn" onclick="changeDay(-1)" id="prevDayBtn">‚Üê</button>
                    <div class="date-nav-center">
                        <div class="header-date" id="mainDate"></div>
                        <div class="date-nav-label" id="dayLabel">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <button class="date-nav-btn" onclick="changeDay(1)" id="nextDayBtn">‚Üí</button>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span class="header-title">Life Tracker</span>
                    <div id="mainBadge" class="day-badge normal">‚ö°</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üåÖ –£—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</span>
                    <button class="btn btn-secondary btn-small" onclick="editMorning()" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div class="morning-data">
                    <span class="morning-data-label">Oura Readiness</span>
                    <span class="morning-data-value" id="sumOura">‚Äî</span>
                </div>
                <div class="morning-data">
                    <span class="morning-data-label">–î–∞–≤–ª–µ–Ω–∏–µ</span>
                    <span class="morning-data-value" id="sumBP">‚Äî</span>
                </div>
                <div class="morning-data">
                    <span class="morning-data-label">–ü—É–ª—å—Å</span>
                    <span class="morning-data-value" id="sumPulse">‚Äî</span>
                </div>
            </div>
            
            <div class="life-counter">
                <div class="life-stats">
                    <div>
                        <div class="life-stat-number" id="daysLived">17 804</div>
                        <div class="life-stat-label">–ø—Ä–æ–∂–∏—Ç–æ</div>
                    </div>
                    <div>
                        <div class="life-stat-number yellow" id="daysToPension">5 937</div>
                        <div class="life-stat-label">–¥–æ –ø–µ–Ω—Å–∏–∏</div>
                    </div>
                    <div>
                        <div class="life-stat-number green" id="daysToGoal">15 068</div>
                        <div class="life-stat-label">–¥–æ 90 –ª–µ—Ç</div>
                    </div>
                </div>
            </div>
            
            <div class="system-status" id="systemStatus">
                <div class="system-icon" id="systemIcon">üîÑ</div>
                <div class="system-info">
                    <div class="system-title" id="systemTitle">–í—ã–ø–æ–ª–Ω–∏ –º–∏–Ω–∏–º—É–º</div>
                    <div class="system-subtitle" id="systemSubtitle">–û—Å—Ç–∞–ª–æ—Å—å: 3 –∏–∑ 3</div>
                </div>
                <div class="streak-badge" id="streakBadge">üî• 0</div>
            </div>
            
            <div id="habitsContainer"></div>
            
            <div class="reminders">
                <div class="reminders-title">‚ö†Ô∏è –ü–æ–º–Ω–∏</div>
                <div class="reminder-item"><span>ü©∏</span><span>–ë–µ–∑ –¥–æ–±–∞–≤–æ–∫ —Å –∂–µ–ª–µ–∑–æ–º</span></div>
                <div class="reminder-item"><span>‚òï</span><span>–ö–æ—Ñ–µ–∏–Ω ‚â§150 –º–≥, –¥–æ 14:00</span></div>
                <div class="reminder-item"><span>üßÇ</span><span>–°–æ–ª—å ‚â§5 –≥</span></div>
            </div>
            
            <div class="chat-container" id="mainChatContainer">
                <div class="chat-header" onclick="toggleMainChat()">
                    <div class="chat-avatar">ü§ñ</div>
                    <div class="chat-info">
                        <div class="chat-name">–°–ø—Ä–æ—Å–∏—Ç—å AI</div>
                        <div class="chat-status">–∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å</div>
                    </div>
                    <span id="chatToggleIcon">‚ñº</span>
                </div>
                <div id="mainChatBody" class="hidden">
                    <div class="chat-messages" id="mainChatMessages"></div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="askMainQuestion('–ö–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å?')">üìä –ê–Ω–∞–ª–∏–∑</button>
                        <button class="quick-btn" onclick="askMainQuestion('–ß—Ç–æ –Ω–∞ —É–∂–∏–Ω?')">üçΩÔ∏è –£–∂–∏–Ω</button>
                        <button class="quick-btn" onclick="askMainQuestion('–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω?')">üò¥ –°–æ–Ω</button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="mainChatInput" placeholder="–í–æ–ø—Ä–æ—Å..." onkeypress="handleMainChatKeypress(event)">
                        <button class="chat-send" onclick="sendMainChatMessage()">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== NUTRITION SCREEN ========== -->
        <div id="nutritionScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="nutritionDate"></div>
                <div class="header-title">üçΩÔ∏è –ü–∏—Ç–∞–Ω–∏–µ</div>
            </div>
            
            <!-- Calories summary -->
            <div class="nutrition-summary">
                <div class="nutrition-card calories">
                    <div class="nutrition-value" id="caloriesValue">0</div>
                    <div class="nutrition-label">–∏–∑ 2100 –∫–∫–∞–ª</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="caloriesBar" style="width: 0%"></div>
                    </div>
                    <div class="nutrition-remaining" id="caloriesRemaining">–û—Å—Ç–∞–ª–æ—Å—å: 2100 –∫–∫–∞–ª</div>
                </div>
                
                <div class="nutrition-card">
                    <div class="nutrition-value" id="proteinValue">0</div>
                    <div class="nutrition-label">–ë–µ–ª–∫–∏ (200–≥)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="proteinBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="nutrition-card">
                    <div class="nutrition-value" id="fatValue">0</div>
                    <div class="nutrition-label">–ñ–∏—Ä—ã (65–≥)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="fatBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="nutrition-card">
                    <div class="nutrition-value" id="carbsValue">0</div>
                    <div class="nutrition-label">–£–≥–ª–µ–≤–æ–¥—ã (135–≥)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="carbsBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="nutrition-card">
                    <div class="nutrition-value" id="fiberValue">0</div>
                    <div class="nutrition-label">–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (30–≥)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="fiberBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Add food -->
            <div class="card">
                <div class="card-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ–¥—É</div>
                
                <!-- Photo upload - Camera -->
                <input type="file" id="foodCameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleFoodPhoto(event)">
                <!-- Photo upload - Gallery -->
                <input type="file" id="foodGalleryInput" accept="image/*" style="display: none;" onchange="handleFoodPhoto(event)">
                
                <div class="photo-buttons">
                    <div class="photo-btn" onclick="document.getElementById('foodCameraInput').click()">
                        <div class="photo-btn-icon">üì∏</div>
                        <div class="photo-btn-text">–ö–∞–º–µ—Ä–∞</div>
                    </div>
                    <div class="photo-btn" onclick="document.getElementById('foodGalleryInput').click()">
                        <div class="photo-btn-icon">üñºÔ∏è</div>
                        <div class="photo-btn-text">–ì–∞–ª–µ—Ä–µ—è</div>
                    </div>
                </div>
                <div class="photo-hint">AI –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Å–æ—Å—Ç–∞–≤ –∏ –∫–∞–ª–æ—Ä–∏–∏</div>
                
                <img id="foodPhotoPreview" class="photo-preview hidden" alt="Preview">
                
                <div style="text-align: center; color: #64748b; margin: 12px 0;">–∏–ª–∏</div>
                
                <!-- Text input -->
                <div class="food-input-row">
                    <input type="text" class="food-input" id="foodTextInput" placeholder="–û–ø–∏—à–∏ —á—Ç–æ —Å—ä–µ–ª..." onkeypress="handleFoodKeypress(event)">
                    <button class="btn btn-primary btn-small" onclick="analyzeFoodText()" id="addFoodBtn">‚û§</button>
                </div>
                <div class="input-hint">–ù–∞–ø—Ä–∏–º–µ—Ä: "200–≥ –∫—É—Ä–∏–Ω–æ–π –≥—Ä—É–¥–∫–∏, —Ä–∏—Å 150–≥, —Å–∞–ª–∞—Ç"</div>
            </div>
            
            <!-- AI analyzing -->
            <div id="foodAnalyzing" class="card hidden">
                <div class="loading" style="padding: 20px;">
                    <div class="spinner"></div>
                    <div class="loading-text">AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç...</div>
                </div>
            </div>
            
            <!-- Food log -->
            <div class="card">
                <div class="card-title">üìù –°–µ–≥–æ–¥–Ω—è —Å—ä–µ–¥–µ–Ω–æ</div>
                <div id="foodLogContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üçΩÔ∏è</div>
                        <div class="empty-state-text">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed table -->
            <div class="card">
                <div class="card-title">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</div>
                <div class="nutrition-table">
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label">–ö–∞–ª–æ—Ä–∏–∏</span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">2100</span>
                            <span class="nutrition-table-fact" id="tableCalories">0</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label">–ë–µ–ª–∫–∏</span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">200–≥</span>
                            <span class="nutrition-table-fact" id="tableProtein">0–≥</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label">–ñ–∏—Ä—ã</span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">65–≥</span>
                            <span class="nutrition-table-fact" id="tableFat">0–≥</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label">–£–≥–ª–µ–≤–æ–¥—ã</span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">135–≥</span>
                            <span class="nutrition-table-fact" id="tableCarbs">0–≥</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label">–ö–ª–µ—Ç—á–∞—Ç–∫–∞</span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">30–≥</span>
                            <span class="nutrition-table-fact" id="tableFiber">0–≥</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label">–°–æ–ª—å</span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">‚â§5–≥</span>
                            <span class="nutrition-table-fact" id="tableSalt">0–≥</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label">–ö–æ—Ñ–µ–∏–Ω</span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">‚â§150–º–≥</span>
                            <span class="nutrition-table-fact" id="tableCaffeine">0–º–≥</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Tips -->
            <div class="chat-container">
                <div class="chat-header" onclick="toggleNutritionChat()">
                    <div class="chat-avatar">ü§ñ</div>
                    <div class="chat-info">
                        <div class="chat-name">AI-—Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é</div>
                        <div class="chat-status">—á—Ç–æ –µ—â—ë —Å—ä–µ—Å—Ç—å?</div>
                    </div>
                    <span id="nutritionChatToggle">‚ñº</span>
                </div>
                <div id="nutritionChatBody" class="hidden">
                    <div class="chat-messages" id="nutritionChatMessages"></div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="askNutritionQuestion('–ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç?')">‚ùì –ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç</button>
                        <button class="quick-btn" onclick="askNutritionQuestion('–ò–¥–µ–∏ –Ω–∞ –ø–µ—Ä–µ–∫—É—Å')">üçé –ü–µ—Ä–µ–∫—É—Å</button>
                        <button class="quick-btn" onclick="askNutritionQuestion('–ß—Ç–æ –Ω–∞ —É–∂–∏–Ω?')">üçΩÔ∏è –£–∂–∏–Ω</button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="nutritionChatInput" placeholder="–í–æ–ø—Ä–æ—Å –ø—Ä–æ –ø–∏—Ç–∞–Ω–∏–µ..." onkeypress="handleNutritionChatKeypress(event)">
                        <button class="chat-send" onclick="sendNutritionChatMessage()">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== EVENING SCREEN ========== -->
        <div id="eveningScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="eveningDate"></div>
                <div class="header-title">üåô –í–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç</div>
            </div>
            
            <!-- Evening BP -->
            <div class="card">
                <div class="card-title">üíì –í–µ—á–µ—Ä–Ω–µ–µ –¥–∞–≤–ª–µ–Ω–∏–µ</div>
                <div class="input-group">
                    <div class="input-row">
                        <input type="number" class="input-field center" id="eveningBpSystolic" placeholder="120" min="80" max="200">
                        <span class="input-separator">/</span>
                        <input type="number" class="input-field center" id="eveningBpDiastolic" placeholder="80" min="50" max="130">
                    </div>
                </div>
                <div class="input-row">
                    <input type="number" class="input-field center" id="eveningPulse" placeholder="62" min="40" max="150">
                    <span class="input-unit">—É–¥/–º–∏–Ω</span>
                </div>
                <button class="btn btn-secondary" onclick="saveEveningBP()" style="margin-top: 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ê–î</button>
            </div>
            
            <!-- BP comparison -->
            <div class="card" id="bpComparisonCard">
                <div class="card-title">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ê–î</div>
                <div class="bp-comparison">
                    <div class="bp-comparison-item">
                        <div class="bp-comparison-label">üåÖ –£—Ç—Ä–æ</div>
                        <div class="bp-comparison-value" id="morningBpValue">‚Äî</div>
                    </div>
                    <div class="bp-comparison-arrow">‚Üí</div>
                    <div class="bp-comparison-item">
                        <div class="bp-comparison-label">üåô –í–µ—á–µ—Ä</div>
                        <div class="bp-comparison-value" id="eveningBpValue">‚Äî</div>
                    </div>
                </div>
                <div class="bp-change-badge" id="bpChangeValue"></div>
            </div>
            
            <!-- Breathing sessions -->
            <div class="card">
                <div class="card-title">üå¨Ô∏è –î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏</div>
                
                <!-- Add breathing session -->
                <div class="breathing-add">
                    <div class="input-group">
                        <label class="input-label">–¢–∏–ø –ø—Ä–∞–∫—Ç–∏–∫–∏</label>
                        <select class="input-field" id="breathingType">
                            <option value="resonance">–†–µ–∑–æ–Ω–∞–Ω—Å–Ω–æ–µ (6 –≤–¥/–º–∏–Ω)</option>
                            <option value="478">4-7-8 —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è</option>
                            <option value="box">–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ</option>
                            <option value="other">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="input-row" style="margin-bottom: 12px;">
                        <div class="input-group" style="flex: 1; margin-bottom: 0;">
                            <label class="input-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                            <div class="input-row">
                                <input type="number" class="input-field center" id="breathingDuration" placeholder="5" min="1" max="60">
                                <span class="input-unit">–º–∏–Ω</span>
                            </div>
                        </div>
                        <div class="input-group" style="flex: 1; margin-bottom: 0;">
                            <label class="input-label">RMSSD –ø–æ—Å–ª–µ</label>
                            <div class="input-row">
                                <input type="number" class="input-field center" id="breathingRmssd" placeholder="45">
                                <span class="input-unit">–º—Å</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="addBreathingSession()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
                </div>
                
                <!-- Breathing log -->
                <div id="breathingLogContainer" style="margin-top: 16px;"></div>
            </div>
            
            <!-- Day summary -->
            <div class="card">
                <div class="card-title">üìã –ò—Ç–æ–≥–∏ –¥–Ω—è</div>
                <div class="day-summary">
                    <div class="day-summary-row">
                        <span class="day-summary-label">–¢–∏–ø –¥–Ω—è</span>
                        <span class="day-summary-value" id="summaryDayType">‚Äî</span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label">–ü—Ä–∏–≤—ã—á–∫–∏</span>
                        <span class="day-summary-value" id="summaryHabits">‚Äî</span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label">–ö–∞–ª–æ—Ä–∏–∏</span>
                        <span class="day-summary-value" id="summaryCalories">‚Äî</span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label">–ë–µ–ª–æ–∫</span>
                        <span class="day-summary-value" id="summaryProtein">‚Äî</span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label">–î—ã—Ö–∞–Ω–∏–µ</span>
                        <span class="day-summary-value" id="summaryBreathing">‚Äî</span>
                    </div>
                </div>
            </div>
            
            <!-- Get AI analysis -->
            <button class="btn btn-primary" id="getEveningAnalysis" onclick="getEveningAnalysis()">
                ü§ñ –ü–æ–ª—É—á–∏—Ç—å AI-–∞–Ω–∞–ª–∏–∑ –¥–Ω—è
            </button>
            
            <!-- AI Analysis result -->
            <div id="eveningAnalysisResult" class="hidden">
                <div class="chat-container" style="margin-top: 16px;">
                    <div class="chat-header">
                        <div class="chat-avatar">ü§ñ</div>
                        <div class="chat-info">
                            <div class="chat-name">–ê–Ω–∞–ª–∏–∑ –¥–Ω—è</div>
                            <div class="chat-status" id="eveningChatStatus">–≥–æ—Ç–æ–≤–æ</div>
                        </div>
                    </div>
                    <div class="chat-messages" id="eveningChatMessages"></div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="askEveningQuestion('–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω?')">üò¥ –°–æ–Ω</button>
                        <button class="quick-btn" onclick="askEveningQuestion('–ß—Ç–æ –¥–µ–ª–∞—Ç—å –∑–∞–≤—Ç—Ä–∞?')">üìÖ –ó–∞–≤—Ç—Ä–∞</button>
                        <button class="quick-btn" onclick="askEveningQuestion('–û—Ü–µ–Ω–∏ –º–æ—ë –¥—ã—Ö–∞–Ω–∏–µ')">üå¨Ô∏è –î—ã—Ö–∞–Ω–∏–µ</button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="eveningChatInput" placeholder="–í–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–µ–Ω—å..." onkeypress="handleEveningChatKeypress(event)">
                        <button class="chat-send" onclick="sendEveningChatMessage()">‚û§</button>
                    </div>
                </div>
            </div>
            
            <!-- Day rating -->
            <div class="card" style="margin-top: 16px;">
                <div class="card-title">‚≠ê –û—Ü–µ–Ω–∫–∞ –¥–Ω—è</div>
                <div class="day-rating" id="dayRating">
                    <button class="rating-btn" data-rating="1" onclick="rateDay(1)">üò´</button>
                    <button class="rating-btn" data-rating="2" onclick="rateDay(2)">üòï</button>
                    <button class="rating-btn" data-rating="3" onclick="rateDay(3)">üòê</button>
                    <button class="rating-btn" data-rating="4" onclick="rateDay(4)">üôÇ</button>
                    <button class="rating-btn" data-rating="5" onclick="rateDay(5)">üòä</button>
                </div>
                <div class="day-rating-label" id="dayRatingLabel">–ö–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å?</div>
            </div>
            
            <!-- Sleep prep -->
            <div class="card">
                <div class="card-title">üò¥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ —Å–Ω—É</div>
                <div class="sleep-checklist" id="sleepChecklist">
                    <div class="sleep-item" data-id="no_screens" onclick="toggleSleepItem('no_screens')">
                        <div class="checkbox"><span class="checkbox-mark">‚úì</span></div>
                        <span>–û—Ç–ª–æ–∂–∏–ª —Ç–µ–ª–µ—Ñ–æ–Ω –∑–∞ 30 –º–∏–Ω</span>
                    </div>
                    <div class="sleep-item" data-id="no_caffeine" onclick="toggleSleepItem('no_caffeine')">
                        <div class="checkbox"><span class="checkbox-mark">‚úì</span></div>
                        <span>–ë–µ–∑ –∫–æ—Ñ–µ–∏–Ω–∞ –ø–æ—Å–ª–µ 14:00</span>
                    </div>
                    <div class="sleep-item" data-id="breathing_evening" onclick="toggleSleepItem('breathing_evening')">
                        <div class="checkbox"><span class="checkbox-mark">‚úì</span></div>
                        <span>–í–µ—á–µ—Ä–Ω–µ–µ –¥—ã—Ö–∞–Ω–∏–µ 4-7-8</span>
                    </div>
                    <div class="sleep-item" data-id="room_ready" onclick="toggleSleepItem('room_ready')">
                        <div class="checkbox"><span class="checkbox-mark">‚úì</span></div>
                        <span>–ö–æ–º–Ω–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ç—Ä–µ–Ω–∞, —Ç–µ–º–Ω–æ</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== TRENDS SCREEN ========== -->
        <div id="trendsScreen" class="hidden">
            <div class="header">
                <div class="header-title">üìà –¢—Ä–µ–Ω–¥—ã</div>
                <div class="header-subtitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏</div>
            </div>
            
            <!-- Period selector -->
            <div class="tabs" style="margin-bottom: 16px;">
                <button class="tab active" data-period="7" onclick="setPeriod(7)">7 –¥–Ω–µ–π</button>
                <button class="tab" data-period="14" onclick="setPeriod(14)">14 –¥–Ω–µ–π</button>
                <button class="tab" data-period="30" onclick="setPeriod(30)">30 –¥–Ω–µ–π</button>
            </div>
            
            <!-- BP Chart -->
            <div class="card">
                <div class="card-title">üíì –ê—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ</div>
                <div class="chart-container">
                    <canvas id="bpChart" height="180"></canvas>
                </div>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-color" style="background: #ef4444;"></span>–°–∏—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ</span>
                    <span class="legend-item"><span class="legend-color" style="background: #3b82f6;"></span>–î–∏–∞—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ</span>
                </div>
                <div class="chart-stats" id="bpStats"></div>
            </div>
            
            <!-- Oura Chart -->
            <div class="card">
                <div class="card-title">üíç Oura Readiness</div>
                <div class="chart-container">
                    <canvas id="ouraChart" height="150"></canvas>
                </div>
                <div class="chart-stats" id="ouraStats"></div>
            </div>
            
            <!-- Nutrition Chart -->
            <div class="card">
                <div class="card-title">üçΩÔ∏è –ü–∏—Ç–∞–Ω–∏–µ</div>
                <div class="chart-container">
                    <canvas id="nutritionChart" height="150"></canvas>
                </div>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-color" style="background: #8b5cf6;"></span>–ö–∞–ª–æ—Ä–∏–∏</span>
                    <span class="legend-item"><span class="legend-color" style="background: #10b981;"></span>–ë–µ–ª–æ–∫</span>
                </div>
                <div class="chart-stats" id="nutritionStats"></div>
            </div>
            
            <!-- Habits Chart -->
            <div class="card">
                <div class="card-title">‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏</div>
                <div class="chart-container">
                    <canvas id="habitsChart" height="120"></canvas>
                </div>
                <div class="chart-stats" id="habitsStats"></div>
            </div>
            
            <!-- Breathing Chart -->
            <div class="card">
                <div class="card-title">üå¨Ô∏è –î—ã—Ö–∞–Ω–∏–µ</div>
                <div class="chart-container">
                    <canvas id="breathingChart" height="120"></canvas>
                </div>
                <div class="chart-stats" id="breathingStats"></div>
            </div>
            
            <!-- Summary -->
            <div class="card">
                <div class="card-title">üìä –°–≤–æ–¥–∫–∞ –ø–µ—Ä–∏–æ–¥–∞</div>
                <div class="trends-summary">
                    <div class="trends-summary-item">
                        <div class="trends-summary-label">–î–Ω–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                        <div class="trends-summary-value" id="summaryDaysInSystem">0</div>
                    </div>
                    <div class="trends-summary-item">
                        <div class="trends-summary-label">–¢–µ–∫—É—â–∏–π streak</div>
                        <div class="trends-summary-value" id="summaryStreak">üî• 0</div>
                    </div>
                    <div class="trends-summary-item">
                        <div class="trends-summary-label">–°—Ä–µ–¥–Ω–µ–µ –ê–î</div>
                        <div class="trends-summary-value" id="summaryAvgBP">‚Äî</div>
                    </div>
                    <div class="trends-summary-item">
                        <div class="trends-summary-label">–°—Ä–µ–¥–Ω–∏–π Oura</div>
                        <div class="trends-summary-value" id="summaryAvgOura">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav hidden" id="bottomNav">
        <div class="nav-item active" data-screen="main" onclick="navigateTo('main')">
            <span class="nav-item-icon">üè†</span>
            <span class="nav-item-label">–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" data-screen="nutrition" onclick="navigateTo('nutrition')">
            <span class="nav-item-icon">üçΩÔ∏è</span>
            <span class="nav-item-label">–ü–∏—Ç–∞–Ω–∏–µ</span>
        </div>
        <div class="nav-item" data-screen="trends" onclick="navigateTo('trends')">
            <span class="nav-item-icon">üìà</span>
            <span class="nav-item-label">–¢—Ä–µ–Ω–¥—ã</span>
        </div>
        <div class="nav-item" data-screen="evening" onclick="navigateTo('evening')">
            <span class="nav-item-icon">üåô</span>
            <span class="nav-item-label">–í–µ—á–µ—Ä</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCq10f_AzUXLjsfWEQNRbTUGjBLy-u4hnI",
            authDomain: "life-tracker-54732.firebaseapp.com",
            databaseURL: "https://life-tracker-54732-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "life-tracker-54732",
            storageBucket: "life-tracker-54732.firebasestorage.app",
            messagingSenderId: "322679590707",
            appId: "1:322679590707:web:dee9c025719d986e987846"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const userRef = ref(database, 'users/sergey');
        
        // === CONFIG ===
        let API_KEY = localStorage.getItem('openrouter_api_key') || '';
        let OURA_KEY = localStorage.getItem('oura_api_key') || '';
        const AI_MODEL = 'anthropic/claude-3-haiku';
        const VISION_MODEL = 'openai/gpt-4o-mini'; // –î–ª—è —Ñ–æ—Ç–æ
        
        // –õ–∏—á–Ω—ã–π Cloudflare Worker –¥–ª—è Oura API (–æ–±—Ö–æ–¥–∏—Ç CORS)
        const OURA_PROXY = 'https://oura-proxy.skomisarov.workers.dev';
        
        const BIRTH_DATE = new Date(1977, 3, 29);
        const PENSION_AGE = 65;
        const LIFE_GOAL = 90;
        
        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–Ω—è)
        function getToday() { return new Date(); }
        function getDateKey(date = new Date()) { return date.toISOString().split('T')[0]; }
        
        let currentDate = new Date(); // –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–π –¥–µ–Ω—å
        let userData = { days: {}, stats: {} };
        let todayData = null;
        let showElite = false;
        let chatHistory = [];
        let mainChatHistory = [];
        let nutritionChatHistory = [];
        let currentPhotoBase64 = null;
        let ouraData = null; // –î–∞–Ω–Ω—ã–µ –∏–∑ Oura
        
        // Nutrition targets
        const TARGETS = {
            calories: 2100,
            protein: 200,
            fat: 65,
            carbs: 135,
            fiber: 30,
            salt: 5,
            caffeine: 150
        };
        
        // === AI SYSTEM PROMPTS ===
        const AI_SYSTEM = `–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∑–¥–æ—Ä–æ–≤—å—é.

–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï (–°–µ—Ä–≥–µ–π):
‚Ä¢ 48 –ª–µ—Ç, —Ü–µ–ª—å ‚Äî –ø—Ä–æ–∂–∏—Ç—å –¥–æ 90
‚Ä¢ –ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è I —Å—Ç., –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å–∏–Ω–¥—Ä–æ–º
‚Ä¢ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: –ê–º–ª–æ–¥–∏–ø–∏–Ω, –≠—Å–ø–∏—Ä–æ 5–º–≥
‚Ä¢ –§–µ—Ä—Ä–∏—Ç–∏–Ω ~350 ‚Äî –ù–ï–õ–¨–ó–Ø –∂–µ–ª–µ–∑–æ –≤ –¥–æ–±–∞–≤–∫–∞—Ö!
‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∫–æ—Ñ–µ–∏–Ω–∞
‚Ä¢ –ü–∏—Ç–∞–Ω–∏–µ: 2100 –∫–∫–∞–ª, –±–µ–ª–æ–∫ 200–≥, –∂–∏—Ä—ã 65–≥, —É–≥–ª–µ–≤–æ–¥—ã 135–≥

–ü–û–†–û–ì–ò:
‚Ä¢ –ê–î ‚â•130 ‚Äî –ø–æ–≤—ã—à–µ–Ω–æ
‚Ä¢ –ö–æ—Ñ–µ–∏–Ω: max 150 –º–≥, –¥–æ 14:00
‚Ä¢ –°–æ–ª—å: max 5–≥/–¥–µ–Ω—å

–¢–ò–ü–´ –î–ù–Ø:
üöÄ –°–∏–ª—å–Ω—ã–π: Oura ‚â•85 + –ê–î <125/80
‚ö° –ù–æ—Ä–º–∞–ª—å–Ω—ã–π: Oura 70-84 + –ê–î <130/85
üò¥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π: Oura <70 –∏–ª–∏ –ê–î ‚â•140/90

–û—Ç–≤–µ—á–∞–π —Ç–µ–ø–ª–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ.`;

        const NUTRITION_AI_SYSTEM = `–¢—ã ‚Äî AI-–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ –¥–ª—è –°–µ—Ä–≥–µ—è.

–¶–ï–õ–ò –ü–ò–¢–ê–ù–ò–Ø:
‚Ä¢ 2100 –∫–∫–∞–ª/–¥–µ–Ω—å
‚Ä¢ –ë–µ–ª–æ–∫: 200–≥ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)
‚Ä¢ –ñ–∏—Ä—ã: 65–≥ (–ù–ñ–ö ‚â§17–≥)
‚Ä¢ –£–≥–ª–µ–≤–æ–¥—ã: 135–≥
‚Ä¢ –ö–ª–µ—Ç—á–∞—Ç–∫–∞: ‚â•30–≥
‚Ä¢ –ö–∞–ª–∏–π: ‚â•4700–º–≥, –ú–∞–≥–Ω–∏–π: ‚â•400–º–≥
‚Ä¢ –û–º–µ–≥–∞-3: ‚â•1–≥

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
‚Ä¢ –§–µ—Ä—Ä–∏—Ç–∏–Ω –≤—ã—Å–æ–∫–∏–π ‚Äî –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –∫—Ä–∞—Å–Ω–æ–µ –º—è—Å–æ —á–∞—Å—Ç–æ
‚Ä¢ –ö–æ—Ñ–µ–∏–Ω ‚â§150–º–≥ –¥–æ 14:00
‚Ä¢ –°–æ–ª—å ‚â§5–≥
‚Ä¢ –õ–∞–∫—Ç–æ–∑–∞ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ.`;

        const FOOD_ANALYSIS_PROMPT = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–¥—É –∏ –≤–µ—Ä–Ω–∏ JSON:
{
  "name": "–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞",
  "emoji": "–ø–æ–¥—Ö–æ–¥—è—â–∏–π —ç–º–æ–¥–∑–∏",
  "calories": —á–∏—Å–ª–æ,
  "protein": –≥—Ä–∞–º–º—ã –±–µ–ª–∫–∞,
  "fat": –≥—Ä–∞–º–º—ã –∂–∏—Ä–æ–≤,
  "carbs": –≥—Ä–∞–º–º—ã —É–≥–ª–µ–≤–æ–¥–æ–≤,
  "fiber": –≥—Ä–∞–º–º—ã –∫–ª–µ—Ç—á–∞—Ç–∫–∏,
  "salt": –≥—Ä–∞–º–º—ã —Å–æ–ª–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ),
  "caffeine": –º–≥ –∫–æ—Ñ–µ–∏–Ω–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å),
  "comment": "–∫—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –°–µ—Ä–≥–µ—è"
}

–£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ –ø–æ—Ä—Ü–∏–∏ –æ–±—ã—á–Ω–æ 150-300–≥. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û JSON, –±–µ–∑ markdown.`;

        const habits = {
            minimum: { title: "üéØ –ú–ò–ù–ò–ú–£–ú", color: "green", items: [
                { id: 'steps_min', label: '4000 —à–∞–≥–æ–≤' },
                { id: 'protein_meal', label: '–ë–µ–ª–æ–∫ ‚â•40–≥ + –æ–≤–æ—â–∏' },
                { id: 'breathing', label: '5 –º–∏–Ω –¥—ã—Ö–∞–Ω–∏—è' }
            ]},
            normal: { title: "‚ö° –ù–û–†–ú–ê–õ–¨–ù–´–ô", color: "blue", items: [
                { id: 'steps_full', label: '7000‚Äì10000 —à–∞–≥–æ–≤' },
                { id: 'training', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞' },
                { id: 'nutrition_track', label: '–¢—Ä–µ–∫–∏–Ω–≥ –ø–∏—Ç–∞–Ω–∏—è' },
                { id: 'breathing_2x', label: '2 —Å–µ—Å—Å–∏–∏ –¥—ã—Ö–∞–Ω–∏—è' },
                { id: 'sleep_time', label: '–õ–µ—á—å –¥–æ 23:30' }
            ]},
            strong: { title: "üöÄ –°–ò–õ–¨–ù–´–ô", color: "purple", items: [
                { id: 'extra_training', label: '–£–¥–ª–∏–Ω—ë–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞' },
                { id: 'full_tracking', label: '–ü–æ–ª–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥' }
            ]}
        };

        // === UTILITY ===
        function formatDate(d) { return d.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' }); }
        function formatNum(n) { return n.toLocaleString('ru-RU'); }
        function formatTime(d) { return new Date(d).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }
        
        function calcDates() {
            const now = new Date(); now.setHours(0,0,0,0);
            const pension = new Date(BIRTH_DATE); pension.setFullYear(pension.getFullYear() + PENSION_AGE);
            const goal = new Date(BIRTH_DATE); goal.setFullYear(goal.getFullYear() + LIFE_GOAL);
            const ms = 24*60*60*1000;
            return {
                lived: Math.floor((now - BIRTH_DATE) / ms),
                toPension: Math.max(0, Math.floor((pension - now) / ms)),
                toGoal: Math.max(0, Math.floor((goal - now) / ms))
            };
        }
        
        function updateSync(s) {
            document.getElementById('syncStatus').className = 'sync-status ' + s;
            document.getElementById('syncIcon').textContent = s === 'synced' ? '‚òÅÔ∏è' : s === 'syncing' ? 'üîÑ' : 'üì¥';
            document.getElementById('syncText').textContent = s === 'synced' ? '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ' : s === 'syncing' ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–û—Ñ–ª–∞–π–Ω';
        }
        
        function hideAllScreens() {
            ['loadingScreen', 'setupScreen', 'settingsScreen', 'morningScreen', 'mainScreen', 'nutritionScreen', 'eveningScreen', 'trendsScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }
        
        function showScreen(name) {
            hideAllScreens();
            document.getElementById(name + 'Screen').classList.remove('hidden');
            document.getElementById('bottomNav').classList.toggle('hidden', !['main', 'nutrition', 'evening', 'trends'].includes(name));
            document.getElementById('settingsBtn').classList.toggle('hidden', ['setup', 'settings', 'loading'].includes(name));
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.screen === name);
            });
        }
        
        window.navigateTo = function(screen) {
            showScreen(screen);
            if (screen === 'main') updateMain();
            if (screen === 'nutrition') updateNutrition();
            if (screen === 'evening') updateEvening();
            if (screen === 'trends') updateTrends();
        };
        
        // === API KEY ===
        window.saveApiKey = function() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key || !key.startsWith('sk-or-')) { alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á'); return; }
            API_KEY = key;
            localStorage.setItem('openrouter_api_key', key);
            proceedAfterSetup();
        };
        
        window.skipApiKey = function() { API_KEY = ''; proceedAfterSetup(); };
        
        window.showSettings = function() { showScreen('settings'); updateKeyStatus(); };
        
        window.closeSettings = function() {
            todayData?.morning ? (showScreen('main'), updateMain()) : showScreen('morning');
        };
        
        window.updateApiKey = function() {
            const key = document.getElementById('apiKeyEdit').value.trim();
            if (!key || key.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢') || !key.startsWith('sk-or-')) { alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á'); return; }
            API_KEY = key;
            localStorage.setItem('openrouter_api_key', key);
            alert('–û–±–Ω–æ–≤–ª–µ–Ω–æ!');
            updateKeyStatus();
        };
        
        window.deleteApiKey = function() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á?')) {
                API_KEY = '';
                localStorage.removeItem('openrouter_api_key');
                updateKeyStatus();
            }
        };
        
        function updateKeyStatus() {
            const valid = !!API_KEY;
            document.getElementById('keyStatus').className = 'key-status ' + (valid ? 'valid' : 'invalid');
            document.getElementById('keyStatusIcon').textContent = valid ? '‚úÖ' : '‚ùå';
            document.getElementById('keyStatusText').textContent = valid ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            document.getElementById('apiKeyEdit').value = valid ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + API_KEY.slice(-8) : '';
            
            // Oura key status
            updateOuraKeyStatus();
        }
        
        function updateOuraKeyStatus() {
            const valid = !!OURA_KEY;
            document.getElementById('ouraKeyStatus').className = 'key-status ' + (valid ? 'valid' : 'invalid');
            document.getElementById('ouraKeyStatusIcon').textContent = valid ? '‚úÖ' : '‚ùå';
            document.getElementById('ouraKeyStatusText').textContent = valid ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
            document.getElementById('ouraKeyEdit').value = valid ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + OURA_KEY.slice(-8) : '';
        }
        
        window.updateOuraKey = async function() {
            const key = document.getElementById('ouraKeyEdit').value.trim();
            if (!key || key.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) { 
                alert('–í–≤–µ–¥–∏ Oura Personal Access Token'); 
                return; 
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
            document.getElementById('ouraKeyStatusText').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            try {
                const testResult = await testOuraConnection(key);
                if (testResult) {
                    OURA_KEY = key;
                    localStorage.setItem('oura_api_key', key);
                    alert('‚úÖ Oura –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!');
                    updateOuraKeyStatus();
                    checkOuraAvailable();
                } else {
                    alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.');
                    updateOuraKeyStatus();
                }
            } catch (e) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + e.message);
                updateOuraKeyStatus();
            }
        };
        
        window.deleteOuraKey = function() {
            if (confirm('–û—Ç–∫–ª—é—á–∏—Ç—å Oura?')) {
                OURA_KEY = '';
                localStorage.removeItem('oura_api_key');
                updateOuraKeyStatus();
                document.getElementById('ouraImportSection').classList.add('hidden');
            }
        };
        
        async function testOuraConnection(token) {
            try {
                const response = await fetch(`${OURA_PROXY}/personal_info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return response.ok;
            } catch (e) {
                console.error('Oura connection test failed:', e);
                return false;
            }
        }
        
        function checkOuraAvailable() {
            const section = document.getElementById('ouraImportSection');
            if (OURA_KEY) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }
        
        window.importFromOura = async function() {
            if (!OURA_KEY) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ Oura –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
                return;
            }
            
            const btn = document.getElementById('ouraImportBtn');
            const status = document.getElementById('ouraImportStatus');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            status.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –≤—á–µ—Ä–∞ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ—Ç)
                const now = getToday();
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                const startDate = yesterday.toISOString().split('T')[0];
                const endDate = getDateKey();
                
                // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                // daily_readiness - –¥–ª—è Readiness Score
                // sleep - –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–Ω–∞ (–Ω–µ daily_sleep!)
                const [readinessData, sleepData] = await Promise.all([
                    fetchOuraData('daily_readiness', startDate, endDate),
                    fetchOuraData('sleep', startDate, endDate)
                ]);
                
                console.log('Oura readiness:', readinessData);
                console.log('Oura sleep:', sleepData);
                
                // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
                const readiness = readinessData?.data?.slice(-1)[0];
                const sleep = sleepData?.data?.slice(-1)[0];
                
                if (!readiness && !sleep) {
                    status.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è';
                    btn.disabled = false;
                    btn.textContent = 'üì• –ò–º–ø–æ—Ä—Ç';
                    return;
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
                ouraData = { readiness, sleep };
                
                if (readiness?.score) {
                    document.getElementById('ouraReadiness').value = readiness.score;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–Ω–∞
                if (sleep) {
                    console.log('Sleep data fields:', Object.keys(sleep));
                    
                    // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞ (total_sleep_duration –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
                    const duration = sleep.total_sleep_duration;
                    if (duration) {
                        const hours = Math.floor(duration / 3600);
                        const mins = Math.floor((duration % 3600) / 60);
                        document.getElementById('ouraSleepDuration').textContent = `${hours}—á ${mins}–º`;
                        document.getElementById('ouraSleepDuration').className = 'oura-data-value ' + 
                            (hours >= 7 ? 'good' : hours >= 6 ? 'warning' : 'bad');
                    }
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–Ω–∞
                    const efficiency = sleep.efficiency;
                    if (efficiency) {
                        document.getElementById('ouraSleepEfficiency').textContent = `${efficiency}%`;
                        document.getElementById('ouraSleepEfficiency').className = 'oura-data-value ' + 
                            (efficiency >= 85 ? 'good' : efficiency >= 75 ? 'warning' : 'bad');
                    }
                    
                    // HRV (average_hrv)
                    const hrv = sleep.average_hrv;
                    if (hrv) {
                        document.getElementById('ouraHRV').textContent = Math.round(hrv);
                        document.getElementById('ouraHRV').className = 'oura-data-value ' + 
                            (hrv >= 50 ? 'good' : hrv >= 30 ? 'warning' : 'bad');
                    }
                    
                    // Resting HR (lowest_heart_rate)
                    const restingHR = sleep.lowest_heart_rate;
                    if (restingHR) {
                        document.getElementById('ouraRestingHR').textContent = restingHR;
                        document.getElementById('ouraRestingHR').className = 'oura-data-value ' + 
                            (restingHR <= 60 ? 'good' : restingHR <= 70 ? 'warning' : 'bad');
                    }
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ Oura –≤ todayData
                if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
                todayData.oura = {
                    readiness: readiness?.score,
                    sleep_duration: sleep?.total_sleep_duration,
                    sleep_efficiency: sleep?.efficiency,
                    hrv: sleep?.average_hrv,
                    resting_hr: sleep?.lowest_heart_rate,
                    imported_at: new Date().toISOString()
                };
                
                status.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!';
                btn.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'üì• –ò–º–ø–æ—Ä—Ç';
                    status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                }, 2000);
                
            } catch (e) {
                console.error('Oura import error:', e);
                status.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
                btn.disabled = false;
                btn.textContent = 'üì• –ò–º–ø–æ—Ä—Ç';
            }
        };
        
        async function fetchOuraData(endpoint, startDate, endDate) {
            const url = `${OURA_PROXY}/${endpoint}?start_date=${startDate}&end_date=${endDate}`;
            
            try {
                console.log(`Fetching Oura data: ${endpoint}`);
                const response = await fetch(url, {
                    headers: { 
                        'Authorization': `Bearer ${OURA_KEY}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                } else {
                    console.error(`Oura API error: ${response.status}`);
                    return null;
                }
            } catch (e) {
                console.error(`Oura fetch failed:`, e.message);
                return null;
            }
        }
        
        function proceedAfterSetup() {
            todayData?.morning ? (showScreen('main'), updateMain()) : showScreen('morning');
        }
        
        // === FIREBASE ===
        async function saveData() {
            updateSync('syncing');
            try {
                await set(userRef, userData);
                updateSync('synced');
                localStorage.setItem('ltBackup', JSON.stringify(userData));
            } catch(e) { 
                updateSync('offline'); 
                localStorage.setItem('ltBackup', JSON.stringify(userData)); 
            }
        }
        
        async function loadData() {
            console.log('loadData started');
            try {
                console.log('Fetching from Firebase...');
                const snap = await get(userRef);
                console.log('Firebase response:', snap.exists());
                if (snap.val()) userData = snap.val();
                updateSync('synced');
            } catch(e) {
                console.warn('Firebase error, using backup:', e.message);
                const b = localStorage.getItem('ltBackup');
                if (b) userData = JSON.parse(b);
                updateSync('offline');
            }
            if (!userData.days) userData.days = {};
            if (!userData.stats) userData.stats = {};
            todayData = userData.days[getDateKey()] || null;
            console.log('loadData finished');
        }
        
        // === AI ===
        async function callAI(messages, systemPrompt = AI_SYSTEM) {
            if (!API_KEY) return 'AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –î–æ–±–∞–≤—å –∫–ª—é—á ‚öôÔ∏è';
            
            const statusEl = document.getElementById('chatStatus');
            if (statusEl) statusEl.textContent = '–ø–µ—á–∞—Ç–∞–µ—Ç...';
            
            try {
                const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': location.origin,
                        'X-Title': 'Life Tracker AI'
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: [{ role: 'system', content: systemPrompt }, ...messages],
                        max_tokens: 600,
                        temperature: 0.7
                    })
                });
                const data = await res.json();
                if (statusEl) statusEl.textContent = '–æ–Ω–ª–∞–π–Ω';
                if (data.error) return '–û—à–∏–±–∫–∞: ' + (data.error.message || '–ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á');
                return data.choices[0].message.content;
            } catch(e) { 
                if (statusEl) statusEl.textContent = '–æ—Ñ–ª–∞–π–Ω';
                return '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; 
            }
        }
        
        async function callVisionAI(imageBase64, prompt) {
            if (!API_KEY) return null;
            
            try {
                const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': location.origin,
                        'X-Title': 'Life Tracker AI'
                    },
                    body: JSON.stringify({
                        model: VISION_MODEL,
                        messages: [{
                            role: 'user',
                            content: [
                                { type: 'text', text: prompt },
                                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${imageBase64}` } }
                            ]
                        }],
                        max_tokens: 500
                    })
                });
                const data = await res.json();
                if (data.error) return null;
                return data.choices[0].message.content;
            } catch(e) { 
                return null; 
            }
        }
        
        function addMessage(container, role, text) {
            const div = document.createElement('div');
            div.className = 'message ' + role;
            div.innerHTML = `
                <div class="message-avatar">${role === 'ai' ? 'ü§ñ' : 'üë§'}</div>
                <div class="message-bubble">${text.replace(/\n/g, '<br>')}</div>
            `;
            document.getElementById(container).appendChild(div);
            document.getElementById(container).scrollTop = 99999;
        }
        
        function addTypingIndicator(container) {
            const div = document.createElement('div');
            div.className = 'message ai';
            div.id = 'typingIndicator';
            div.innerHTML = `<div class="message-avatar">ü§ñ</div><div class="message-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
            document.getElementById(container).appendChild(div);
            document.getElementById(container).scrollTop = 99999;
        }
        
        function removeTypingIndicator() {
            document.getElementById('typingIndicator')?.remove();
        }
        
        // === MORNING ===
        window.toggleEliteHRV = function() {
            showElite = !showElite;
            document.getElementById('eliteToggle').classList.toggle('active', showElite);
            document.getElementById('eliteFields').classList.toggle('hidden', !showElite);
        };
        
        window.analyzeMorning = async function() {
            const oura = parseInt(document.getElementById('ouraReadiness').value);
            const sys = parseInt(document.getElementById('bpSystolic').value);
            const dia = parseInt(document.getElementById('bpDiastolic').value);
            const pulse = parseInt(document.getElementById('pulse').value);
            
            if (!oura || !sys || !dia || !pulse) { alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è'); return; }
            
            const elite = showElite ? parseInt(document.getElementById('eliteScore').value) || null : null;
            
            document.getElementById('analyzeBtn').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            addTypingIndicator('chatMessages');
            
            const dayOfWeek = getToday().toLocaleDateString('ru-RU', { weekday: 'long' });
            let aiRequest = `–°–µ–≥–æ–¥–Ω—è ${dayOfWeek}. –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏:\n‚Ä¢ Oura: ${oura}/100\n‚Ä¢ –ê–î: ${sys}/${dia}\n‚Ä¢ –ü—É–ª—å—Å: ${pulse}`;
            if (elite) aiRequest += `\n‚Ä¢ EliteHRV: ${elite}/10`;
            aiRequest += `\n\n–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –¥–Ω—è, –¥–∞–π –æ—Ü–µ–Ω–∫—É –∏ 3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.`;
            
            chatHistory = [{ role: 'user', content: aiRequest }];
            const response = await callAI(chatHistory);
            removeTypingIndicator();
            
            chatHistory.push({ role: 'assistant', content: response });
            addMessage('chatMessages', 'ai', response);
            
            let dayType = 'normal';
            if (response.includes('–°–∏–ª—å–Ω—ã–π') || response.includes('—Å–∏–ª—å–Ω—ã–π') || response.includes('üöÄ')) dayType = 'strong';
            else if (response.includes('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π') || response.includes('–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω') || response.includes('üò¥')) dayType = 'recovery';
            else if (oura >= 85 && sys < 125) dayType = 'strong';
            else if (oura < 70 || sys >= 140) dayType = 'recovery';
            
            document.getElementById('dayBadge').className = 'day-badge ' + dayType;
            document.getElementById('dayBadge').innerHTML = dayType === 'strong' ? 'üöÄ –°–∏–ª—å–Ω—ã–π' : dayType === 'normal' ? '‚ö° –ù–æ—Ä–º–∞–ª—å–Ω—ã–π' : 'üò¥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ';
            
            if (!userData.days[getDateKey()]) userData.days[getDateKey()] = { habits: {}, meals: [] };
            userData.days[getDateKey()].morning = { ts: new Date().toISOString(), oura, bp_sys: sys, bp_dia: dia, pulse, elite, day_type: dayType, ai: response };
            todayData = userData.days[getDateKey()];
            await saveData();
            
            document.getElementById('startDayBtn').classList.remove('hidden');
        };
        
        window.askQuestion = async function(q) {
            chatHistory.push({ role: 'user', content: q });
            addMessage('chatMessages', 'user', q);
            addTypingIndicator('chatMessages');
            const response = await callAI(chatHistory);
            removeTypingIndicator();
            chatHistory.push({ role: 'assistant', content: response });
            addMessage('chatMessages', 'ai', response);
        };
        
        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askQuestion(msg);
        };
        
        window.handleChatKeypress = function(e) { if (e.key === 'Enter') sendChatMessage(); };
        
        window.startDay = function() { 
            viewingDate = new Date(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
            showScreen('main'); 
            updateMain(); 
        };
        
        // –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–∞—è –¥–∞—Ç–∞ (–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Å–µ–≥–æ–¥–Ω—è)
        let viewingDate = new Date();
        
        window.changeDay = function(delta) {
            viewingDate.setDate(viewingDate.getDate() + delta);
            
            const today = getToday();
            const todayStr = getDateKey(today);
            const viewingStr = getDateKey(viewingDate);
            
            // –ù–µ –¥–∞—ë–º —É–π—Ç–∏ –≤ –±—É–¥—É—â–µ–µ
            if (viewingDate > today) {
                viewingDate = new Date(today);
            }
            
            updateMain();
        };
        
        window.editMorning = function() {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            if (todayData?.morning) {
                document.getElementById('ouraReadiness').value = todayData.morning.oura || '';
                document.getElementById('bpSystolic').value = todayData.morning.bp_sys || '';
                document.getElementById('bpDiastolic').value = todayData.morning.bp_dia || '';
                document.getElementById('pulse').value = todayData.morning.pulse || '';
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Oura
            checkOuraAvailable();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–Ω–∞–ª–∏–∑–∞ (—Å–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç –µ—Å–ª–∏ –±—ã–ª)
            document.getElementById('analyzeBtn').classList.remove('hidden');
            document.getElementById('chatContainer').classList.add('hidden');
            document.getElementById('startDayBtn').classList.add('hidden');
            
            showScreen('morning');
        };
        
        // === MAIN SCREEN ===
        function updateMain() {
            const today = getToday();
            const todayStr = getDateKey(today);
            const viewingStr = getDateKey(viewingDate);
            const isToday = todayStr === viewingStr;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –¥–Ω—è
            const dayData = userData.days[viewingStr] || null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –∏ –º–µ—Ç–∫—É
            document.getElementById('mainDate').textContent = formatDate(viewingDate);
            
            const dayLabel = document.getElementById('dayLabel');
            if (isToday) {
                dayLabel.textContent = '–°–µ–≥–æ–¥–Ω—è';
                dayLabel.className = 'date-nav-label';
            } else {
                const diff = Math.floor((today - viewingDate) / (1000 * 60 * 60 * 24));
                dayLabel.textContent = diff === 1 ? '–í—á–µ—Ä–∞' : `${diff} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
                dayLabel.className = 'date-nav-label past';
            }
            
            // –ö–Ω–æ–ø–∫–∞ "–≤–ø–µ—Ä—ë–¥" - –æ—Ç–∫–ª—é—á–µ–Ω–∞ –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è
            document.getElementById('nextDayBtn').disabled = isToday;
            
            const dt = dayData?.morning?.day_type || 'normal';
            document.getElementById('mainBadge').className = 'day-badge ' + dt;
            document.getElementById('mainBadge').innerHTML = dt === 'strong' ? 'üöÄ' : dt === 'normal' ? '‚ö°' : 'üò¥';
            
            if (dayData?.morning) {
                const m = dayData.morning;
                document.getElementById('sumOura').textContent = m.oura;
                document.getElementById('sumOura').className = 'morning-data-value ' + (m.oura >= 85 ? 'good' : m.oura >= 70 ? '' : 'warning');
                document.getElementById('sumBP').textContent = `${m.bp_sys}/${m.bp_dia}`;
                document.getElementById('sumBP').className = 'morning-data-value ' + (m.bp_sys < 130 ? 'good' : m.bp_sys < 140 ? 'warning' : 'bad');
                document.getElementById('sumPulse').textContent = `${m.pulse} —É–¥/–º–∏–Ω`;
            } else {
                document.getElementById('sumOura').textContent = '‚Äî';
                document.getElementById('sumBP').textContent = '‚Äî';
                document.getElementById('sumPulse').textContent = '‚Äî';
            }
            
            const d = calcDates();
            document.getElementById('daysLived').textContent = formatNum(d.lived);
            document.getElementById('daysToPension').textContent = formatNum(d.toPension);
            document.getElementById('daysToGoal').textContent = formatNum(d.toGoal);
            
            // –î–ª—è –ø—Ä–∏–≤—ã—á–µ–∫ –∏ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –¥–Ω—è
            const savedTodayData = todayData;
            todayData = dayData;
            
            updateStatus();
            renderHabits();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º todayData –µ—Å–ª–∏ —Å–º–æ—Ç—Ä–µ–ª–∏ –Ω–µ —Å–µ–≥–æ–¥–Ω—è
            if (!isToday) {
                todayData = savedTodayData;
            }
            
            if (mainChatHistory.length === 0 && dayData?.morning) {
                const m = dayData.morning;
                mainChatHistory = [{ role: 'system', content: `–ö–æ–Ω—Ç–µ–∫—Å—Ç: ${m.day_type} –¥–µ–Ω—å, Oura ${m.oura}, –ê–î ${m.bp_sys}/${m.bp_dia}` }];
            }
        }
        
        function updateStatus() {
            const min = ['steps_min', 'protein_meal', 'breathing'];
            const ch = todayData?.habits || {};
            const done = min.filter(id => ch[id]).length;
            const complete = done === min.length;
            
            document.getElementById('systemStatus').className = 'system-status ' + (complete ? 'complete' : 'incomplete');
            document.getElementById('systemIcon').textContent = complete ? '‚úÖ' : 'üîÑ';
            document.getElementById('systemTitle').textContent = complete ? '–¢—ã –≤ —Å–∏—Å—Ç–µ–º–µ!' : '–í—ã–ø–æ–ª–Ω–∏ –º–∏–Ω–∏–º—É–º';
            document.getElementById('systemSubtitle').textContent = complete ? '–î–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω!' : `–û—Å—Ç–∞–ª–æ—Å—å: ${min.length - done} –∏–∑ 3`;
            document.getElementById('streakBadge').textContent = 'üî• ' + (userData.stats.current_streak || 0);
        }
        
        function renderHabits() {
            const c = document.getElementById('habitsContainer');
            c.innerHTML = '';
            const dt = todayData?.morning?.day_type || 'normal';
            const ch = todayData?.habits || {};
            
            Object.entries(habits).forEach(([key, sec]) => {
                const active = key === 'minimum' || (key === 'normal' && dt !== 'recovery') || (key === 'strong' && dt === 'strong');
                const cnt = sec.items.filter(i => ch[i.id]).length;
                
                const div = document.createElement('div');
                div.className = `habit-section ${sec.color} ${active ? '' : 'inactive'}`;
                div.innerHTML = `
                    <div class="habit-header">
                        <span class="habit-title ${sec.color}">${sec.title}</span>
                        <span class="habit-counter ${sec.color}">${cnt}/${sec.items.length}</span>
                    </div>
                    ${sec.items.map(i => `
                        <div class="habit-item ${ch[i.id] ? 'checked' : ''} ${sec.color}" data-id="${i.id}">
                            <div class="checkbox"><span class="checkbox-mark">‚úì</span></div>
                            <span class="habit-item-label">${i.label}</span>
                        </div>
                    `).join('')}
                `;
                c.appendChild(div);
            });
            
            c.querySelectorAll('.habit-item').forEach(el => {
                el.addEventListener('click', () => toggleHabit(el.dataset.id));
            });
        }
        
        async function toggleHabit(id) {
            if (!todayData) todayData = { habits: {}, meals: [] };
            if (!todayData.habits) todayData.habits = {};
            todayData.habits[id] = !todayData.habits[id];
            userData.days[getDateKey()] = todayData;
            await saveData();
            updateStatus();
            renderHabits();
        }
        
        window.toggleMainChat = function() {
            document.getElementById('mainChatBody').classList.toggle('hidden');
            document.getElementById('chatToggleIcon').textContent = document.getElementById('mainChatBody').classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
        };
        
        window.askMainQuestion = async function(q) {
            document.getElementById('mainChatBody').classList.remove('hidden');
            document.getElementById('chatToggleIcon').textContent = '‚ñ≤';
            mainChatHistory.push({ role: 'user', content: q });
            addMessage('mainChatMessages', 'user', q);
            addTypingIndicator('mainChatMessages');
            const response = await callAI(mainChatHistory);
            removeTypingIndicator();
            mainChatHistory.push({ role: 'assistant', content: response });
            addMessage('mainChatMessages', 'ai', response);
        };
        
        window.sendMainChatMessage = async function() {
            const input = document.getElementById('mainChatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askMainQuestion(msg);
        };
        
        window.handleMainChatKeypress = function(e) { if (e.key === 'Enter') sendMainChatMessage(); };
        
        // === NUTRITION ===
        function getTotals() {
            const meals = todayData?.meals || [];
            return meals.reduce((acc, m) => ({
                calories: acc.calories + (m.calories || 0),
                protein: acc.protein + (m.protein || 0),
                fat: acc.fat + (m.fat || 0),
                carbs: acc.carbs + (m.carbs || 0),
                fiber: acc.fiber + (m.fiber || 0),
                salt: acc.salt + (m.salt || 0),
                caffeine: acc.caffeine + (m.caffeine || 0)
            }), { calories: 0, protein: 0, fat: 0, carbs: 0, fiber: 0, salt: 0, caffeine: 0 });
        }
        
        function updateNutrition() {
            document.getElementById('nutritionDate').textContent = formatDate(getToday());
            
            const totals = getTotals();
            
            // Update summary cards
            document.getElementById('caloriesValue').textContent = totals.calories;
            document.getElementById('proteinValue').textContent = totals.protein + '–≥';
            document.getElementById('fatValue').textContent = totals.fat + '–≥';
            document.getElementById('carbsValue').textContent = totals.carbs + '–≥';
            document.getElementById('fiberValue').textContent = totals.fiber + '–≥';
            
            // Progress bars
            updateProgressBar('calories', totals.calories, TARGETS.calories);
            updateProgressBar('protein', totals.protein, TARGETS.protein);
            updateProgressBar('fat', totals.fat, TARGETS.fat);
            updateProgressBar('carbs', totals.carbs, TARGETS.carbs);
            updateProgressBar('fiber', totals.fiber, TARGETS.fiber);
            
            // Remaining
            const remaining = TARGETS.calories - totals.calories;
            document.getElementById('caloriesRemaining').textContent = remaining > 0 ? `–û—Å—Ç–∞–ª–æ—Å—å: ${remaining} –∫–∫–∞–ª` : `–ü—Ä–µ–≤—ã—à–µ–Ω–æ –Ω–∞ ${-remaining} –∫–∫–∞–ª`;
            
            // Table
            document.getElementById('tableCalories').textContent = totals.calories;
            document.getElementById('tableProtein').textContent = totals.protein + '–≥';
            document.getElementById('tableFat').textContent = totals.fat + '–≥';
            document.getElementById('tableCarbs').textContent = totals.carbs + '–≥';
            document.getElementById('tableFiber').textContent = totals.fiber + '–≥';
            document.getElementById('tableSalt').textContent = totals.salt.toFixed(1) + '–≥';
            document.getElementById('tableCaffeine').textContent = totals.caffeine + '–º–≥';
            
            // Color coding for table
            setTableColor('tableCalories', totals.calories, TARGETS.calories);
            setTableColor('tableProtein', totals.protein, TARGETS.protein);
            setTableColor('tableFat', totals.fat, TARGETS.fat);
            setTableColor('tableCarbs', totals.carbs, TARGETS.carbs);
            setTableColor('tableFiber', totals.fiber, TARGETS.fiber, true);
            setTableColor('tableSalt', totals.salt, TARGETS.salt);
            setTableColor('tableCaffeine', totals.caffeine, TARGETS.caffeine);
            
            // Render food log
            renderFoodLog();
        }
        
        function updateProgressBar(id, value, target) {
            const percent = Math.min((value / target) * 100, 100);
            const bar = document.getElementById(id + 'Bar');
            bar.style.width = percent + '%';
            bar.className = 'nutrition-progress-bar ' + (value > target * 1.1 ? 'over' : value > target * 0.9 ? 'warning' : 'good');
        }
        
        function setTableColor(id, value, target, inverse = false) {
            const el = document.getElementById(id);
            el.className = 'nutrition-table-fact';
            if (inverse) {
                if (value >= target) el.classList.add('good');
                else if (value >= target * 0.7) el.classList.add('warning');
            } else {
                if (value > target * 1.1) el.classList.add('over');
                else if (value > target * 0.9) el.classList.add('warning');
                else el.classList.add('good');
            }
        }
        
        function renderFoodLog() {
            const container = document.getElementById('foodLogContainer');
            const meals = todayData?.meals || [];
            
            if (meals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><div class="empty-state-text">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</div></div>';
                return;
            }
            
            container.innerHTML = meals.map((m, i) => `
                <div class="food-log-item">
                    <div class="food-log-icon">${m.emoji || 'üç¥'}</div>
                    <div class="food-log-info">
                        <div class="food-log-name">${m.name}</div>
                        <div class="food-log-details">–ë${m.protein}–≥ –ñ${m.fat}–≥ –£${m.carbs}–≥</div>
                        <div class="food-log-time">${formatTime(m.time)}</div>
                    </div>
                    <div class="food-log-calories">${m.calories}</div>
                    <button class="food-log-delete" onclick="deleteMeal(${i})">‚úï</button>
                </div>
            `).join('');
        }
        
        window.deleteMeal = async function(index) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
            todayData.meals.splice(index, 1);
            userData.days[getDateKey()] = todayData;
            await saveData();
            updateNutrition();
        };
        
        // Photo handling
        window.handleFoodPhoto = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result.split(',')[1];
                currentPhotoBase64 = base64;
                
                document.getElementById('foodPhotoPreview').src = e.target.result;
                document.getElementById('foodPhotoPreview').classList.remove('hidden');
                document.getElementById('photoUploadArea').classList.add('hidden');
                
                // Analyze
                await analyzeFoodPhoto(base64);
            };
            reader.readAsDataURL(file);
        };
        
        async function analyzeFoodPhoto(base64) {
            document.getElementById('foodAnalyzing').classList.remove('hidden');
            
            const response = await callVisionAI(base64, FOOD_ANALYSIS_PROMPT);
            
            document.getElementById('foodAnalyzing').classList.add('hidden');
            document.getElementById('foodPhotoPreview').classList.add('hidden');
            document.getElementById('photoUploadArea').classList.remove('hidden');
            
            if (!response) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –æ–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º.');
                return;
            }
            
            try {
                // Clean response
                let json = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const food = JSON.parse(json);
                await addMeal(food);
            } catch(e) {
                console.error('Parse error:', e, response);
                alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π –æ–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º.');
            }
        }
        
        window.analyzeFoodText = async function() {
            const input = document.getElementById('foodTextInput');
            const text = input.value.trim();
            if (!text) return;
            
            document.getElementById('addFoodBtn').disabled = true;
            document.getElementById('foodAnalyzing').classList.remove('hidden');
            
            const response = await callAI([{ role: 'user', content: text }], FOOD_ANALYSIS_PROMPT);
            
            document.getElementById('addFoodBtn').disabled = false;
            document.getElementById('foodAnalyzing').classList.add('hidden');
            
            try {
                let json = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const food = JSON.parse(json);
                await addMeal(food);
                input.value = '';
            } catch(e) {
                console.error('Parse error:', e, response);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –ø–æ-–¥—Ä—É–≥–æ–º—É.');
            }
        };
        
        window.handleFoodKeypress = function(e) { if (e.key === 'Enter') analyzeFoodText(); };
        
        async function addMeal(food) {
            if (!todayData) todayData = { habits: {}, meals: [] };
            if (!todayData.meals) todayData.meals = [];
            
            todayData.meals.push({
                ...food,
                time: new Date().toISOString()
            });
            
            userData.days[getDateKey()] = todayData;
            await saveData();
            updateNutrition();
            
            // Show AI comment
            if (food.comment) {
                alert('ü§ñ ' + food.comment);
            }
        }
        
        // Nutrition chat
        window.toggleNutritionChat = function() {
            document.getElementById('nutritionChatBody').classList.toggle('hidden');
            document.getElementById('nutritionChatToggle').textContent = document.getElementById('nutritionChatBody').classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
        };
        
        window.askNutritionQuestion = async function(q) {
            document.getElementById('nutritionChatBody').classList.remove('hidden');
            document.getElementById('nutritionChatToggle').textContent = '‚ñ≤';
            
            const totals = getTotals();
            const context = `–°—ä–µ–¥–µ–Ω–æ: ${totals.calories} –∫–∫–∞–ª, –ë${totals.protein}–≥, –ñ${totals.fat}–≥, –£${totals.carbs}–≥, –∫–ª–µ—Ç—á–∞—Ç–∫–∞ ${totals.fiber}–≥. –û—Å—Ç–∞–ª–æ—Å—å: ${TARGETS.calories - totals.calories} –∫–∫–∞–ª, –±–µ–ª–∫–∞ –Ω—É–∂–Ω–æ –µ—â—ë ${TARGETS.protein - totals.protein}–≥.`;
            
            nutritionChatHistory.push({ role: 'user', content: context + '\n\n' + q });
            addMessage('nutritionChatMessages', 'user', q);
            addTypingIndicator('nutritionChatMessages');
            
            const response = await callAI(nutritionChatHistory, NUTRITION_AI_SYSTEM);
            removeTypingIndicator();
            
            nutritionChatHistory.push({ role: 'assistant', content: response });
            addMessage('nutritionChatMessages', 'ai', response);
        };
        
        window.sendNutritionChatMessage = async function() {
            const input = document.getElementById('nutritionChatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askNutritionQuestion(msg);
        };
        
        window.handleNutritionChatKeypress = function(e) { if (e.key === 'Enter') sendNutritionChatMessage(); };
        
        // === EVENING ===
        let eveningChatHistory = [];
        
        const EVENING_AI_SYSTEM = `–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –≤–µ—á–µ—Ä–Ω–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–Ω—è.

–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï (–°–µ—Ä–≥–µ–π):
‚Ä¢ 48 –ª–µ—Ç, –≥–∏–ø–µ—Ä—Ç–æ–Ω–∏—è I —Å—Ç., –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å–∏–Ω–¥—Ä–æ–º
‚Ä¢ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: –ê–º–ª–æ–¥–∏–ø–∏–Ω, –≠—Å–ø–∏—Ä–æ 5–º–≥
‚Ä¢ –¶–µ–ª–∏: 2100 –∫–∫–∞–ª, –±–µ–ª–æ–∫ 200–≥, –¥–æ–∂–∏—Ç—å –¥–æ 90
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ (6 –≤–¥/–º–∏–Ω) –∏ 4-7-8 –¥–ª—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏
‚Ä¢ RMSSD 40-60 –º—Å ‚Äî —Ö–æ—Ä–æ—à–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –¥–ª—è –µ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞

–§–û–†–ú–ê–¢ –í–ï–ß–ï–†–ù–ï–ì–û –ê–ù–ê–õ–ò–ó–ê:
1. –û—Ü–µ–Ω–∫–∞ –¥–Ω—è (—á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å/–Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å)
2. –ê–Ω–∞–ª–∏–∑ –ê–î (—É—Ç—Ä–æ vs –≤–µ—á–µ—Ä, –¥–∏–Ω–∞–º–∏–∫–∞)
3. –û—Ü–µ–Ω–∫–∞ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫ (–µ—Å–ª–∏ –±—ã–ª–∏)
4. –ê–Ω–∞–ª–∏–∑ –ø–∏—Ç–∞–Ω–∏—è (–∫–∞–ª–æ—Ä–∏–∏, –±–µ–ª–æ–∫, —á—Ç–æ —É–ø—É—â–µ–Ω–æ)
5. 2-3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
6. –°–æ–≤–µ—Ç –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ —Å–Ω–∞

–û—Ç–≤–µ—á–∞–π —Ç–µ–ø–ª–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, —Å —ç–º–æ–¥–∑–∏.`;

        function updateEvening() {
            document.getElementById('eveningDate').textContent = formatDate(getToday());
            
            // Morning BP
            if (todayData?.morning) {
                const m = todayData.morning;
                document.getElementById('morningBpValue').textContent = `${m.bp_sys}/${m.bp_dia}`;
            }
            
            // Evening BP
            if (todayData?.evening?.bp_sys) {
                const e = todayData.evening;
                document.getElementById('eveningBpValue').textContent = `${e.bp_sys}/${e.bp_dia}`;
                document.getElementById('eveningBpSystolic').value = e.bp_sys;
                document.getElementById('eveningBpDiastolic').value = e.bp_dia;
                document.getElementById('eveningPulse').value = e.pulse;
                updateBpComparison();
            }
            
            // Day summary
            if (todayData?.morning) {
                const dt = todayData.morning.day_type;
                const el = document.getElementById('summaryDayType');
                el.textContent = dt === 'strong' ? 'üöÄ –°–∏–ª—å–Ω—ã–π' : dt === 'normal' ? '‚ö° –ù–æ—Ä–º–∞–ª—å–Ω—ã–π' : 'üò¥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ';
            }
            
            // Habits
            const min = ['steps_min', 'protein_meal', 'breathing'];
            const ch = todayData?.habits || {};
            const done = min.filter(id => ch[id]).length;
            const habitsEl = document.getElementById('summaryHabits');
            habitsEl.textContent = `${done}/3 –º–∏–Ω–∏–º—É–º`;
            habitsEl.className = 'day-summary-value ' + (done === 3 ? 'good' : done >= 2 ? 'warning' : 'bad');
            
            // Nutrition
            const totals = getTotals();
            const calEl = document.getElementById('summaryCalories');
            calEl.textContent = `${totals.calories} / 2100`;
            calEl.className = 'day-summary-value ' + (totals.calories > 2300 ? 'bad' : totals.calories > 2100 ? 'warning' : 'good');
            
            const protEl = document.getElementById('summaryProtein');
            protEl.textContent = `${totals.protein}–≥ / 200–≥`;
            protEl.className = 'day-summary-value ' + (totals.protein >= 180 ? 'good' : totals.protein >= 150 ? 'warning' : 'bad');
            
            // Breathing summary
            const sessions = todayData?.breathing || [];
            const breathEl = document.getElementById('summaryBreathing');
            if (sessions.length > 0) {
                const totalMin = sessions.reduce((sum, s) => sum + (s.duration || 0), 0);
                breathEl.textContent = `${sessions.length} —Å–µ—Å—Å–∏–π, ${totalMin} –º–∏–Ω`;
                breathEl.className = 'day-summary-value good';
            } else {
                breathEl.textContent = '–ù–µ—Ç —Å–µ—Å—Å–∏–π';
                breathEl.className = 'day-summary-value warning';
            }
            
            // Render breathing log
            renderBreathingLog();
            
            // Rating
            if (todayData?.evening?.rating) {
                updateRatingUI(todayData.evening.rating);
            }
            
            // Sleep checklist
            updateSleepChecklist();
        }
        
        function updateBpComparison() {
            if (!todayData?.morning || !todayData?.evening?.bp_sys) return;
            
            const m = todayData.morning;
            const e = todayData.evening;
            const diff = e.bp_sys - m.bp_sys;
            
            const badge = document.getElementById('bpChangeValue');
            if (diff < -5) {
                badge.textContent = `‚Üì ${Math.abs(diff)} –º–º ‚Äî –æ—Ç–ª–∏—á–Ω–æ!`;
                badge.className = 'bp-change-badge good';
            } else if (diff <= 5) {
                badge.textContent = `‚âà —Å—Ç–∞–±–∏–ª—å–Ω–æ`;
                badge.className = 'bp-change-badge warning';
            } else {
                badge.textContent = `‚Üë ${diff} –º–º ‚Äî –ø–æ–≤—ã—à–µ–Ω–∏–µ`;
                badge.className = 'bp-change-badge bad';
            }
        }
        
        window.saveEveningBP = async function() {
            const sys = parseInt(document.getElementById('eveningBpSystolic').value);
            const dia = parseInt(document.getElementById('eveningBpDiastolic').value);
            const pulse = parseInt(document.getElementById('eveningPulse').value);
            
            if (!sys || !dia || !pulse) { alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è'); return; }
            
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.evening) todayData.evening = {};
            
            todayData.evening.bp_sys = sys;
            todayData.evening.bp_dia = dia;
            todayData.evening.pulse = pulse;
            todayData.evening.bp_time = new Date().toISOString();
            
            userData.days[getDateKey()] = todayData;
            await saveData();
            
            document.getElementById('eveningBpValue').textContent = `${sys}/${dia}`;
            updateBpComparison();
            
            alert('–ê–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        };
        
        // Breathing sessions
        const BREATHING_TYPES = {
            'resonance': { name: '–†–µ–∑–æ–Ω–∞–Ω—Å–Ω–æ–µ', emoji: 'üåä', desc: '6 –≤–¥/–º–∏–Ω' },
            '478': { name: '4-7-8', emoji: 'üò¥', desc: '—Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è' },
            'box': { name: '–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ', emoji: '‚¨ú', desc: '4-4-4-4' },
            'other': { name: '–î—Ä—É–≥–æ–µ', emoji: 'üå¨Ô∏è', desc: '' }
        };
        
        window.addBreathingSession = async function() {
            const type = document.getElementById('breathingType').value;
            const duration = parseInt(document.getElementById('breathingDuration').value);
            const rmssd = parseInt(document.getElementById('breathingRmssd').value) || null;
            
            if (!duration) { alert('–£–∫–∞–∂–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'); return; }
            
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.breathing) todayData.breathing = [];
            
            todayData.breathing.push({
                type,
                duration,
                rmssd,
                time: new Date().toISOString()
            });
            
            userData.days[getDateKey()] = todayData;
            await saveData();
            
            // Clear inputs
            document.getElementById('breathingDuration').value = '';
            document.getElementById('breathingRmssd').value = '';
            
            renderBreathingLog();
            updateEvening();
        };
        
        function renderBreathingLog() {
            const container = document.getElementById('breathingLogContainer');
            const sessions = todayData?.breathing || [];
            
            if (sessions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 12px;">–ù–µ—Ç —Å–µ—Å—Å–∏–π —Å–µ–≥–æ–¥–Ω—è</div>';
                return;
            }
            
            container.innerHTML = sessions.map((s, i) => {
                const t = BREATHING_TYPES[s.type] || BREATHING_TYPES.other;
                return `
                    <div class="breathing-log-item">
                        <div class="breathing-log-icon">${t.emoji}</div>
                        <div class="breathing-log-info">
                            <div class="breathing-log-type">${t.name}</div>
                            <div class="breathing-log-details">${s.duration} –º–∏–Ω${s.rmssd ? ` ‚Ä¢ RMSSD: ${s.rmssd}` : ''}</div>
                            <div class="breathing-log-time">${formatTime(s.time)}</div>
                        </div>
                        <button class="breathing-log-delete" onclick="deleteBreathingSession(${i})">‚úï</button>
                    </div>
                `;
            }).join('');
        }
        
        window.deleteBreathingSession = async function(index) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é?')) return;
            todayData.breathing.splice(index, 1);
            userData.days[getDateKey()] = todayData;
            await saveData();
            renderBreathingLog();
            updateEvening();
        };
        
        // Day rating
        window.rateDay = async function(rating) {
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.evening) todayData.evening = {};
            
            todayData.evening.rating = rating;
            userData.days[getDateKey()] = todayData;
            await saveData();
            
            updateRatingUI(rating);
        };
        
        function updateRatingUI(rating) {
            const labels = ['', '–¢—è–∂—ë–ª—ã–π –¥–µ–Ω—å üò´', '–ù–µ –æ—á–µ–Ω—å üòï', '–ù–æ—Ä–º–∞–ª—å–Ω–æ üòê', '–•–æ—Ä–æ—à–æ! üôÇ', '–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å! üòä'];
            document.getElementById('dayRatingLabel').textContent = labels[rating];
            
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.rating) === rating);
            });
        }
        
        // Sleep checklist
        function updateSleepChecklist() {
            const items = todayData?.evening?.sleep || {};
            document.querySelectorAll('.sleep-item').forEach(el => {
                el.classList.toggle('checked', !!items[el.dataset.id]);
            });
        }
        
        window.toggleSleepItem = async function(id) {
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.evening) todayData.evening = {};
            if (!todayData.evening.sleep) todayData.evening.sleep = {};
            
            todayData.evening.sleep[id] = !todayData.evening.sleep[id];
            userData.days[getDateKey()] = todayData;
            await saveData();
            
            updateSleepChecklist();
        };
        
        // Evening AI analysis
        window.getEveningAnalysis = async function() {
            document.getElementById('getEveningAnalysis').disabled = true;
            document.getElementById('eveningAnalysisResult').classList.remove('hidden');
            addTypingIndicator('eveningChatMessages');
            
            // Build context
            const m = todayData?.morning || {};
            const e = todayData?.evening || {};
            const totals = getTotals();
            const sessions = todayData?.breathing || [];
            const habits = todayData?.habits || {};
            const minDone = ['steps_min', 'protein_meal', 'breathing'].filter(id => habits[id]).length;
            
            let breathingInfo = '–ù–µ—Ç —Å–µ—Å—Å–∏–π';
            if (sessions.length > 0) {
                breathingInfo = sessions.map(s => {
                    const t = BREATHING_TYPES[s.type];
                    return `${t.name} ${s.duration}–º–∏–Ω${s.rmssd ? ` (RMSSD ${s.rmssd})` : ''}`;
                }).join(', ');
            }
            
            const request = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–π –¥–µ–Ω—å:

–£–¢–†–û:
‚Ä¢ Oura Readiness: ${m.oura || '?'}/100
‚Ä¢ –ê–î —É—Ç—Ä–æ–º: ${m.bp_sys || '?'}/${m.bp_dia || '?'}
‚Ä¢ –¢–∏–ø –¥–Ω—è: ${m.day_type || '?'}

–í–ï–ß–ï–†:
‚Ä¢ –ê–î –≤–µ—á–µ—Ä–æ–º: ${e.bp_sys || '–Ω–µ –∏–∑–º–µ—Ä–µ–Ω–æ'}/${e.bp_dia || ''}
${e.bp_sys && m.bp_sys ? `‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${e.bp_sys - m.bp_sys > 0 ? '+' : ''}${e.bp_sys - m.bp_sys} –º–º` : ''}

–ü–ò–¢–ê–ù–ò–ï:
‚Ä¢ –ö–∞–ª–æ—Ä–∏–∏: ${totals.calories}/2100
‚Ä¢ –ë–µ–ª–æ–∫: ${totals.protein}–≥/200–≥
‚Ä¢ –ö–ª–µ—Ç—á–∞—Ç–∫–∞: ${totals.fiber}–≥/30–≥

–î–´–•–ê–ù–ò–ï:
‚Ä¢ ${breathingInfo}

–ü–†–ò–í–´–ß–ö–ò:
‚Ä¢ –ú–∏–Ω–∏–º—É–º –≤—ã–ø–æ–ª–Ω–µ–Ω: ${minDone}/3

–î–∞–π –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–Ω—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞.`;
            
            eveningChatHistory = [{ role: 'user', content: request }];
            const response = await callAI(eveningChatHistory, EVENING_AI_SYSTEM);
            removeTypingIndicator();
            
            eveningChatHistory.push({ role: 'assistant', content: response });
            addMessage('eveningChatMessages', 'ai', response);
            
            document.getElementById('getEveningAnalysis').disabled = false;
        };
        
        window.askEveningQuestion = async function(q) {
            eveningChatHistory.push({ role: 'user', content: q });
            addMessage('eveningChatMessages', 'user', q);
            addTypingIndicator('eveningChatMessages');
            
            const response = await callAI(eveningChatHistory, EVENING_AI_SYSTEM);
            removeTypingIndicator();
            
            eveningChatHistory.push({ role: 'assistant', content: response });
            addMessage('eveningChatMessages', 'ai', response);
        };
        
        window.sendEveningChatMessage = async function() {
            const input = document.getElementById('eveningChatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askEveningQuestion(msg);
        };
        
        window.handleEveningChatKeypress = function(e) { if (e.key === 'Enter') sendEveningChatMessage(); };
        
        // === TRENDS ===
        let trendsPeriod = 7;
        
        window.setPeriod = function(days) {
            trendsPeriod = days;
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.dataset.period) === days);
            });
            updateTrends();
        };
        
        function getHistoricalData(days) {
            const data = [];
            const now = new Date();
            
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                const dayData = userData.days?.[key] || null;
                
                data.push({
                    date: key,
                    label: d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }),
                    shortLabel: d.getDate().toString(),
                    morning: dayData?.morning || null,
                    evening: dayData?.evening || null,
                    meals: dayData?.meals || [],
                    habits: dayData?.habits || {},
                    breathing: dayData?.breathing || []
                });
            }
            
            return data;
        }
        
        function drawLineChart(canvasId, datasets, options = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.clientWidth;
            const height = parseInt(canvas.getAttribute('height'));
            
            canvas.width = width;
            canvas.height = height;
            
            const padding = { top: 20, right: 15, bottom: 30, left: 40 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Clear
            ctx.clearRect(0, 0, width, height);
            
            // Find min/max
            let allValues = [];
            datasets.forEach(ds => {
                ds.data.forEach(v => { if (v !== null) allValues.push(v); });
            });
            
            if (allValues.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', width / 2, height / 2);
                return;
            }
            
            const minVal = options.minY ?? Math.min(...allValues) * 0.9;
            const maxVal = options.maxY ?? Math.max(...allValues) * 1.1;
            const range = maxVal - minVal || 1;
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                // Y labels
                const val = Math.round(maxVal - (range / 4) * i);
                ctx.fillStyle = '#64748b';
                ctx.font = '10px -apple-system, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(val.toString(), padding.left - 8, y + 3);
            }
            
            // X labels
            const points = datasets[0].data.length;
            const stepX = chartWidth / (points - 1 || 1);
            
            ctx.fillStyle = '#64748b';
            ctx.font = '10px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            
            for (let i = 0; i < points; i++) {
                if (points <= 7 || i % Math.ceil(points / 7) === 0 || i === points - 1) {
                    const x = padding.left + stepX * i;
                    ctx.fillText(datasets[0].labels?.[i] || '', x, height - 8);
                }
            }
            
            // Draw lines
            datasets.forEach(ds => {
                ctx.strokeStyle = ds.color;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                let started = false;
                
                ds.data.forEach((val, i) => {
                    if (val === null) return;
                    
                    const x = padding.left + stepX * i;
                    const y = padding.top + chartHeight - ((val - minVal) / range) * chartHeight;
                    
                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // Draw points
                ds.data.forEach((val, i) => {
                    if (val === null) return;
                    
                    const x = padding.left + stepX * i;
                    const y = padding.top + chartHeight - ((val - minVal) / range) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = ds.color;
                    ctx.fill();
                });
            });
            
            // Draw target line if specified
            if (options.targetLine) {
                const targetY = padding.top + chartHeight - ((options.targetLine.value - minVal) / range) * chartHeight;
                ctx.strokeStyle = options.targetLine.color || '#fbbf24';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding.left, targetY);
                ctx.lineTo(width - padding.right, targetY);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        function drawBarChart(canvasId, data, options = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.clientWidth;
            const height = parseInt(canvas.getAttribute('height'));
            
            canvas.width = width;
            canvas.height = height;
            
            const padding = { top: 15, right: 15, bottom: 30, left: 30 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            ctx.clearRect(0, 0, width, height);
            
            const values = data.values.filter(v => v !== null);
            if (values.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', width / 2, height / 2);
                return;
            }
            
            const maxVal = options.maxY ?? Math.max(...values, 1);
            const barCount = data.values.length;
            const barWidth = (chartWidth / barCount) * 0.7;
            const gap = (chartWidth / barCount) * 0.3;
            
            data.values.forEach((val, i) => {
                const x = padding.left + (chartWidth / barCount) * i + gap / 2;
                const barHeight = val !== null ? (val / maxVal) * chartHeight : 0;
                const y = padding.top + chartHeight - barHeight;
                
                // Bar
                const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                gradient.addColorStop(0, data.color || '#3b82f6');
                gradient.addColorStop(1, data.colorEnd || data.color || '#3b82f6');
                
                ctx.fillStyle = val !== null ? gradient : 'rgba(255,255,255,0.05)';
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight || 2, 4);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#64748b';
                ctx.font = '10px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(data.labels?.[i] || '', x + barWidth / 2, height - 8);
            });
        }
        
        function updateTrends() {
            const data = getHistoricalData(trendsPeriod);
            
            // BP Chart
            const bpSysData = data.map(d => d.morning?.bp_sys || null);
            const bpDiaData = data.map(d => d.morning?.bp_dia || null);
            const labels = data.map(d => d.shortLabel);
            
            drawLineChart('bpChart', [
                { data: bpSysData, color: '#ef4444', labels },
                { data: bpDiaData, color: '#3b82f6', labels }
            ], { minY: 60, maxY: 160, targetLine: { value: 130, color: '#fbbf24' } });
            
            // BP Stats
            const validBpSys = bpSysData.filter(v => v !== null);
            const avgSys = validBpSys.length ? Math.round(validBpSys.reduce((a, b) => a + b, 0) / validBpSys.length) : null;
            const validBpDia = bpDiaData.filter(v => v !== null);
            const avgDia = validBpDia.length ? Math.round(validBpDia.reduce((a, b) => a + b, 0) / validBpDia.length) : null;
            
            document.getElementById('bpStats').innerHTML = avgSys ? `
                <div class="chart-stat">
                    <div class="chart-stat-value ${avgSys < 130 ? 'good' : avgSys < 140 ? 'warning' : 'bad'}">${avgSys}/${avgDia}</div>
                    <div class="chart-stat-label">–°—Ä–µ–¥–Ω–µ–µ</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${Math.min(...validBpSys)}</div>
                    <div class="chart-stat-label">–ú–∏–Ω —Å–∏—Å.</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${Math.max(...validBpSys)}</div>
                    <div class="chart-stat-label">–ú–∞–∫—Å —Å–∏—Å.</div>
                </div>
            ` : '<div class="no-data-message">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            
            // Oura Chart
            const ouraData = data.map(d => d.morning?.oura || null);
            drawLineChart('ouraChart', [
                { data: ouraData, color: '#8b5cf6', labels }
            ], { minY: 40, maxY: 100, targetLine: { value: 70, color: '#fbbf24' } });
            
            const validOura = ouraData.filter(v => v !== null);
            const avgOura = validOura.length ? Math.round(validOura.reduce((a, b) => a + b, 0) / validOura.length) : null;
            
            document.getElementById('ouraStats').innerHTML = avgOura ? `
                <div class="chart-stat">
                    <div class="chart-stat-value ${avgOura >= 80 ? 'good' : avgOura >= 65 ? 'warning' : 'bad'}">${avgOura}</div>
                    <div class="chart-stat-label">–°—Ä–µ–¥–Ω–µ–µ</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${Math.max(...validOura)}</div>
                    <div class="chart-stat-label">–õ—É—á—à–∏–π</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${validOura.filter(v => v >= 70).length}/${validOura.length}</div>
                    <div class="chart-stat-label">–î–Ω–µ–π ‚â•70</div>
                </div>
            ` : '<div class="no-data-message">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            
            // Nutrition Chart
            const caloriesData = data.map(d => d.meals.length ? d.meals.reduce((sum, m) => sum + (m.calories || 0), 0) : null);
            const proteinData = data.map(d => d.meals.length ? d.meals.reduce((sum, m) => sum + (m.protein || 0), 0) : null);
            
            drawLineChart('nutritionChart', [
                { data: caloriesData.map(v => v ? v / 21 : null), color: '#8b5cf6', labels }, // Scale calories to fit with protein
                { data: proteinData, color: '#10b981', labels }
            ], { minY: 0, maxY: 220, targetLine: { value: 100, color: '#fbbf24' } });
            
            const validCal = caloriesData.filter(v => v !== null);
            const avgCal = validCal.length ? Math.round(validCal.reduce((a, b) => a + b, 0) / validCal.length) : null;
            const validProt = proteinData.filter(v => v !== null);
            const avgProt = validProt.length ? Math.round(validProt.reduce((a, b) => a + b, 0) / validProt.length) : null;
            
            document.getElementById('nutritionStats').innerHTML = avgCal ? `
                <div class="chart-stat">
                    <div class="chart-stat-value">${avgCal}</div>
                    <div class="chart-stat-label">–ö–∫–∞–ª/–¥–µ–Ω—å</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value ${avgProt >= 180 ? 'good' : avgProt >= 150 ? 'warning' : 'bad'}">${avgProt}–≥</div>
                    <div class="chart-stat-label">–ë–µ–ª–æ–∫/–¥–µ–Ω—å</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${validCal.length}</div>
                    <div class="chart-stat-label">–î–Ω–µ–π —Ç—Ä–µ–∫–∏–Ω–≥–∞</div>
                </div>
            ` : '<div class="no-data-message">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            
            // Habits Chart
            const habitsData = data.map(d => {
                const min = ['steps_min', 'protein_meal', 'breathing'];
                const done = min.filter(id => d.habits[id]).length;
                return done;
            });
            
            drawBarChart('habitsChart', {
                values: habitsData,
                labels,
                color: '#10b981',
                colorEnd: '#059669'
            }, { maxY: 3 });
            
            const daysComplete = habitsData.filter(v => v === 3).length;
            document.getElementById('habitsStats').innerHTML = `
                <div class="chart-stat">
                    <div class="chart-stat-value ${daysComplete >= trendsPeriod * 0.8 ? 'good' : daysComplete >= trendsPeriod * 0.5 ? 'warning' : 'bad'}">${daysComplete}/${trendsPeriod}</div>
                    <div class="chart-stat-label">–î–Ω–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${Math.round(daysComplete / trendsPeriod * 100)}%</div>
                    <div class="chart-stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
                </div>
            `;
            
            // Breathing Chart
            const breathingData = data.map(d => d.breathing.length ? d.breathing.reduce((sum, s) => sum + (s.duration || 0), 0) : null);
            
            drawBarChart('breathingChart', {
                values: breathingData.map(v => v || 0),
                labels,
                color: '#8b5cf6',
                colorEnd: '#7c3aed'
            }, { maxY: 30 });
            
            const validBreathing = breathingData.filter(v => v !== null && v > 0);
            const avgBreathing = validBreathing.length ? Math.round(validBreathing.reduce((a, b) => a + b, 0) / validBreathing.length) : 0;
            
            document.getElementById('breathingStats').innerHTML = `
                <div class="chart-stat">
                    <div class="chart-stat-value">${avgBreathing}</div>
                    <div class="chart-stat-label">–ú–∏–Ω/–¥–µ–Ω—å</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${validBreathing.length}</div>
                    <div class="chart-stat-label">–î–Ω–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏</div>
                </div>
            `;
            
            // Summary
            document.getElementById('summaryDaysInSystem').textContent = daysComplete;
            document.getElementById('summaryStreak').textContent = 'üî• ' + (userData.stats?.current_streak || 0);
            document.getElementById('summaryAvgBP').textContent = avgSys ? `${avgSys}/${avgDia}` : '‚Äî';
            document.getElementById('summaryAvgOura').textContent = avgOura || '‚Äî';
        }
        
        // === INIT ===
        let lastDateKey = '';
        
        async function init() {
            console.log('Init started');
            try {
                await loadData();
                console.log('Data loaded');
                lastDateKey = getDateKey();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
                todayData = userData.days[getDateKey()] || null;
                console.log('Today data:', todayData ? 'exists' : 'null');
                
                document.getElementById('morningDate').textContent = formatDate(getToday());
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Oura
                checkOuraAvailable();
                
                if (!API_KEY) { 
                    console.log('No API key, showing setup');
                    showScreen('setup'); 
                    return; 
                }
                if (todayData?.morning) { 
                    console.log('Morning data exists, showing main');
                    showScreen('main'); 
                    updateMain(); 
                } else { 
                    console.log('No morning data, showing morning');
                    showScreen('morning'); 
                }
            } catch(e) {
                console.error('Init error:', e);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
            }
        }
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ —Å–º–µ–Ω–µ –¥–Ω—è
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                const newDateKey = getDateKey();
                if (newDateKey !== lastDateKey) {
                    // –ù–æ–≤—ã–π –¥–µ–Ω—å!
                    console.log('–ù–æ–≤—ã–π –¥–µ–Ω—å:', newDateKey);
                    lastDateKey = newDateKey;
                    todayData = userData.days[newDateKey] || null;
                    
                    document.getElementById('morningDate').textContent = formatDate(getToday());
                    
                    if (todayData?.morning) { 
                        showScreen('main'); 
                        updateMain(); 
                    } else { 
                        showScreen('morning'); 
                    }
                }
            }
        });
        
        setTimeout(init, 500);
    </script>
</body>
</html>
