<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0f1a">
    <title>Life Tracker AI</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #0a0f1a 0%, #111827 50%, #0a0f1a 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .container { max-width: 500px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .hidden { display: none !important; }
        
        /* Sync */
        .sync-status {
            position: fixed; top: 10px; right: 10px;
            padding: 6px 12px; border-radius: 20px; font-size: 11px; z-index: 1000;
            display: flex; align-items: center; gap: 6px;
        }
        .sync-status.synced { background: rgba(16,185,129,0.2); color: #10b981; }
        .sync-status.syncing { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .sync-status.offline { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        /* Settings button */
        .settings-btn {
            position: fixed; top: 10px; left: 10px;
            padding: 6px 12px; border-radius: 20px; font-size: 11px; z-index: 1000;
            background: rgba(255,255,255,0.1); color: #94a3b8;
            border: none; cursor: pointer;
        }
        
        /* Cards */
        .card {
            background: rgba(255,255,255,0.04);
            border-radius: 16px; padding: 16px; margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card-title { font-size: 14px; font-weight: 600; color: #94a3b8; margin-bottom: 12px; }
        
        /* Header */
        .header { text-align: center; padding: 20px 0 24px; }
        .header-date { font-size: 14px; color: #64748b; margin-bottom: 4px; }
        .header-title { font-size: 24px; font-weight: 700; color: #fff; }
        .header-subtitle { font-size: 14px; color: #64748b; margin-top: 8px; }
        
        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .input-label { font-size: 13px; color: #94a3b8; margin-bottom: 6px; display: block; }
        .input-row { display: flex; gap: 8px; align-items: center; }
        .input-field {
            flex: 1; background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px; padding: 14px 16px;
            color: #fff; font-size: 16px; outline: none;
        }
        .input-field.center { text-align: center; font-size: 18px; font-weight: 600; }
        .input-field:focus { border-color: #3b82f6; background: rgba(59,130,246,0.1); }
        .input-field::placeholder { color: #64748b; font-weight: 400; }
        .input-unit { font-size: 14px; color: #64748b; min-width: 50px; }
        .input-separator { font-size: 24px; color: #64748b; }
        .input-hint { font-size: 12px; color: #64748b; margin-top: 8px; }
        
        /* Toggle */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .toggle-label { font-size: 14px; color: #e2e8f0; }
        .toggle { width: 48px; height: 28px; background: rgba(255,255,255,0.15); border-radius: 14px; position: relative; cursor: pointer; }
        .toggle.active { background: #3b82f6; }
        .toggle::after { content: ''; position: absolute; width: 22px; height: 22px; background: #fff; border-radius: 50%; top: 3px; left: 3px; transition: all 0.2s; }
        .toggle.active::after { left: 23px; }
        
        /* Buttons */
        .btn { width: 100%; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.08); color: #e2e8f0; border: 1px solid rgba(255,255,255,0.15); }
        .btn-danger { background: rgba(239,68,68,0.2); color: #f87171; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn + .btn { margin-top: 10px; }
        
        /* Day type badges */
        .day-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .day-badge.strong { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .day-badge.normal { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .day-badge.recovery { background: rgba(100,116,139,0.2); color: #94a3b8; }
        
        /* AI Box */
        .ai-box { background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); border-radius: 16px; padding: 16px; margin-top: 16px; }
        .ai-box-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .ai-box-title { font-size: 14px; font-weight: 600; color: #a78bfa; }
        .ai-box-content { font-size: 14px; color: #e2e8f0; line-height: 1.6; white-space: pre-line; }
        
        /* Loading */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; gap: 16px; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; color: #94a3b8; }
        
        /* Life counter */
        .life-counter { background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(139,92,246,0.12)); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(99,102,241,0.2); }
        .life-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center; }
        .life-stat-number { font-size: 20px; font-weight: 700; color: #fff; }
        .life-stat-number.yellow { color: #fbbf24; }
        .life-stat-number.green { color: #10b981; }
        .life-stat-label { font-size: 11px; color: #64748b; margin-top: 2px; }
        
        /* Morning data */
        .morning-data { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .morning-data:last-child { border-bottom: none; }
        .morning-data-label { font-size: 14px; color: #94a3b8; }
        .morning-data-value { font-size: 14px; font-weight: 600; color: #fff; }
        .morning-data-value.good { color: #10b981; }
        .morning-data-value.warning { color: #fbbf24; }
        .morning-data-value.bad { color: #ef4444; }
        
        /* System status */
        .system-status { display: flex; align-items: center; gap: 14px; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .system-status.incomplete { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
        .system-status.complete { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1)); border: 1px solid rgba(16,185,129,0.3); }
        .system-icon { font-size: 32px; }
        .system-info { flex: 1; }
        .system-title { font-size: 16px; font-weight: 700; color: #e2e8f0; }
        .system-status.complete .system-title { color: #10b981; }
        .system-subtitle { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        .streak-badge { background: rgba(251,146,60,0.2); padding: 6px 10px; border-radius: 12px; font-size: 12px; color: #fb923c; font-weight: 600; }
        
        /* Habits */
        .habit-section { margin-bottom: 14px; border-radius: 16px; padding: 16px; background: rgba(255,255,255,0.03); }
        .habit-section.inactive { opacity: 0.4; }
        .habit-section.green { border: 1px solid rgba(16,185,129,0.4); }
        .habit-section.blue { border: 1px solid rgba(59,130,246,0.4); }
        .habit-section.purple { border: 1px solid rgba(139,92,246,0.4); }
        .habit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .habit-title { font-size: 15px; font-weight: 700; }
        .habit-title.green { color: #10b981; }
        .habit-title.blue { color: #3b82f6; }
        .habit-title.purple { color: #8b5cf6; }
        .habit-counter { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .habit-counter.green { background: rgba(16,185,129,0.25); color: #10b981; }
        .habit-counter.blue { background: rgba(59,130,246,0.25); color: #3b82f6; }
        .habit-counter.purple { background: rgba(139,92,246,0.25); color: #8b5cf6; }
        .habit-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 6px; cursor: pointer; background: rgba(255,255,255,0.02); }
        .habit-item:active { transform: scale(0.98); }
        .habit-item.checked.green { background: rgba(16,185,129,0.1); }
        .habit-item.checked.blue { background: rgba(59,130,246,0.1); }
        .habit-item.checked.purple { background: rgba(139,92,246,0.1); }
        .checkbox { width: 24px; height: 24px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        .habit-item.checked .checkbox { background: currentColor; border-color: currentColor; }
        .habit-item.checked.green .checkbox { color: #10b981; }
        .habit-item.checked.blue .checkbox { color: #3b82f6; }
        .habit-item.checked.purple .checkbox { color: #8b5cf6; }
        .checkbox-mark { color: #fff; font-size: 14px; display: none; }
        .habit-item.checked .checkbox-mark { display: block; }
        .habit-item-label { flex: 1; font-size: 14px; color: #e2e8f0; }
        .habit-item.checked .habit-item-label { text-decoration: line-through; opacity: 0.7; }
        
        /* Bottom nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,15,26,0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 12px 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #64748b; cursor: pointer; padding: 8px 16px; border-radius: 12px; }
        .nav-item.active { color: #3b82f6; background: rgba(59,130,246,0.1); }
        .nav-item-icon { font-size: 20px; }
        .nav-item-label { font-size: 11px; }
        
        /* Reminders */
        .reminders { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .reminders-title { font-size: 14px; font-weight: 600; color: #f87171; margin-bottom: 10px; }
        .reminder-item { display: flex; gap: 8px; font-size: 13px; color: #e2e8f0; padding: 4px 0; }
        
        /* Status indicator */
        .key-status { display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 12px; margin-bottom: 16px; }
        .key-status.valid { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); }
        .key-status.invalid { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); }
        .key-status-icon { font-size: 20px; }
        .key-status-text { font-size: 14px; }
        .key-status.valid .key-status-text { color: #10b981; }
        .key-status.invalid .key-status-text { color: #f87171; }
    </style>
</head>
<body>
    <button class="settings-btn" id="settingsBtn" onclick="showSettings()">‚öôÔ∏è API</button>
    
    <div class="sync-status synced" id="syncStatus">
        <span id="syncIcon">‚òÅÔ∏è</span>
        <span id="syncText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</span>
    </div>

    <div class="container">
        <!-- Loading -->
        <div id="loadingScreen" class="loading">
            <div class="spinner"></div>
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- Setup Screen (API Key) -->
        <div id="setupScreen" class="hidden">
            <div class="header">
                <div class="header-title">üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AI</div>
                <div class="header-subtitle">–í–≤–µ–¥–∏ API –∫–ª—é—á OpenRouter –¥–ª—è —Ä–∞–±–æ—Ç—ã AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>
            </div>
            
            <div class="card">
                <div class="card-title">API –ö–ª—é—á OpenRouter</div>
                <div class="input-group">
                    <input type="password" class="input-field" id="apiKeyInput" placeholder="sk-or-v1-...">
                    <div class="input-hint">–ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–≤–æ—ë–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –Ω–∏–∫—É–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫—Ä–æ–º–µ OpenRouter</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á?</div>
                <div style="font-size: 14px; color: #94a3b8; line-height: 1.6;">
                    1. –ó–∞–π–¥–∏ –Ω–∞ <a href="https://openrouter.ai" target="_blank" style="color: #60a5fa;">openrouter.ai</a><br>
                    2. –°–æ–∑–¥–∞–π –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –≤–æ–π–¥–∏<br>
                    3. –ü–µ—Ä–µ–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª Keys<br>
                    4. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∫–ª—é—á –∏ —Å–∫–æ–ø–∏—Ä—É–π –µ–≥–æ
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveApiKey()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="skipApiKey()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–±–µ–∑ AI)</button>
        </div>
        
        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden">
            <div class="header">
                <div class="header-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            
            <div class="card">
                <div class="card-title">API –ö–ª—é—á OpenRouter</div>
                
                <div class="key-status" id="keyStatus">
                    <span class="key-status-icon" id="keyStatusIcon">‚úÖ</span>
                    <span class="key-status-text" id="keyStatusText">–ö–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                </div>
                
                <div class="input-group">
                    <input type="password" class="input-field" id="apiKeyEdit" placeholder="sk-or-v1-...">
                </div>
                
                <button class="btn btn-secondary" onclick="updateApiKey()">–û–±–Ω–æ–≤–∏—Ç—å –∫–ª—é—á</button>
                <button class="btn btn-danger" onclick="deleteApiKey()">–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á</button>
            </div>
            
            <button class="btn btn-primary" onclick="closeSettings()" style="margin-top: 20px;">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        
        <!-- Morning Check-in -->
        <div id="morningScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="morningDate"></div>
                <div class="header-title">üåÖ –£—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω</div>
            </div>
            
            <div class="card">
                <div class="card-title">üíç Oura Ring</div>
                <div class="input-group">
                    <label class="input-label">Readiness Score</label>
                    <div class="input-row">
                        <input type="number" class="input-field center" id="ouraReadiness" placeholder="78" min="0" max="100">
                        <span class="input-unit">–∏–∑ 100</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üíì –î–∞–≤–ª–µ–Ω–∏–µ –∏ –ø—É–ª—å—Å</div>
                <div class="input-group">
                    <label class="input-label">–ê—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ</label>
                    <div class="input-row">
                        <input type="number" class="input-field center" id="bpSystolic" placeholder="125" min="80" max="200">
                        <span class="input-separator">/</span>
                        <input type="number" class="input-field center" id="bpDiastolic" placeholder="82" min="50" max="130">
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">–ü—É–ª—å—Å</label>
                    <div class="input-row">
                        <input type="number" class="input-field center" id="pulse" placeholder="65" min="40" max="150">
                        <span class="input-unit">—É–¥/–º–∏–Ω</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="toggle-row" onclick="toggleEliteHRV()">
                    <span class="toggle-label">üìä –î–æ–±–∞–≤–∏—Ç—å EliteHRV</span>
                    <div class="toggle" id="eliteToggle"></div>
                </div>
                <div id="eliteFields" class="hidden" style="margin-top: 12px;">
                    <div class="input-group">
                        <label class="input-label">Morning Readiness</label>
                        <div class="input-row">
                            <input type="number" class="input-field center" id="eliteScore" placeholder="7" min="1" max="10">
                            <span class="input-unit">–∏–∑ 10</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">RMSSD (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <div class="input-row">
                            <input type="number" class="input-field center" id="eliteRMSSD" placeholder="45">
                            <span class="input-unit">–º—Å</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeMorning()">
                ü§ñ –ü–æ–ª—É—á–∏—Ç—å AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            </button>
            
            <div id="aiLoading" class="hidden loading" style="margin-top: 20px;">
                <div class="spinner"></div>
                <div class="loading-text">AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ...</div>
            </div>
            
            <div id="aiResults" class="hidden">
                <div class="ai-box">
                    <div class="ai-box-header">
                        <span>ü§ñ</span>
                        <span class="ai-box-title">AI-–∞–Ω–∞–ª–∏–∑</span>
                        <div id="dayBadge" class="day-badge normal" style="margin-left: auto;">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω—ã–π</div>
                    </div>
                    <div class="ai-box-content" id="aiContent"></div>
                </div>
                <button class="btn btn-primary" onclick="startDay()" style="margin-top: 16px;">–ù–∞—á–∞—Ç—å –¥–µ–Ω—å ‚Üí</button>
            </div>
        </div>
        
        <!-- Main Screen -->
        <div id="mainScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="mainDate"></div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span class="header-title">Life Tracker</span>
                    <div id="mainBadge" class="day-badge normal">‚ö°</div>
                </div>
            </div>
            
            <div class="card" id="morningSummary">
                <div class="card-title">üåÖ –£—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
                <div class="morning-data">
                    <span class="morning-data-label">Oura Readiness</span>
                    <span class="morning-data-value" id="sumOura">‚Äî</span>
                </div>
                <div class="morning-data">
                    <span class="morning-data-label">–ê—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ</span>
                    <span class="morning-data-value" id="sumBP">‚Äî</span>
                </div>
                <div class="morning-data">
                    <span class="morning-data-label">–ü—É–ª—å—Å</span>
                    <span class="morning-data-value" id="sumPulse">‚Äî</span>
                </div>
            </div>
            
            <div class="life-counter">
                <div class="life-stats">
                    <div>
                        <div class="life-stat-number" id="daysLived">17 804</div>
                        <div class="life-stat-label">–ø—Ä–æ–∂–∏—Ç–æ</div>
                    </div>
                    <div>
                        <div class="life-stat-number yellow" id="daysToPension">5 937</div>
                        <div class="life-stat-label">–¥–æ –ø–µ–Ω—Å–∏–∏</div>
                    </div>
                    <div>
                        <div class="life-stat-number green" id="daysToGoal">15 068</div>
                        <div class="life-stat-label">–¥–æ 90 –ª–µ—Ç</div>
                    </div>
                </div>
            </div>
            
            <div class="system-status" id="systemStatus">
                <div class="system-icon" id="systemIcon">üîÑ</div>
                <div class="system-info">
                    <div class="system-title" id="systemTitle">–í—ã–ø–æ–ª–Ω–∏ –º–∏–Ω–∏–º—É–º</div>
                    <div class="system-subtitle" id="systemSubtitle">–û—Å—Ç–∞–ª–æ—Å—å: 3 –∏–∑ 3</div>
                </div>
                <div class="streak-badge" id="streakBadge">üî• 0</div>
            </div>
            
            <div id="habitsContainer"></div>
            
            <div class="reminders">
                <div class="reminders-title">‚ö†Ô∏è –ü–æ–º–Ω–∏</div>
                <div class="reminder-item"><span>ü©∏</span><span>–ë–µ–∑ –¥–æ–±–∞–≤–æ–∫ —Å –∂–µ–ª–µ–∑–æ–º (—Ñ–µ—Ä—Ä–∏—Ç–∏–Ω ~350)</span></div>
                <div class="reminder-item"><span>‚òï</span><span>–ö–æ—Ñ–µ–∏–Ω ‚â§150 –º–≥, –¥–æ 14:00</span></div>
                <div class="reminder-item"><span>üßÇ</span><span>–°–æ–ª—å ‚â§5 –≥, –∫–∞–ª–∏–π ‚â•4.7 –≥</span></div>
            </div>
            
            <div class="ai-box" id="aiTipBox">
                <div class="ai-box-header">
                    <span>üí°</span>
                    <span class="ai-box-title">AI-—Å–æ–≤–µ—Ç</span>
                </div>
                <div class="ai-box-content" id="aiTip">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav hidden" id="bottomNav">
        <div class="nav-item active"><span class="nav-item-icon">üè†</span><span class="nav-item-label">–ì–ª–∞–≤–Ω–∞—è</span></div>
        <div class="nav-item" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><span class="nav-item-icon">üçΩÔ∏è</span><span class="nav-item-label">–ü–∏—Ç–∞–Ω–∏–µ</span></div>
        <div class="nav-item" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><span class="nav-item-icon">üìà</span><span class="nav-item-label">–¢—Ä–µ–Ω–¥—ã</span></div>
        <div class="nav-item" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><span class="nav-item-icon">üåô</span><span class="nav-item-label">–í–µ—á–µ—Ä</span></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCq10f_AzUXLjsfWEQNRbTUGjBLy-u4hnI",
            authDomain: "life-tracker-54732.firebaseapp.com",
            databaseURL: "https://life-tracker-54732-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "life-tracker-54732",
            storageBucket: "life-tracker-54732.firebasestorage.app",
            messagingSenderId: "322679590707",
            appId: "1:322679590707:web:dee9c025719d986e987846"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const userRef = ref(database, 'users/sergey');
        
        // === API KEY (stored locally only) ===
        let API_KEY = localStorage.getItem('openrouter_api_key') || '';
        
        const BIRTH_DATE = new Date(1977, 3, 29);
        const PENSION_AGE = 65;
        const LIFE_GOAL = 90;
        
        const today = new Date();
        const dateKey = today.toISOString().split('T')[0];
        
        let userData = { days: {}, stats: { total_days: 0, days_in_system: 0, current_streak: 0 } };
        let todayData = null;
        let showElite = false;
        let currentScreen = 'loading';
        
        const habits = {
            minimum: { title: "üéØ –ú–ò–ù–ò–ú–£–ú", color: "green", items: [
                { id: 'steps_min', label: '4000 —à–∞–≥–æ–≤' },
                { id: 'protein_meal', label: '–ë–µ–ª–æ–∫ ‚â•40–≥ + –æ–≤–æ—â–∏' },
                { id: 'breathing', label: '5 –º–∏–Ω –¥—ã—Ö–∞–Ω–∏—è (6 –≤–¥/–º–∏–Ω)' }
            ]},
            normal: { title: "‚ö° –ù–û–†–ú–ê–õ–¨–ù–´–ô –î–ï–ù–¨", color: "blue", items: [
                { id: 'steps_full', label: '7000‚Äì10000 —à–∞–≥–æ–≤' },
                { id: 'training', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–ª–∞–Ω—É' },
                { id: 'nutrition_track', label: '–¢—Ä–µ–∫–∏–Ω–≥ –ø–∏—Ç–∞–Ω–∏—è' },
                { id: 'breathing_2x', label: '2 —Å–µ—Å—Å–∏–∏ –¥—ã—Ö–∞–Ω–∏—è' },
                { id: 'sleep_time', label: '–õ–µ—á—å –¥–æ 23:30' }
            ]},
            strong: { title: "üöÄ –°–ò–õ–¨–ù–´–ô –î–ï–ù–¨", color: "purple", items: [
                { id: 'extra_training', label: '–£–¥–ª–∏–Ω—ë–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞' },
                { id: 'full_tracking', label: '–ü–æ–ª–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤' }
            ]}
        };
        
        const AI_PROMPT = `–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∑–¥–æ—Ä–æ–≤—å—é –¥–ª—è –°–µ—Ä–≥–µ—è (48 –ª–µ—Ç).
–ü–†–û–§–ò–õ–¨: –≥–∏–ø–µ—Ä—Ç–æ–Ω–∏—è I —Å—Ç., –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å–∏–Ω–¥—Ä–æ–º, —Ñ–µ—Ä—Ä–∏—Ç–∏–Ω ~350 (–ó–ê–ü–†–ï–©–ï–ù–´ –¥–æ–±–∞–≤–∫–∏ —Å –∂–µ–ª–µ–∑–æ–º).
–õ–µ–∫–∞—Ä—Å—Ç–≤–∞: –ê–º–ª–æ–¥–∏–ø–∏–Ω, –≠—Å–ø–∏—Ä–æ 5–º–≥. –ö–æ—Ñ–µ–∏–Ω ‚â§150 –º–≥ –¥–æ 14:00. –°–æ–ª—å ‚â§5–≥.
–ê–î ‚â•130 —Å—á–∏—Ç–∞–µ—Ç—Å—è –ü–û–í–´–®–ï–ù–ù–´–ú –¥–ª—è –Ω–µ–≥–æ.

–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –¢–ò–ü–ê –î–ù–Ø:
üöÄ –°–ò–õ–¨–ù–´–ô: Oura ‚â•85 AND –ê–î <125/80
‚ö° –ù–û–†–ú–ê–õ–¨–ù–´–ô: Oura 70-84 AND –ê–î <130/85
üò¥ –í–û–°–°–¢–ê–ù–û–í–ò–¢–ï–õ–¨–ù–´–ô: Oura <70 OR –ê–î ‚â•140/90

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, —Å —ç–º–æ–¥–∑–∏.`;

        // === UTILITY ===
        function formatDate(d) { return d.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' }); }
        function formatNum(n) { return n.toLocaleString('ru-RU'); }
        
        function calcDates() {
            const now = new Date(); now.setHours(0,0,0,0);
            const pension = new Date(BIRTH_DATE); pension.setFullYear(pension.getFullYear() + PENSION_AGE);
            const goal = new Date(BIRTH_DATE); goal.setFullYear(goal.getFullYear() + LIFE_GOAL);
            const ms = 24*60*60*1000;
            return {
                lived: Math.floor((now - BIRTH_DATE) / ms),
                toPension: Math.max(0, Math.floor((pension - now) / ms)),
                toGoal: Math.max(0, Math.floor((goal - now) / ms))
            };
        }
        
        function updateSync(s) {
            document.getElementById('syncStatus').className = 'sync-status ' + s;
            document.getElementById('syncIcon').textContent = s === 'synced' ? '‚òÅÔ∏è' : s === 'syncing' ? 'üîÑ' : 'üì¥';
            document.getElementById('syncText').textContent = s === 'synced' ? '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ' : s === 'syncing' ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–û—Ñ–ª–∞–π–Ω';
        }
        
        function hideAllScreens() {
            ['loadingScreen', 'setupScreen', 'settingsScreen', 'morningScreen', 'mainScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }
        
        function showScreen(name) {
            hideAllScreens();
            document.getElementById(name + 'Screen').classList.remove('hidden');
            currentScreen = name;
            
            // Show/hide nav and settings button
            document.getElementById('bottomNav').classList.toggle('hidden', name !== 'main');
            document.getElementById('settingsBtn').classList.toggle('hidden', name === 'setup' || name === 'settings' || name === 'loading');
        }
        
        // === API KEY MANAGEMENT ===
        window.saveApiKey = function() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                alert('–í–≤–µ–¥–∏ API –∫–ª—é—á');
                return;
            }
            if (!key.startsWith('sk-or-')) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞. –ö–ª—é—á –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å sk-or-');
                return;
            }
            API_KEY = key;
            localStorage.setItem('openrouter_api_key', key);
            proceedAfterSetup();
        };
        
        window.skipApiKey = function() {
            API_KEY = '';
            proceedAfterSetup();
        };
        
        window.showSettings = function() {
            showScreen('settings');
            updateKeyStatus();
            document.getElementById('apiKeyEdit').value = API_KEY ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + API_KEY.slice(-8) : '';
        };
        
        window.closeSettings = function() {
            if (todayData?.morning) {
                showScreen('main');
                updateMain();
            } else {
                showScreen('morning');
            }
        };
        
        window.updateApiKey = function() {
            const key = document.getElementById('apiKeyEdit').value.trim();
            if (!key || key.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
                alert('–í–≤–µ–¥–∏ –Ω–æ–≤—ã–π –∫–ª—é—á');
                return;
            }
            if (!key.startsWith('sk-or-')) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞');
                return;
            }
            API_KEY = key;
            localStorage.setItem('openrouter_api_key', key);
            alert('–ö–ª—é—á –æ–±–Ω–æ–≤–ª—ë–Ω!');
            updateKeyStatus();
        };
        
        window.deleteApiKey = function() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å API –∫–ª—é—á? AI-—Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.')) {
                API_KEY = '';
                localStorage.removeItem('openrouter_api_key');
                updateKeyStatus();
                document.getElementById('apiKeyEdit').value = '';
            }
        };
        
        function updateKeyStatus() {
            const status = document.getElementById('keyStatus');
            const icon = document.getElementById('keyStatusIcon');
            const text = document.getElementById('keyStatusText');
            
            if (API_KEY) {
                status.className = 'key-status valid';
                icon.textContent = '‚úÖ';
                text.textContent = '–ö–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            } else {
                status.className = 'key-status invalid';
                icon.textContent = '‚ùå';
                text.textContent = '–ö–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            }
        }
        
        function proceedAfterSetup() {
            if (todayData?.morning) {
                showScreen('main');
                updateMain();
            } else {
                showScreen('morning');
            }
        }
        
        // === FIREBASE ===
        async function saveData() {
            updateSync('syncing');
            try {
                await set(userRef, userData);
                updateSync('synced');
                localStorage.setItem('ltBackup', JSON.stringify(userData));
            } catch(e) { 
                updateSync('offline'); 
                localStorage.setItem('ltBackup', JSON.stringify(userData)); 
            }
        }
        
        async function loadData() {
            try {
                const snap = await get(userRef);
                if (snap.val()) userData = snap.val();
                updateSync('synced');
            } catch(e) {
                const b = localStorage.getItem('ltBackup');
                if (b) userData = JSON.parse(b);
                updateSync('offline');
            }
            if (!userData.days) userData.days = {};
            if (!userData.stats) userData.stats = { total_days: 0, days_in_system: 0, current_streak: 0 };
            todayData = userData.days[dateKey] || null;
        }
        
        // === AI ===
        async function callAI(msg) {
            if (!API_KEY) {
                return 'AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –î–æ–±–∞–≤—å API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.';
            }
            
            try {
                const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': location.origin,
                        'X-Title': 'Life Tracker AI'
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-4o-mini',
                        messages: [{ role: 'system', content: AI_PROMPT }, { role: 'user', content: msg }],
                        max_tokens: 400, temperature: 0.7
                    })
                });
                const data = await res.json();
                if (data.error) {
                    console.error('AI error:', data.error);
                    return '–û—à–∏–±–∫–∞ AI: ' + (data.error.message || '–ü—Ä–æ–≤–µ—Ä—å API –∫–ª—é—á');
                }
                return data.choices[0].message.content;
            } catch(e) { 
                console.error('AI fetch error:', e);
                return '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.'; 
            }
        }
        
        // === MORNING ===
        window.toggleEliteHRV = function() {
            showElite = !showElite;
            document.getElementById('eliteToggle').classList.toggle('active', showElite);
            document.getElementById('eliteFields').classList.toggle('hidden', !showElite);
        };
        
        window.analyzeMorning = async function() {
            const oura = parseInt(document.getElementById('ouraReadiness').value);
            const sys = parseInt(document.getElementById('bpSystolic').value);
            const dia = parseInt(document.getElementById('bpDiastolic').value);
            const pulse = parseInt(document.getElementById('pulse').value);
            
            if (!oura || !sys || !dia || !pulse) { alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è'); return; }
            
            let elite = null, rmssd = null;
            if (showElite) {
                elite = parseInt(document.getElementById('eliteScore').value) || null;
                rmssd = parseInt(document.getElementById('eliteRMSSD').value) || null;
            }
            
            document.getElementById('analyzeBtn').classList.add('hidden');
            document.getElementById('aiLoading').classList.remove('hidden');
            
            let prompt = `–£—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
‚Ä¢ Oura Readiness: ${oura}/100
‚Ä¢ –ê–î: ${sys}/${dia} –º–º —Ä—Ç.—Å—Ç.
‚Ä¢ –ü—É–ª—å—Å: ${pulse} —É–¥/–º–∏–Ω`;
            if (elite) prompt += `\n‚Ä¢ EliteHRV: ${elite}/10`;
            if (rmssd) prompt += ` (RMSSD: ${rmssd} –º—Å)`;
            prompt += `\n\n–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –¥–Ω—è –∏ –¥–∞–π 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –∫–æ—Ñ–µ–∏–Ω, —Ñ–æ–∫—É—Å).`;
            
            const aiRes = await callAI(prompt);
            
            // Determine day type from response or fallback to logic
            let dayType = 'normal';
            if (aiRes.includes('–°–∏–ª—å–Ω—ã–π') || aiRes.includes('—Å–∏–ª—å–Ω—ã–π') || aiRes.includes('üöÄ')) {
                dayType = 'strong';
            } else if (aiRes.includes('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π') || aiRes.includes('–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π') || aiRes.includes('üò¥') || aiRes.includes('–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ')) {
                dayType = 'recovery';
            } else {
                // Fallback logic if AI doesn't specify
                if (oura >= 85 && sys < 125 && dia < 80) dayType = 'strong';
                else if (oura < 70 || sys >= 140 || dia >= 90) dayType = 'recovery';
            }
            
            if (!userData.days[dateKey]) userData.days[dateKey] = { habits: {} };
            userData.days[dateKey].morning = {
                ts: new Date().toISOString(), oura, bp_sys: sys, bp_dia: dia, pulse, elite, rmssd, day_type: dayType, ai: aiRes
            };
            todayData = userData.days[dateKey];
            await saveData();
            
            const badge = document.getElementById('dayBadge');
            badge.className = 'day-badge ' + dayType;
            badge.innerHTML = dayType === 'strong' ? 'üöÄ –°–∏–ª—å–Ω—ã–π' : dayType === 'normal' ? '‚ö° –ù–æ—Ä–º–∞–ª—å–Ω—ã–π' : 'üò¥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ';
            document.getElementById('aiContent').textContent = aiRes;
            
            document.getElementById('aiLoading').classList.add('hidden');
            document.getElementById('aiResults').classList.remove('hidden');
        };
        
        window.startDay = function() {
            showScreen('main');
            updateMain();
        };
        
        // === MAIN SCREEN ===
        function updateMain() {
            document.getElementById('mainDate').textContent = formatDate(today);
            
            const dt = todayData?.morning?.day_type || 'normal';
            const mb = document.getElementById('mainBadge');
            mb.className = 'day-badge ' + dt;
            mb.innerHTML = dt === 'strong' ? 'üöÄ' : dt === 'normal' ? '‚ö°' : 'üò¥';
            
            if (todayData?.morning) {
                const m = todayData.morning;
                document.getElementById('sumOura').textContent = m.oura;
                document.getElementById('sumOura').className = 'morning-data-value ' + (m.oura >= 85 ? 'good' : m.oura >= 70 ? '' : 'warning');
                document.getElementById('sumBP').textContent = `${m.bp_sys}/${m.bp_dia}`;
                document.getElementById('sumBP').className = 'morning-data-value ' + (m.bp_sys < 130 ? 'good' : m.bp_sys < 140 ? 'warning' : 'bad');
                document.getElementById('sumPulse').textContent = `${m.pulse} —É–¥/–º–∏–Ω`;
            }
            
            const d = calcDates();
            document.getElementById('daysLived').textContent = formatNum(d.lived);
            document.getElementById('daysToPension').textContent = formatNum(d.toPension);
            document.getElementById('daysToGoal').textContent = formatNum(d.toGoal);
            
            updateStatus();
            renderHabits();
            
            if (todayData?.morning?.ai) {
                document.getElementById('aiTip').textContent = todayData.morning.ai;
            } else {
                document.getElementById('aiTip').textContent = 'AI-–∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω';
            }
        }
        
        function updateStatus() {
            const min = ['steps_min', 'protein_meal', 'breathing'];
            const ch = todayData?.habits || {};
            const done = min.filter(id => ch[id]).length;
            const complete = done === min.length;
            
            const st = document.getElementById('systemStatus');
            st.className = 'system-status ' + (complete ? 'complete' : 'incomplete');
            document.getElementById('systemIcon').textContent = complete ? '‚úÖ' : 'üîÑ';
            document.getElementById('systemTitle').textContent = complete ? '–¢—ã –≤ —Å–∏—Å—Ç–µ–º–µ!' : '–í—ã–ø–æ–ª–Ω–∏ –º–∏–Ω–∏–º—É–º';
            document.getElementById('systemSubtitle').textContent = complete ? 
                `–î–µ–Ω—å #${userData.stats.total_days + 1}` : `–û—Å—Ç–∞–ª–æ—Å—å: ${min.length - done} –∏–∑ ${min.length}`;
            document.getElementById('streakBadge').textContent = 'üî• ' + (userData.stats.current_streak || 0);
        }
        
        function renderHabits() {
            const c = document.getElementById('habitsContainer');
            c.innerHTML = '';
            const dt = todayData?.morning?.day_type || 'normal';
            const ch = todayData?.habits || {};
            
            Object.entries(habits).forEach(([key, sec]) => {
                const active = key === 'minimum' || (key === 'normal' && dt !== 'recovery') || (key === 'strong' && dt === 'strong');
                const cnt = sec.items.filter(i => ch[i.id]).length;
                
                const div = document.createElement('div');
                div.className = `habit-section ${sec.color} ${active ? '' : 'inactive'}`;
                div.innerHTML = `
                    <div class="habit-header">
                        <span class="habit-title ${sec.color}">${sec.title}</span>
                        <span class="habit-counter ${sec.color}">${cnt}/${sec.items.length}</span>
                    </div>
                    ${sec.items.map(i => `
                        <div class="habit-item ${ch[i.id] ? 'checked' : ''} ${sec.color}" data-id="${i.id}">
                            <div class="checkbox"><span class="checkbox-mark">‚úì</span></div>
                            <span class="habit-item-label">${i.label}</span>
                        </div>
                    `).join('')}
                `;
                c.appendChild(div);
            });
            
            c.querySelectorAll('.habit-item').forEach(el => {
                el.addEventListener('click', () => toggleHabit(el.dataset.id));
            });
        }
        
        async function toggleHabit(id) {
            if (!todayData) todayData = { habits: {} };
            if (!todayData.habits) todayData.habits = {};
            todayData.habits[id] = !todayData.habits[id];
            userData.days[dateKey] = todayData;
            await saveData();
            updateStatus();
            renderHabits();
        }
        
        // === INIT ===
        async function init() {
            await loadData();
            
            document.getElementById('morningDate').textContent = formatDate(today);
            
            // Check if API key exists
            if (!API_KEY) {
                showScreen('setup');
                return;
            }
            
            // Check if morning check-in done
            if (todayData?.morning) {
                showScreen('main');
                updateMain();
            } else {
                showScreen('morning');
            }
        }
        
        setTimeout(init, 500);
    </script>
</body>
</html>
