<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0f1a">
    <meta name="apple-mobile-web-app-title" content="Life Tracker">
    <title>Life Tracker AI</title>
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #0a0f1a 0%, #111827 50%, #0a0f1a 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .container { max-width: 500px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .hidden { display: none !important; }
        
        /* Sync */
        .sync-status {
            position: fixed; top: 10px; right: 10px;
            padding: 6px 12px; border-radius: 20px; font-size: 11px; z-index: 1000;
            display: flex; align-items: center; gap: 6px;
        }
        .sync-status.synced { background: rgba(16,185,129,0.2); color: #10b981; }
        .sync-status.syncing { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .sync-status.offline { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        .settings-btn {
            position: fixed; top: 10px; left: 10px;
            padding: 6px 12px; border-radius: 20px; font-size: 11px; z-index: 1000;
            background: rgba(255,255,255,0.1); color: #94a3b8;
            border: none; cursor: pointer;
        }
        
        /* Cards */
        .card {
            background: rgba(255,255,255,0.04);
            border-radius: 16px; padding: 16px; margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card-title { font-size: 14px; font-weight: 600; color: #94a3b8; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .optional-hint { font-size: 11px; font-weight: 400; color: #64748b; }

        /* Header */
        .header { text-align: center; padding: 20px 0 24px; }
        .header-date { font-size: 14px; color: #64748b; margin-bottom: 4px; }
        .header-title { font-size: 24px; font-weight: 700; color: #fff; }
        .header-subtitle { font-size: 14px; color: #64748b; margin-top: 8px; }
        
        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .input-label { font-size: 13px; color: #94a3b8; margin-bottom: 6px; display: block; }
        .input-row { display: flex; gap: 8px; align-items: center; }
        .input-field {
            flex: 1; background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px; padding: 14px 16px;
            color: #fff; font-size: 16px; outline: none;
        }
        .input-field.center { text-align: center; font-size: 18px; font-weight: 600; }
        .input-field:focus { border-color: #3b82f6; background: rgba(59,130,246,0.1); }
        .input-field::placeholder { color: #64748b; font-weight: 400; }
        .input-unit { font-size: 14px; color: #64748b; min-width: 50px; }
        .input-separator { font-size: 24px; color: #64748b; }
        .input-hint { font-size: 12px; color: #64748b; margin-top: 8px; }

        /* Weight change indicator */
        .weight-change { font-size: 13px; margin-top: 8px; text-align: center; }
        .weight-change.down { color: #10b981; }
        .weight-change.up { color: #f59e0b; }
        .weight-change.same { color: #64748b; }

        /* Edema warning */
        .edema-warning {
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 8px;
            font-size: 12px;
            color: #fca5a5;
            border-left: 3px solid #ef4444;
        }
        .edema-warning .edema-title { font-weight: 600; margin-bottom: 4px; color: #f87171; }
        .edema-warning .edema-text { line-height: 1.4; }

        /* Toggle */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .toggle-label { font-size: 14px; color: #e2e8f0; }
        .toggle { width: 48px; height: 28px; background: rgba(255,255,255,0.15); border-radius: 14px; position: relative; cursor: pointer; }
        .toggle.active { background: #3b82f6; }
        .toggle::after { content: ''; position: absolute; width: 22px; height: 22px; background: #fff; border-radius: 50%; top: 3px; left: 3px; transition: all 0.2s; }
        .toggle.active::after { left: 23px; }
        
        /* Buttons */
        .btn { width: 100%; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.08); color: #e2e8f0; border: 1px solid rgba(255,255,255,0.15); }
        .btn-danger { background: rgba(239,68,68,0.2); color: #f87171; }
        .btn-small { width: auto; padding: 10px 16px; font-size: 14px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn + .btn { margin-top: 10px; }
        
        /* Day badges */
        .day-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .day-badge.strong { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .day-badge.normal { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .day-badge.recovery { background: rgba(100,116,139,0.2); color: #94a3b8; }
        
        /* Chat */
        .chat-container { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; margin-top: 16px; overflow: hidden; }
        .chat-header { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.15)); padding: 14px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .chat-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .chat-info { flex: 1; }
        .chat-name { font-size: 15px; font-weight: 600; color: #fff; }
        .chat-status { font-size: 12px; color: #10b981; }
        .chat-messages { max-height: 400px; overflow-y: auto; padding: 16px; }
        .message { margin-bottom: 16px; display: flex; gap: 10px; }
        .message.user { flex-direction: row-reverse; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .message.ai .message-avatar { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .message.user .message-avatar { background: rgba(255,255,255,0.15); }
        .message-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; }
        .message.ai .message-bubble { background: rgba(255,255,255,0.08); border-bottom-left-radius: 4px; }
        .message.user .message-bubble { background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-bottom-right-radius: 4px; }
        .chat-input-container { display: flex; gap: 10px; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); }
        .chat-input { flex: 1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; padding: 12px 18px; color: #fff; font-size: 14px; outline: none; }
        .chat-input:focus { border-color: #3b82f6; }
        .chat-input::placeholder { color: #64748b; }
        .chat-send { width: 44px; height: 44px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 50%; color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .chat-send:disabled { opacity: 0.5; }
        .typing-indicator { display: flex; gap: 4px; padding: 8px 0; }
        .typing-dot { width: 8px; height: 8px; background: #64748b; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-4px); opacity: 1; } }
        .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.08); }
        .quick-btn { padding: 8px 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; color: #94a3b8; font-size: 12px; cursor: pointer; }
        .quick-btn:active { background: rgba(255,255,255,0.15); }
        
        /* Loading */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; gap: 16px; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; color: #94a3b8; }
        
        /* Life counter */
        .life-counter { background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(139,92,246,0.12)); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(99,102,241,0.2); }
        .life-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center; }
        .life-stat-number { font-size: 20px; font-weight: 700; color: #fff; }
        .life-stat-number.yellow { color: #fbbf24; }
        .life-stat-number.green { color: #10b981; }
        .life-stat-label { font-size: 11px; color: #64748b; margin-top: 2px; }
        
        /* Morning data */
        .morning-data { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .morning-data:last-child { border-bottom: none; }
        .morning-data-label { font-size: 14px; color: #94a3b8; }
        .morning-data-value { font-size: 14px; font-weight: 600; color: #fff; }
        .morning-data-value.good { color: #10b981; }
        .morning-data-value.warning { color: #fbbf24; }
        .morning-data-value.bad { color: #ef4444; }
        
        /* System status */
        .system-status { display: flex; align-items: center; gap: 14px; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .system-status.incomplete { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
        .system-status.complete { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1)); border: 1px solid rgba(16,185,129,0.3); }
        .system-icon { font-size: 32px; }
        .system-info { flex: 1; }
        .system-title { font-size: 16px; font-weight: 700; color: #e2e8f0; }
        .system-status.complete .system-title { color: #10b981; }
        .system-subtitle { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        .streak-badge { background: rgba(251,146,60,0.2); padding: 6px 10px; border-radius: 12px; font-size: 12px; color: #fb923c; font-weight: 600; }
        
        /* Habits */
        .habit-section { margin-bottom: 14px; border-radius: 16px; padding: 16px; background: rgba(255,255,255,0.03); }
        .habit-section.inactive { opacity: 0.4; }
        .habit-section.green { border: 1px solid rgba(16,185,129,0.4); }
        .habit-section.blue { border: 1px solid rgba(59,130,246,0.4); }
        .habit-section.purple { border: 1px solid rgba(139,92,246,0.4); }
        .habit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .habit-title { font-size: 15px; font-weight: 700; }
        .habit-title.green { color: #10b981; }
        .habit-title.blue { color: #3b82f6; }
        .habit-title.purple { color: #8b5cf6; }
        .habit-counter { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .habit-counter.green { background: rgba(16,185,129,0.25); color: #10b981; }
        .habit-counter.blue { background: rgba(59,130,246,0.25); color: #3b82f6; }
        .habit-counter.purple { background: rgba(139,92,246,0.25); color: #8b5cf6; }
        .habit-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 6px; cursor: pointer; background: rgba(255,255,255,0.02); }
        .habit-item:active { transform: scale(0.98); }
        .habit-item.checked.green { background: rgba(16,185,129,0.1); }
        .habit-item.checked.blue { background: rgba(59,130,246,0.1); }
        .habit-item.checked.purple { background: rgba(139,92,246,0.1); }
        .checkbox { width: 24px; height: 24px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        .habit-item.checked .checkbox { background: currentColor; border-color: currentColor; }
        .habit-item.checked.green .checkbox { color: #10b981; }
        .habit-item.checked.blue .checkbox { color: #3b82f6; }
        .habit-item.checked.purple .checkbox { color: #8b5cf6; }
        .checkbox-mark { color: #fff; font-size: 14px; display: none; }
        .habit-item.checked .checkbox-mark { display: block; }
        .habit-item-label { flex: 1; font-size: 14px; color: #e2e8f0; }
        .habit-item.checked .habit-item-label { text-decoration: line-through; opacity: 0.7; }
        
        /* Bottom nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,15,26,0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 12px 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #64748b; cursor: pointer; padding: 8px 16px; border-radius: 12px; }
        .nav-item.active { color: #3b82f6; background: rgba(59,130,246,0.1); }
        .nav-item-icon { font-size: 20px; }
        .nav-item-label { font-size: 11px; }
        
        /* Reminders */
        .reminders { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .reminders-title { font-size: 14px; font-weight: 600; color: #f87171; margin-bottom: 10px; }
        .reminder-item { display: flex; gap: 8px; font-size: 13px; color: #e2e8f0; padding: 4px 0; }
        
        /* Key status */
        .key-status { display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 12px; margin-bottom: 16px; }
        .key-status.valid { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); }
        .key-status.invalid { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); }
        .key-status-icon { font-size: 20px; }
        .key-status-text { font-size: 14px; }
        .key-status.valid .key-status-text { color: #10b981; }
        .key-status.invalid .key-status-text { color: #f87171; }
        
        /* ========== NUTRITION STYLES ========== */
        .nutrition-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .nutrition-card {
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            padding: 14px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .nutrition-card.calories {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.15));
            border-color: rgba(99,102,241,0.3);
        }
        
        .nutrition-value {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
        }

        .nutrition-card.calories .nutrition-value { font-size: 48px; }

        .nutrition-card.salt-card {
            background: rgba(156,163,175,0.08);
            border-color: rgba(156,163,175,0.2);
        }
        .nutrition-card.salt-card.warning {
            background: rgba(251,191,36,0.15);
            border-color: rgba(251,191,36,0.4);
        }
        .nutrition-card.salt-card.danger {
            background: rgba(239,68,68,0.15);
            border-color: rgba(239,68,68,0.4);
        }
        .salt-warning {
            font-size: 11px;
            margin-top: 6px;
            color: #fbbf24;
        }
        .salt-warning.danger {
            color: #f87171;
        }

        .nutrition-card.balance-card {
            background: rgba(59,130,246,0.08);
            border-color: rgba(59,130,246,0.2);
            grid-column: span 2;
        }
        .nutrition-card.balance-card .nutrition-value {
            font-size: 28px;
        }
        .nutrition-card.balance-card.surplus {
            background: rgba(251,191,36,0.15);
            border-color: rgba(251,191,36,0.4);
        }
        .nutrition-card.balance-card.surplus .nutrition-value {
            color: #f59e0b;
        }
        .nutrition-card.balance-card.deficit {
            background: rgba(34,197,94,0.15);
            border-color: rgba(34,197,94,0.4);
        }
        .nutrition-card.balance-card.deficit .nutrition-value {
            color: #22c55e;
        }
        .calorie-balance-details {
            font-size: 11px;
            color: #64748b;
            margin-top: 6px;
        }

        .nutrition-label {
            font-size: 15px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .nutrition-progress {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .nutrition-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .nutrition-progress-bar.good { background: #10b981; }
        .nutrition-progress-bar.warning { background: #fbbf24; }
        .nutrition-progress-bar.over { background: #ef4444; }
        
        .nutrition-remaining {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 6px;
        }
        
        /* Photo upload */
        .photo-upload-area {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }
        
        .photo-upload-area:active {
            border-color: #3b82f6;
            background: rgba(59,130,246,0.1);
        }
        
        .photo-upload-icon { font-size: 48px; margin-bottom: 12px; }
        .photo-upload-text { font-size: 14px; color: #94a3b8; }
        .photo-upload-hint { font-size: 12px; color: #64748b; margin-top: 8px; }
        
        /* Photo buttons (camera/gallery) */
        .photo-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .photo-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 16px;
            background: rgba(59,130,246,0.1);
            border: 2px dashed rgba(59,130,246,0.3);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .photo-btn:active {
            background: rgba(59,130,246,0.2);
            border-color: #3b82f6;
            transform: scale(0.98);
        }
        
        .photo-btn-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }
        
        .photo-btn-text {
            font-size: 14px;
            font-weight: 600;
            color: #60a5fa;
        }
        
        .photo-hint {
            text-align: center;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 12px;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        /* Multi-photo preview */
        .multi-photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 16px 0;
        }
        .photo-thumb {
            position: relative;
            width: 70px;
            height: 70px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-thumb-delete {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(239,68,68,0.9);
            border: none;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-thumb-num {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
        }
        .photo-thumb.add-more {
            background: rgba(59,130,246,0.1);
            border: 2px dashed rgba(59,130,246,0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-thumb.add-more span {
            font-size: 28px;
            color: #3b82f6;
        }
        .btn-large {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            margin-top: 12px;
        }

        /* Food log */
        .food-log-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .food-log-item.has-warning {
            border-color: rgba(251,191,36,0.3);
            background: rgba(251,191,36,0.05);
        }

        .food-log-icon { font-size: 28px; padding-top: 2px; }

        .food-log-info { flex: 1; }

        .food-log-name {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .food-log-weight {
            font-size: 12px;
            font-weight: 400;
            color: #94a3b8;
            background: rgba(255,255,255,0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .food-log-macros {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        .food-log-macros .macro {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .food-log-macros .macro.protein { background: rgba(34,197,94,0.15); color: #4ade80; }
        .food-log-macros .macro.fat { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .food-log-macros .macro.carbs { background: rgba(59,130,246,0.15); color: #60a5fa; }
        .food-log-macros .macro.salt { background: rgba(156,163,175,0.15); color: #9ca3af; }
        .food-log-macros .macro.salt.high { background: rgba(239,68,68,0.2); color: #f87171; }

        .food-log-desc {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            line-height: 1.4;
        }

        .food-log-warnings {
            font-size: 11px;
            color: #fbbf24;
            margin-top: 4px;
            padding: 4px 8px;
            background: rgba(251,191,36,0.1);
            border-radius: 4px;
        }

        .food-log-calories {
            font-size: 18px;
            font-weight: 700;
            color: #3b82f6;
            text-align: right;
            padding-top: 2px;
        }

        .food-log-calories .kcal-label {
            display: block;
            font-size: 10px;
            font-weight: 400;
            color: #64748b;
        }

        .food-log-time {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .food-log-delete {
            padding: 8px;
            background: rgba(239,68,68,0.1);
            border: none;
            border-radius: 8px;
            color: #f87171;
            cursor: pointer;
            font-size: 14px;
            margin-top: 2px;
        }
        
        /* Nutrition table */
        .nutrition-table {
            width: 100%;
            font-size: 13px;
        }
        
        .nutrition-table-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .nutrition-table-row:last-child { border-bottom: none; }
        
        .nutrition-table-label { color: #94a3b8; }
        
        .nutrition-table-values {
            display: flex;
            gap: 16px;
        }
        
        .nutrition-table-plan { color: #64748b; }
        .nutrition-table-fact { color: #fff; font-weight: 600; }
        .nutrition-table-fact.good { color: #10b981; }
        .nutrition-table-fact.warning { color: #fbbf24; }
        .nutrition-table-fact.over { color: #ef4444; }
        
        /* Text input for food */
        .food-input-section {
            margin-top: 12px;
        }
        .food-input-label {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .food-input-row {
            display: flex;
            gap: 10px;
        }

        .food-input {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 14px 16px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        
        .food-input:focus {
            border-color: #3b82f6;
        }
        
        .food-input::placeholder { color: #64748b; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }
        
        .tab.active {
            background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2));
            border-color: rgba(99,102,241,0.4);
            color: #fff;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state-text { font-size: 14px; }
        
        /* ========== EVENING STYLES ========== */
        .bp-comparison {
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 16px 0;
        }
        
        .bp-comparison-item { text-align: center; }
        .bp-comparison-label { font-size: 12px; color: #64748b; margin-bottom: 4px; }
        .bp-comparison-value { font-size: 20px; font-weight: 700; color: #fff; }
        .bp-comparison-arrow { font-size: 24px; color: #64748b; }
        
        .bp-comparison-change {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .bp-comparison-change.good { background: rgba(16,185,129,0.2); color: #10b981; }
        .bp-comparison-change.warning { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .bp-comparison-change.bad { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        .day-summary { padding: 8px 0; }
        
        .day-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .day-summary-row:last-child { border-bottom: none; }
        .day-summary-row.highlight {
            background: rgba(59,130,246,0.1);
            margin: 8px -16px;
            padding: 12px 16px;
            border-radius: 8px;
            border-bottom: none;
        }
        .day-summary-label { color: #94a3b8; font-size: 14px; }
        .day-summary-value { color: #fff; font-size: 14px; font-weight: 600; }
        .day-summary-value.good { color: #10b981; }
        .day-summary-value.warning { color: #fbbf24; }
        .day-summary-value.bad { color: #ef4444; }

        /* End Day Section */
        .end-day-section {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.15));
            border-radius: 16px;
            border: 1px solid rgba(139,92,246,0.3);
            text-align: center;
        }
        .end-day-time {
            font-size: 13px;
            color: #a78bfa;
            margin-bottom: 12px;
        }
        .btn-end-day {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        .btn-end-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99,102,241,0.4);
        }
        .btn-end-day:disabled {
            background: #374151;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .end-day-hint {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 12px;
        }

        /* Day Completed */
        .day-completed-card {
            background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(59,130,246,0.2));
            border: 1px solid rgba(16,185,129,0.4);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            margin-top: 20px;
        }
        .day-completed-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        .day-completed-title {
            font-size: 24px;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 8px;
        }
        .day-completed-text {
            color: #94a3b8;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .day-completed-stats {
            font-size: 14px;
            color: #cbd5e1;
            line-height: 1.8;
        }
        .btn-undo-day {
            margin-top: 20px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #f87171;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-undo-day:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .day-rating {
            display: flex;
            justify-content: space-around;
            padding: 16px 0;
        }
        
        .rating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .rating-btn:active { transform: scale(0.9); }
        
        .rating-btn.selected {
            border-color: #3b82f6;
            background: rgba(59,130,246,0.2);
            transform: scale(1.1);
        }
        
        .day-rating-label {
            text-align: center;
            font-size: 13px;
            color: #64748b;
            margin-top: 8px;
        }

        /* Nutrition feedback */
        .feedback-section { }
        .feedback-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 10px;
        }
        .feedback-buttons {
            display: flex;
            gap: 8px;
        }
        .feedback-btn {
            flex: 1;
            padding: 12px 8px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            color: #e2e8f0;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .feedback-btn:active { transform: scale(0.97); }
        .feedback-btn.selected {
            border-color: #3b82f6;
            background: rgba(59,130,246,0.2);
            color: #fff;
        }
        .feedback-btn[data-value="overate"].selected {
            border-color: #f87171;
            background: rgba(248,113,113,0.2);
        }
        .feedback-btn[data-value="underate"].selected {
            border-color: #fbbf24;
            background: rgba(251,191,36,0.2);
        }
        .feedback-btn[data-value="normal"].selected {
            border-color: #10b981;
            background: rgba(16,185,129,0.2);
        }
        .feedback-saved {
            text-align: center;
            color: #10b981;
            font-size: 13px;
            margin-top: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .feedback-saved.show {
            opacity: 1;
        }
        #missedFoodResult {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 12px;
            padding: 12px;
            font-size: 13px;
            color: #e2e8f0;
        }
        #missedFoodResult .missed-food-added {
            color: #10b981;
            font-weight: 600;
            margin-top: 8px;
        }

        .sleep-checklist { padding: 8px 0; }
        
        .sleep-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            background: rgba(255,255,255,0.02);
            font-size: 14px;
            color: #e2e8f0;
        }
        
        .sleep-item:active { transform: scale(0.98); }
        
        .sleep-item.checked {
            background: rgba(139,92,246,0.1);
        }
        
        .sleep-item.checked .checkbox {
            background: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        .sleep-item.checked span:last-child {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        /* Breathing sessions */
        .breathing-add { margin-bottom: 12px; }
        
        .breathing-log-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(139,92,246,0.08);
            border: 1px solid rgba(139,92,246,0.2);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .breathing-log-icon { font-size: 24px; }
        .breathing-log-info { flex: 1; }
        .breathing-log-type { font-size: 14px; font-weight: 600; color: #e2e8f0; }
        .breathing-log-details { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        .breathing-log-time { font-size: 11px; color: #64748b; }
        
        .breathing-log-delete {
            padding: 6px;
            background: rgba(239,68,68,0.1);
            border: none;
            border-radius: 6px;
            color: #f87171;
            cursor: pointer;
            font-size: 12px;
        }
        
        .bp-change-badge {
            text-align: center;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 12px;
        }
        
        .bp-change-badge.good { background: rgba(16,185,129,0.2); color: #10b981; }
        .bp-change-badge.warning { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .bp-change-badge.bad { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        /* ========== WORKOUTS STYLES ========== */
        .workout-type-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .workout-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 14px 8px;
            background: rgba(255,255,255,0.04);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .workout-type-btn:active { transform: scale(0.96); }

        .workout-type-btn.selected {
            border-color: #fb923c;
            background: rgba(251,146,60,0.15);
        }

        .workout-type-btn.strength { border-color: rgba(239,68,68,0.3); }
        .workout-type-btn.strength.selected { background: rgba(239,68,68,0.15); border-color: #ef4444; }

        .workout-type-btn.rowing { border-color: rgba(59,130,246,0.3); }
        .workout-type-btn.rowing.selected { background: rgba(59,130,246,0.15); border-color: #3b82f6; }

        .workout-type-btn.walking { border-color: rgba(16,185,129,0.3); }
        .workout-type-btn.walking.selected { background: rgba(16,185,129,0.15); border-color: #10b981; }

        .workout-type-btn.stretch { border-color: rgba(139,92,246,0.3); }
        .workout-type-btn.stretch.selected { background: rgba(139,92,246,0.15); border-color: #8b5cf6; }

        .workout-type-icon { font-size: 28px; margin-bottom: 4px; }
        .workout-type-name { font-size: 11px; font-weight: 600; color: #e2e8f0; }

        .workout-form { padding: 12px 0 0; }

        /* Feeling selector */
        .feeling-selector {
            display: flex;
            gap: 8px;
        }

        .feeling-btn {
            flex: 1;
            padding: 12px 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #94a3b8;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .feeling-btn.selected { color: #fff; font-weight: 600; }

        .feeling-btn.hard.selected {
            background: rgba(239,68,68,0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .feeling-btn.normal.selected {
            background: rgba(251,191,36,0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .feeling-btn.easy.selected {
            background: rgba(16,185,129,0.2);
            border-color: #10b981;
            color: #10b981;
        }

        /* Week calendar */
        .week-calendar {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .week-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .week-day-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
        }

        .week-day-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 16px;
            background: rgba(255,255,255,0.05);
        }

        .week-day-icon.has-workout {
            background: rgba(251,146,60,0.2);
        }

        .week-day-icon.today {
            border: 2px solid #3b82f6;
        }

        .multi-workout {
            font-size: 14px;
            font-weight: 700;
            color: #fb923c;
        }

        /* Workout toast */
        .workout-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(16,185,129,0.95);
            color: #fff;
            padding: 16px 24px;
            border-radius: 16px;
            text-align: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .workout-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast-message {
            font-weight: 600;
            font-size: 16px;
        }
        .toast-hint {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .week-progress {
            background: rgba(251,146,60,0.2);
            color: #fb923c;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Workout history item */
        .workout-history-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
        }

        .workout-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .workout-history-date {
            font-size: 12px;
            color: #64748b;
        }

        .workout-history-feeling {
            font-size: 14px;
        }

        .workout-history-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .workout-history-icon { font-size: 24px; }

        .workout-history-info { flex: 1; }

        .workout-history-title {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .workout-history-details {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .workout-history-stats {
            text-align: right;
        }

        .workout-history-calories {
            font-size: 14px;
            font-weight: 600;
            color: #fb923c;
        }

        .workout-history-preview {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            margin-left: 10px;
            cursor: pointer;
        }

        .workout-history-delete {
            padding: 6px;
            background: rgba(239,68,68,0.1);
            border: none;
            border-radius: 6px;
            color: #f87171;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }

        /* AI Insights */
        .ai-insights-card {
            background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(139,92,246,0.08));
            border-color: rgba(99,102,241,0.2);
        }

        .ai-insights-content {
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .ai-insights-loading {
            color: #64748b;
            font-style: italic;
        }

        .ai-insights-context {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 10px;
        }

        /* AI Prediction Card */
        .ai-prediction-card {
            background: linear-gradient(135deg, rgba(251,146,60,0.1), rgba(239,68,68,0.08));
            border-color: rgba(251,146,60,0.3);
        }

        .ai-prediction-content {
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .ai-prediction-loading {
            color: #64748b;
            font-style: italic;
        }

        .prediction-risk {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 10px;
        }

        .prediction-risk.high {
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.3);
        }

        .prediction-risk.medium {
            background: rgba(251,191,36,0.15);
            border: 1px solid rgba(251,191,36,0.3);
        }

        .prediction-risk.low {
            background: rgba(34,197,94,0.15);
            border: 1px solid rgba(34,197,94,0.3);
        }

        .prediction-risk-icon {
            font-size: 24px;
        }

        .prediction-risk-text {
            flex: 1;
        }

        .prediction-risk-level {
            font-weight: 600;
            font-size: 14px;
        }

        .prediction-risk.high .prediction-risk-level { color: #ef4444; }
        .prediction-risk.medium .prediction-risk-level { color: #fbbf24; }
        .prediction-risk.low .prediction-risk-level { color: #22c55e; }

        .prediction-risk-desc {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .prediction-factors {
            margin-top: 10px;
            font-size: 13px;
            color: #94a3b8;
        }

        .prediction-factors-title {
            font-weight: 500;
            color: #cbd5e1;
            margin-bottom: 6px;
        }

        .prediction-recommendation {
            margin-top: 12px;
            padding: 10px 12px;
            background: rgba(59,130,246,0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #93c5fd;
        }

        /* AI Correlations */
        .ai-correlations-card {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(59,130,246,0.08));
            border-color: rgba(16,185,129,0.3);
        }

        .ai-correlations-card .card-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-top: -8px;
            margin-bottom: 12px;
        }

        /* Correlation navigation */
        .correlation-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        .correlation-nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(59,130,246,0.2);
            border: 1px solid rgba(59,130,246,0.4);
            color: #60a5fa;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .correlation-nav-btn:hover {
            background: rgba(59,130,246,0.3);
        }
        .correlation-nav-btn:active {
            transform: scale(0.95);
        }
        .correlation-counter {
            font-size: 16px;
            color: #94a3b8;
            min-width: 60px;
            text-align: center;
        }

        .ai-correlations-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .correlation-loading {
            color: #64748b;
            font-style: italic;
            padding: 20px 0;
            text-align: center;
            font-size: 15px;
        }

        .correlation-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px;
        }

        .correlation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .correlation-icon {
            font-size: 28px;
        }

        .correlation-title {
            font-weight: 600;
            color: #fff;
            font-size: 18px;
            flex: 1;
        }

        .correlation-details {
            font-size: 16px;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .correlation-impact {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .correlation-impact.positive {
            background: rgba(34,197,94,0.2);
            color: #22c55e;
        }

        .correlation-impact.negative {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
        }

        .correlation-impact.neutral {
            background: rgba(251,191,36,0.2);
            color: #fbbf24;
        }

        .correlation-confidence {
            font-size: 15px;
            color: #60a5fa;
            margin-top: 12px;
            padding: 10px;
            background: rgba(59,130,246,0.1);
            border-radius: 8px;
        }

        /* Weekly Report */
        .weekly-report-card {
            background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(236,72,153,0.08));
            border-color: rgba(139,92,246,0.3);
        }

        .weekly-report-card .card-subtitle {
            font-size: 12px;
            color: #64748b;
            margin-top: -8px;
            margin-bottom: 12px;
        }

        .weekly-report-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .report-loading {
            color: #64748b;
            font-style: italic;
            padding: 20px 0;
            text-align: center;
        }

        .report-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 14px;
        }

        .report-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .report-section-icon {
            font-size: 20px;
        }

        .report-section-title {
            font-weight: 600;
            font-size: 14px;
            color: #e2e8f0;
        }

        .report-trend {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .report-trend.improving {
            background: rgba(34,197,94,0.15);
            border: 1px solid rgba(34,197,94,0.3);
        }

        .report-trend.stable {
            background: rgba(251,191,36,0.15);
            border: 1px solid rgba(251,191,36,0.3);
        }

        .report-trend.declining {
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.3);
        }

        .report-trend-icon {
            font-size: 24px;
        }

        .report-trend-text {
            flex: 1;
        }

        .report-trend-title {
            font-weight: 600;
            font-size: 14px;
        }

        .report-trend.improving .report-trend-title { color: #22c55e; }
        .report-trend.stable .report-trend-title { color: #fbbf24; }
        .report-trend.declining .report-trend-title { color: #ef4444; }

        .report-trend-desc {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .report-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .report-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
            color: #cbd5e1;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .report-list li:last-child {
            border-bottom: none;
        }

        .report-list-icon {
            flex-shrink: 0;
        }

        .report-actions {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 10px;
            padding: 12px;
        }

        .report-actions-title {
            font-weight: 600;
            font-size: 13px;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .report-action-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: #93c5fd;
        }

        /* Workout photos grid */
        .workout-photos-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 12px 0;
        }

        .workout-photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255,255,255,0.05);
        }

        .workout-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .workout-photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(239,68,68,0.9);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workout-photo-add {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255,255,255,0.2);
            color: #64748b;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .workout-photo-add:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        /* AI notes */
        .ai-notes {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .ai-notes-title {
            font-size: 13px;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .ai-notes {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.5;
        }

        /* Exercises container */
        .exercises-container {
            background: rgba(34,197,94,0.1);
            border: 1px solid rgba(34,197,94,0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .exercises-title {
            font-size: 15px;
            font-weight: 600;
            color: #22c55e;
            margin-bottom: 10px;
        }
        .exercise-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }
        .exercise-name {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }
        .exercise-details {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 6px;
        }
        .exercise-recommendation {
            font-size: 13px;
            color: #60a5fa;
            font-style: italic;
        }

        /* Overall recommendation */
        .overall-recommendation {
            background: rgba(251,191,36,0.1);
            border: 1px solid rgba(251,191,36,0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .recommendation-title {
            font-size: 15px;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 8px;
        }
        .overall-recommendation > div:last-child {
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* Heart Rate Inputs */
        .hr-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .hr-input-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .hr-input-item .input-field {
            width: 100%;
        }

        .hr-label {
            font-size: 11px;
            color: #64748b;
        }

        /* HR Zones Grid */
        .hr-zones-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }

        .hr-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .zone-label {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .zone1 .zone-label { background: rgba(156,163,175,0.3); color: #9ca3af; }
        .zone2 .zone-label { background: rgba(52,211,153,0.3); color: #34d399; }
        .zone3 .zone-label { background: rgba(251,191,36,0.3); color: #fbbf24; }
        .zone4 .zone-label { background: rgba(251,146,60,0.3); color: #fb923c; }
        .zone5 .zone-label { background: rgba(239,68,68,0.3); color: #ef4444; }

        .zone-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            color: #fff;
        }

        .zone-input:focus {
            outline: none;
            border-color: rgba(59,130,246,0.5);
        }

        /* ========== TRENDS STYLES ========== */
        .chart-container {
            position: relative;
            width: 100%;
            margin: 12px 0;
        }
        
        .chart-container canvas {
            width: 100% !important;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #94a3b8;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .chart-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        
        .chart-stat {
            text-align: center;
        }
        
        .chart-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }
        
        .chart-stat-value.good { color: #10b981; }
        .chart-stat-value.warning { color: #fbbf24; }
        .chart-stat-value.bad { color: #ef4444; }
        
        .chart-stat-label {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }
        
        .trends-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .trends-summary-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }
        
        .trends-summary-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .trends-summary-value {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            margin-top: 4px;
        }
        
        .no-data-message {
            text-align: center;
            padding: 30px;
            color: #64748b;
            font-size: 14px;
        }
        
        /* Oura data grid */
        .oura-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .oura-data-item {
            background: rgba(139,92,246,0.1);
            border: 1px solid rgba(139,92,246,0.2);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        
        .oura-data-value {
            font-size: 20px;
            font-weight: 700;
            color: #a78bfa;
        }
        
        .oura-data-value.good { color: #10b981; }
        .oura-data-value.warning { color: #fbbf24; }
        .oura-data-value.bad { color: #ef4444; }
        
        .oura-data-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .oura-import-success {
            background: rgba(16,185,129,0.1);
            border: 1px solid rgba(16,185,129,0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
            text-align: center;
            color: #10b981;
            font-size: 13px;
        }
        
        /* Date navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .date-nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            color: #e2e8f0;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .date-nav-btn:hover { background: rgba(255,255,255,0.2); }
        .date-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .date-nav-center {
            text-align: center;
        }
        
        .date-nav-label {
            font-size: 12px;
            color: #10b981;
            font-weight: 600;
            margin-top: 2px;
        }
        
        .date-nav-label.past {
            color: #94a3b8;
        }

        /* Report Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header h3 {
            margin: 0;
            font-size: 16px;
            color: #f1f5f9;
        }
        .modal-close {
            background: none;
            border: none;
            color: #64748b;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
        }
        .report-preview {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-word;
            color: #cbd5e1;
            background: rgba(0,0,0,0.2);
            line-height: 1.5;
        }
        .modal-actions {
            display: flex;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .modal-actions .btn {
            flex: 1;
            padding: 12px;
            font-size: 13px;
        }
        .report-modal {
            max-height: 85vh;
        }
    </style>
</head>
<body>
    <button class="settings-btn" id="settingsBtn" onclick="showSettings()"></button>
    
    <div class="sync-status synced" id="syncStatus">
        <span id="syncIcon"></span>
        <span id="syncText"></span>
    </div>

    <div class="container">
        <!-- Loading -->
        <div id="loadingScreen" class="loading">
            <div class="spinner"></div>
            <div class="loading-text">...</div>
        </div>
        
        <!-- Setup Screen -->
        <div id="setupScreen" class="hidden">
            <div class="header">
                <div class="header-title">  AI</div>
                <div class="header-subtitle"> API  OpenRouter</div>
            </div>
            <div class="card">
                <div class="card-title">API </div>
                <div class="input-group">
                    <input type="password" class="input-field" id="apiKeyInput" placeholder="sk-or-v1-...">
                    <div class="input-hint">   </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveApiKey()"></button>
            <button class="btn btn-secondary" onclick="skipApiKey()"> AI</button>
        </div>
        
        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden">
            <div class="header">
                <div class="header-title"> </div>
            </div>
            
            <!-- OpenRouter API -->
            <div class="card">
                <div class="card-title"> OpenRouter API (AI)</div>
                <div class="key-status" id="keyStatus">
                    <span class="key-status-icon" id="keyStatusIcon"></span>
                    <span class="key-status-text" id="keyStatusText"> </span>
                </div>
                <div class="input-group">
                    <input type="password" class="input-field" id="apiKeyEdit" placeholder="sk-or-v1-...">
                </div>
                <button class="btn btn-secondary" onclick="updateApiKey()"></button>
                <button class="btn btn-danger" onclick="deleteApiKey()"></button>
            </div>
            
            <!-- Oura API -->
            <div class="card">
                <div class="card-title"> Oura Ring API</div>
                <div class="key-status" id="ouraKeyStatus">
                    <span class="key-status-icon" id="ouraKeyStatusIcon"></span>
                    <span class="key-status-text" id="ouraKeyStatusText"> </span>
                </div>
                <div class="input-group">
                    <input type="password" class="input-field" id="ouraKeyEdit" placeholder="Oura Personal Access Token...">
                    <div class="input-hint">
                        <a href="https://cloud.ouraring.com/personal-access-tokens" target="_blank" style="color: #60a5fa;">  </a>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="updateOuraKey()"> Oura</button>
                <button class="btn btn-danger" onclick="deleteOuraKey()"></button>
            </div>


            <!-- AI Memory -->
            <div class="card">
                <div class="card-title">  AI</div>
                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 12px;">
                    AI          .
                    <br>   : <code style="background: #334155; padding: 2px 6px; border-radius: 4px;">: </code>
                </div>
                <div id="memoryList" style="max-height: 300px; overflow-y: auto;"></div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <input type="text" class="input-field" id="newMemoryInput" placeholder=" ..." style="flex: 1;">
                    <button class="btn btn-secondary btn-small" onclick="addMemoryFromInput()">+</button>
                </div>
                <div style="margin-top: 8px;">
                    <button class="btn btn-small" onclick="renderMemoryList()" style="font-size: 12px;"> </button>
                    <span id="memoryCount" style="font-size: 12px; color: #64748b; margin-left: 8px;"></span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="closeSettings()" style="margin-top: 20px;"> </button>
        </div>
        
        <!-- Morning Screen -->
        <div id="morningScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="morningDate"></div>
                <div class="header-title">  -</div>
            </div>
            
            <!-- Oura Import Button -->
            <div id="ouraImportSection" class="card hidden">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 32px;"></span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #e2e8f0;">Oura Ring</div>
                        <div style="font-size: 12px; color: #64748b;" id="ouraImportStatus"></div>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="importFromOura()" id="ouraImportBtn">
                         
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title"> Oura Readiness</div>
                <div class="input-row">
                    <input type="number" class="input-field center" id="ouraReadiness" placeholder="78" min="0" max="100">
                    <span class="input-unit"> 100</span>
                </div>
            </div>
            
            <!-- Sleep data from Oura -->
            <div class="card" id="sleepDataCard">
                <div class="card-title">  ( Oura)</div>
                <div class="oura-data-grid">
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraSleepDuration"></div>
                        <div class="oura-data-label"></div>
                    </div>
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraSleepEfficiency"></div>
                        <div class="oura-data-label"></div>
                    </div>
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraHRV"></div>
                        <div class="oura-data-label">HRV ()</div>
                    </div>
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraRestingHR"></div>
                        <div class="oura-data-label"> </div>
                    </div>
                    <div class="oura-data-item">
                        <div class="oura-data-value" id="ouraSpO2"></div>
                        <div class="oura-data-label">SpO2 (%)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">    <span class="optional-hint">()</span></div>
                <div class="input-group">
                    <div class="input-row">
                        <input type="number" class="input-field center" id="bpSystolic" placeholder="125" min="80" max="200">
                        <span class="input-separator">/</span>
                        <input type="number" class="input-field center" id="bpDiastolic" placeholder="82" min="50" max="130">
                    </div>
                </div>
                <div class="input-row">
                    <input type="number" class="input-field center" id="pulse" placeholder="65" min="40" max="150">
                    <span class="input-unit">/</span>
                </div>
            </div>
            
            <!-- Weight -->
            <div class="card">
                <div class="card-title">  <span class="optional-hint">()</span></div>
                <div class="input-row">
                    <input type="number" class="input-field center" id="morningWeight" placeholder="85.5" min="30" max="300" step="0.1">
                    <span class="input-unit"></span>
                </div>
                <div class="weight-change" id="weightChange"></div>
                <div class="edema-warning hidden" id="edemaWarning">
                    <div class="edema-title">  </div>
                    <div class="edema-text" id="edemaText"></div>
                </div>
            </div>

            <div class="card">
                <div class="toggle-row" onclick="toggleEliteHRV()">
                    <span class="toggle-label"> EliteHRV</span>
                    <div class="toggle" id="eliteToggle"></div>
                </div>
                <div id="eliteFields" class="hidden" style="margin-top: 12px;">
                    <div class="input-row">
                        <input type="number" class="input-field center" id="eliteScore" placeholder="7" min="1" max="10">
                        <span class="input-unit"> 10</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeMorning()">   AI</button>
            
            <div id="chatContainer" class="chat-container hidden">
                <div class="chat-header">
                    <div class="chat-avatar"></div>
                    <div class="chat-info">
                        <div class="chat-name">AI-</div>
                        <div class="chat-status" id="chatStatus"></div>
                    </div>
                    <div id="dayBadge" class="day-badge normal"></div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="askQuestion('   ?')"> </button>
                    <button class="quick-btn" onclick="askQuestion('  ?')"> </button>
                    <button class="quick-btn" onclick="askQuestion(' ?')"> </button>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder=" ..." onkeypress="handleChatKeypress(event)">
                    <button class="chat-send" onclick="sendChatMessage()"></button>
                </div>
            </div>
            
            <button class="btn btn-primary hidden" id="startDayBtn" onclick="startDay()" style="margin-top: 16px;">  </button>
        </div>
        
        <!-- Main Screen -->
        <div id="mainScreen" class="hidden">
            <div class="header">
                <!--    -->
                <div class="date-nav">
                    <button class="date-nav-btn" onclick="changeDay(-1)" id="prevDayBtn"></button>
                    <div class="date-nav-center">
                        <div class="header-date" id="mainDate"></div>
                        <div class="date-nav-label" id="dayLabel"></div>
                    </div>
                    <button class="date-nav-btn" onclick="changeDay(1)" id="nextDayBtn"></button>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span class="header-title">Life Tracker</span>
                    <div id="mainBadge" class="day-badge normal"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>  </span>
                    <button class="btn btn-secondary btn-small" onclick="editMorning()" style="padding: 6px 12px; font-size: 12px;"> </button>
                </div>
                <div class="morning-data">
                    <span class="morning-data-label">Oura Readiness</span>
                    <span class="morning-data-value" id="sumOura"></span>
                </div>
                <div class="morning-data">
                    <span class="morning-data-label"></span>
                    <span class="morning-data-value" id="sumBP"></span>
                </div>
                <div class="morning-data">
                    <span class="morning-data-label"></span>
                    <span class="morning-data-value" id="sumPulse"></span>
                </div>
                <div class="morning-data" id="weightRow" style="display: none;">
                    <span class="morning-data-label"></span>
                    <span class="morning-data-value" id="sumWeight"></span>
                </div>
            </div>

            <!-- AI BP Prediction -->
            <div class="card ai-prediction-card" id="bpPredictionCard">
                <div class="card-title"> AI  </div>
                <div id="bpPrediction" class="ai-prediction-content">
                    <div class="ai-prediction-loading"> ...</div>
                </div>
            </div>

            <div class="life-counter">
                <div class="life-stats">
                    <div>
                        <div class="life-stat-number" id="daysLived">17 804</div>
                        <div class="life-stat-label"></div>
                    </div>
                    <div>
                        <div class="life-stat-number yellow" id="daysToPension">5 937</div>
                        <div class="life-stat-label"> </div>
                    </div>
                    <div>
                        <div class="life-stat-number green" id="daysToGoal">15 068</div>
                        <div class="life-stat-label"> 90 </div>
                    </div>
                </div>
            </div>
            
            <div class="system-status" id="systemStatus">
                <div class="system-icon" id="systemIcon"></div>
                <div class="system-info">
                    <div class="system-title" id="systemTitle"> </div>
                    <div class="system-subtitle" id="systemSubtitle">: 3  3</div>
                </div>
                <div class="streak-badge" id="streakBadge"> 0</div>
            </div>
            
            <div id="habitsContainer"></div>
            
            <div class="reminders">
                <div class="reminders-title"> </div>
                <div class="reminder-item"><span></span><span>   </span></div>
                <div class="reminder-item"><span></span><span> 150 ,  14:00</span></div>
                <div class="reminder-item"><span></span><span> 5 </span></div>
            </div>
            
            <div class="chat-container" id="mainChatContainer">
                <div class="chat-header" onclick="toggleMainChat()">
                    <div class="chat-avatar"></div>
                    <div class="chat-info">
                        <div class="chat-name"> AI</div>
                        <div class="chat-status"> </div>
                    </div>
                    <span id="chatToggleIcon"></span>
                </div>
                <div id="mainChatBody" class="hidden">
                    <div class="chat-messages" id="mainChatMessages"></div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="askMainQuestion('  ?')"> </button>
                        <button class="quick-btn" onclick="askMainQuestion('  ?')"> </button>
                        <button class="quick-btn" onclick="askMainQuestion('  ?')"> </button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="mainChatInput" placeholder="..." onkeypress="handleMainChatKeypress(event)">
                        <button class="chat-send" onclick="sendMainChatMessage()"></button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== NUTRITION SCREEN ========== -->
        <div id="nutritionScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="nutritionDate"></div>
                <div class="header-title"> </div>
            </div>
            
            <!-- Calories summary -->
            <div class="nutrition-summary">
                <div class="nutrition-card calories">
                    <div class="nutrition-value" id="caloriesValue">0</div>
                    <div class="nutrition-label"> 2100 </div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="caloriesBar" style="width: 0%"></div>
                    </div>
                    <div class="nutrition-remaining" id="caloriesRemaining">: 2100 </div>
                </div>

                <div class="nutrition-card">
                    <div class="nutrition-value" id="proteinValue">0</div>
                    <div class="nutrition-label"> (200)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="proteinBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="nutrition-card">
                    <div class="nutrition-value" id="fatValue">0</div>
                    <div class="nutrition-label"> (65)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="fatBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="nutrition-card">
                    <div class="nutrition-value" id="carbsValue">0</div>
                    <div class="nutrition-label"> (135)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="carbsBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="nutrition-card">
                    <div class="nutrition-value" id="fiberValue">0</div>
                    <div class="nutrition-label"> (30)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="fiberBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="nutrition-card salt-card">
                    <div class="nutrition-value" id="saltValue">0</div>
                    <div class="nutrition-label">  (5)</div>
                    <div class="nutrition-progress">
                        <div class="nutrition-progress-bar good" id="saltBar" style="width: 0%"></div>
                    </div>
                    <div class="nutrition-remaining salt-warning" id="saltRemaining"></div>
                </div>
            </div>
            
            <!-- Add food -->
            <div class="card">
                <div class="card-title">  </div>

                <!-- Multi-photo upload -->
                <input type="file" id="foodCameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleFoodPhotoSelect(event)">
                <input type="file" id="foodGalleryInput" accept="image/*" multiple style="display: none;" onchange="handleFoodPhotoSelect(event)">

                <div id="foodPhotoUploadArea">
                    <div class="photo-buttons">
                        <div class="photo-btn" onclick="document.getElementById('foodCameraInput').click()">
                            <div class="photo-btn-icon"></div>
                            <div class="photo-btn-text"></div>
                        </div>
                        <div class="photo-btn" onclick="document.getElementById('foodGalleryInput').click()">
                            <div class="photo-btn-icon"></div>
                            <div class="photo-btn-text"></div>
                        </div>
                    </div>
                    <div class="photo-hint">    ( 5 )</div>
                </div>

                <!-- Photo previews -->
                <div id="foodPhotosPreview" class="multi-photo-preview hidden"></div>

                <!-- Text input (always visible, context for photo OR standalone) -->
                <div class="food-input-section">
                    <div class="food-input-label" id="foodInputLabel">   :</div>
                    <div class="food-input-row">
                        <input type="text" class="food-input" id="foodTextInput" placeholder=", , ..." onkeypress="handleFoodKeypress(event)">
                    </div>
                    <div class="input-hint" id="foodInputHint">: " 300,  50"  "  200   150"</div>
                </div>

                <!-- Single analyze button -->
                <button class="btn btn-primary btn-large" id="analyzeFoodBtn" onclick="analyzeFood()" style="margin-top: 12px;">
                     
                </button>
            </div>

            <!-- AI analyzing -->
            <div id="foodAnalyzing" class="card hidden">
                <div class="loading" style="padding: 20px;">
                    <div class="spinner"></div>
                    <div class="loading-text" id="foodAnalyzingText">AI ...</div>
                </div>
            </div>
            
            <!-- Food log -->
            <div class="card">
                <div class="card-title">  </div>
                <div id="foodLogContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-text">   </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed table -->
            <div class="card">
                <div class="card-title">  </div>
                <div class="nutrition-table">
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label"></span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">2100</span>
                            <span class="nutrition-table-fact" id="tableCalories">0</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label"></span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">200</span>
                            <span class="nutrition-table-fact" id="tableProtein">0</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label"></span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">65</span>
                            <span class="nutrition-table-fact" id="tableFat">0</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label"></span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">135</span>
                            <span class="nutrition-table-fact" id="tableCarbs">0</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label"></span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">30</span>
                            <span class="nutrition-table-fact" id="tableFiber">0</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label"></span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">5</span>
                            <span class="nutrition-table-fact" id="tableSalt">0</span>
                        </div>
                    </div>
                    <div class="nutrition-table-row">
                        <span class="nutrition-table-label"></span>
                        <div class="nutrition-table-values">
                            <span class="nutrition-table-plan">150</span>
                            <span class="nutrition-table-fact" id="tableCaffeine">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Tips -->
            <div class="chat-container">
                <div class="chat-header" onclick="toggleNutritionChat()">
                    <div class="chat-avatar"></div>
                    <div class="chat-info">
                        <div class="chat-name">AI-  </div>
                        <div class="chat-status">  ?</div>
                    </div>
                    <span id="nutritionChatToggle"></span>
                </div>
                <div id="nutritionChatBody" class="hidden">
                    <div class="chat-messages" id="nutritionChatMessages"></div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="askNutritionQuestion('  ?')">   </button>
                        <button class="quick-btn" onclick="askNutritionQuestion('  ')"> </button>
                        <button class="quick-btn" onclick="askNutritionQuestion('  ?')"> </button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="nutritionChatInput" placeholder="  ..." onkeypress="handleNutritionChatKeypress(event)">
                        <button class="chat-send" onclick="sendNutritionChatMessage()"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== WORKOUTS SCREEN ========== -->
        <div id="workoutsScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="workoutsDate"></div>
                <div class="header-title"> </div>
            </div>

            <!-- Add workout -->
            <div class="card">
                <div class="card-title">  </div>

                <!-- Step 1: Screenshots upload -->
                <div id="workoutStep1">
                    <div class="input-label">    - ( 5)</div>
                    <input type="file" id="workoutPhotosInput" accept="image/*" multiple style="display: none;" onchange="handleWorkoutPhotos(event)">

                    <div class="photo-buttons">
                        <div class="photo-btn" onclick="document.getElementById('workoutPhotosInput').click()">
                            <div class="photo-btn-icon"></div>
                            <div class="photo-btn-text"> </div>
                        </div>
                    </div>

                    <!-- Photos preview -->
                    <div id="workoutPhotosPreview" class="workout-photos-grid hidden"></div>

                    <div class="photo-hint">AI  , ,   </div>

                    <button class="btn btn-primary" onclick="analyzeWorkoutPhotos()" id="analyzePhotosBtn" disabled>
                          
                    </button>

                    <div style="text-align: center; color: #64748b; margin: 16px 0 12px; font-size: 13px;">  </div>

                    <button class="btn btn-secondary" onclick="showManualWorkoutForm()">
                          
                    </button>
                </div>

                <!-- Step 2: AI analyzing -->
                <div id="workoutStep2" class="hidden">
                    <div class="loading" style="padding: 20px;">
                        <div class="spinner"></div>
                        <div class="loading-text" id="analyzeStatus">AI  ...</div>
                    </div>
                </div>

                <!-- Step 3: Form with AI-filled data -->
                <div id="workoutStep3" class="workout-form hidden">
                    <!-- Type (auto-selected or manual) -->
                    <div class="input-group">
                        <label class="input-label"> :</label>
                        <div class="workout-type-grid">
                            <div class="workout-type-btn strength" data-type="strength" onclick="selectWorkoutType('strength')">
                                <div class="workout-type-icon"></div>
                                <div class="workout-type-name"></div>
                            </div>
                            <div class="workout-type-btn rowing" data-type="rowing" onclick="selectWorkoutType('rowing')">
                                <div class="workout-type-icon"></div>
                                <div class="workout-type-name"></div>
                            </div>
                            <div class="workout-type-btn walking" data-type="walking" onclick="selectWorkoutType('walking')">
                                <div class="workout-type-icon"></div>
                                <div class="workout-type-name"></div>
                            </div>
                            <div class="workout-type-btn stretch" data-type="stretch" onclick="selectWorkoutType('stretch')">
                                <div class="workout-type-icon"></div>
                                <div class="workout-type-name"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Duration -->
                    <div class="input-group">
                        <label class="input-label">:</label>
                        <div class="input-row">
                            <input type="number" class="input-field center" id="workoutDuration" placeholder="45" min="1" max="300">
                            <span class="input-unit"></span>
                        </div>
                    </div>

                    <!-- Distance -->
                    <div class="input-group" id="distanceGroup" style="display: none;">
                        <label class="input-label"> :</label>
                        <div class="input-row">
                            <input type="number" class="input-field center" id="workoutDistance" placeholder="2000" min="0" max="50000">
                            <span class="input-unit"></span>
                        </div>
                    </div>

                    <!-- Pace (for rowing/walking) -->
                    <div class="input-group" id="paceGroup" style="display: none;">
                        <label class="input-label"> :</label>
                        <div class="input-row">
                            <input type="text" class="input-field center" id="workoutPace" placeholder="2:30">
                            <span class="input-unit" id="paceUnit">/500</span>
                        </div>
                    </div>

                    <!-- Power (for rowing) -->
                    <div class="input-group" id="powerGroup" style="display: none;">
                        <label class="input-label"> :</label>
                        <div class="input-row">
                            <input type="number" class="input-field center" id="workoutPower" placeholder="150" min="0" max="500">
                            <span class="input-unit"></span>
                        </div>
                    </div>

                    <!-- Stroke Rate (for rowing) -->
                    <div class="input-group" id="strokeRateGroup" style="display: none;">
                        <label class="input-label">  :</label>
                        <div class="input-row">
                            <input type="number" class="input-field center" id="workoutStrokeRate" placeholder="24" min="0" max="50">
                            <span class="input-unit">/</span>
                        </div>
                    </div>

                    <!-- Heart Rate -->
                    <div class="input-group">
                        <label class="input-label"> :</label>
                        <div class="hr-inputs">
                            <div class="hr-input-item">
                                <input type="number" class="input-field center" id="workoutAvgHR" placeholder="135" min="40" max="220">
                                <span class="hr-label"></span>
                            </div>
                            <div class="hr-input-item">
                                <input type="number" class="input-field center" id="workoutMaxHR" placeholder="165" min="40" max="220">
                                <span class="hr-label"></span>
                            </div>
                        </div>
                    </div>

                    <!-- HR Zones -->
                    <div class="input-group" id="hrZonesGroup">
                        <label class="input-label">   ():</label>
                        <div class="hr-zones-grid">
                            <div class="hr-zone zone1">
                                <span class="zone-label">Z1</span>
                                <input type="number" class="zone-input" id="workoutZone1" placeholder="0" min="0">
                            </div>
                            <div class="hr-zone zone2">
                                <span class="zone-label">Z2</span>
                                <input type="number" class="zone-input" id="workoutZone2" placeholder="0" min="0">
                            </div>
                            <div class="hr-zone zone3">
                                <span class="zone-label">Z3</span>
                                <input type="number" class="zone-input" id="workoutZone3" placeholder="0" min="0">
                            </div>
                            <div class="hr-zone zone4">
                                <span class="zone-label">Z4</span>
                                <input type="number" class="zone-input" id="workoutZone4" placeholder="0" min="0">
                            </div>
                            <div class="hr-zone zone5">
                                <span class="zone-label">Z5</span>
                                <input type="number" class="zone-input" id="workoutZone5" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Calories -->
                    <div class="input-group">
                        <label class="input-label"> :</label>
                        <div class="input-row">
                            <input type="number" class="input-field center" id="workoutCalories" placeholder="350" min="0" max="2000">
                            <span class="input-unit"></span>
                        </div>
                    </div>

                    <!-- Feeling -->
                    <div class="input-group">
                        <label class="input-label"> ?</label>
                        <div class="feeling-selector">
                            <button class="feeling-btn hard" data-feeling="hard" onclick="selectFeeling('hard')"> </button>
                            <button class="feeling-btn normal selected" data-feeling="normal" onclick="selectFeeling('normal')"> </button>
                            <button class="feeling-btn easy" data-feeling="easy" onclick="selectFeeling('easy')"> </button>
                        </div>
                    </div>

                    <!-- AI notes -->
                    <div id="aiNotesContainer" class="ai-notes hidden">
                        <div class="ai-notes-title"> AI :</div>
                        <div id="aiNotes"></div>
                    </div>

                    <!-- Exercises list -->
                    <div id="exercisesContainer" class="exercises-container hidden">
                        <div class="exercises-title"> :</div>
                        <div id="exercisesList"></div>
                    </div>

                    <!-- Overall recommendation -->
                    <div id="overallRecommendationContainer" class="overall-recommendation hidden">
                        <div class="recommendation-title"> :</div>
                        <div id="overallRecommendation"></div>
                    </div>

                    <button class="btn btn-primary" onclick="saveWorkout()" id="saveWorkoutBtn">
                          
                    </button>

                    <button class="btn btn-secondary" onclick="resetWorkoutForm()" style="margin-top: 8px;">
                         
                    </button>
                </div>
            </div>

            <!-- Week calendar -->
            <div class="card">
                <div class="card-title">
                    <span>  </span>
                    <span class="week-progress" id="weekProgress">0/4</span>
                </div>
                <div class="week-calendar" id="weekCalendar">
                    <!--   JS -->
                </div>
            </div>

            <!-- Workout history -->
            <div class="card">
                <div class="card-title"> </div>
                <div id="workoutHistoryContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-text">  </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="card ai-insights-card">
                <div class="card-title">  </div>
                <div id="workoutInsights" class="ai-insights-content">
                    <div class="ai-insights-loading">   </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="openWorkoutChat()" style="margin-top: 12px;">
                      AI 
                </button>
            </div>

            <!-- AI Chat (hidden by default) -->
            <div class="chat-container hidden" id="workoutChatContainer">
                <div class="chat-header" onclick="toggleWorkoutChat()">
                    <div class="chat-avatar"></div>
                    <div class="chat-info">
                        <div class="chat-name">AI-</div>
                        <div class="chat-status"></div>
                    </div>
                    <span id="workoutChatToggle"></span>
                </div>
                <div id="workoutChatBody">
                    <div class="chat-messages" id="workoutChatMessages"></div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="askWorkoutQuestion('  ?')">  </button>
                        <button class="quick-btn" onclick="askWorkoutQuestion('  ')"> </button>
                        <button class="quick-btn" onclick="askWorkoutQuestion(' ?')"> </button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="workoutChatInput" placeholder="  ..." onkeypress="handleWorkoutChatKeypress(event)">
                        <button class="chat-send" onclick="sendWorkoutChatMessage()"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== EVENING SCREEN ========== -->
        <div id="eveningScreen" class="hidden">
            <div class="header">
                <div class="header-date" id="eveningDate"></div>
                <div class="header-title">  </div>
            </div>

            <!-- Evening BP -->
            <div class="card">
                <div class="card-title">  </div>
                <div class="input-group">
                    <div class="input-row">
                        <input type="number" class="input-field center" id="eveningBpSystolic" placeholder="120" min="80" max="200">
                        <span class="input-separator">/</span>
                        <input type="number" class="input-field center" id="eveningBpDiastolic" placeholder="80" min="50" max="130">
                    </div>
                </div>
                <div class="input-row">
                    <input type="number" class="input-field center" id="eveningPulse" placeholder="62" min="40" max="150">
                    <span class="input-unit">/</span>
                </div>
                <button class="btn btn-secondary" onclick="saveEveningBP()" style="margin-top: 12px;"> </button>
            </div>
            
            <!-- BP comparison -->
            <div class="card" id="bpComparisonCard">
                <div class="card-title">  </div>
                <div class="bp-comparison">
                    <div class="bp-comparison-item">
                        <div class="bp-comparison-label"> </div>
                        <div class="bp-comparison-value" id="morningBpValue"></div>
                    </div>
                    <div class="bp-comparison-arrow"></div>
                    <div class="bp-comparison-item">
                        <div class="bp-comparison-label"> </div>
                        <div class="bp-comparison-value" id="eveningBpValue"></div>
                    </div>
                </div>
                <div class="bp-change-badge" id="bpChangeValue"></div>
            </div>
            
            <!-- Breathing sessions -->
            <div class="card">
                <div class="card-title">  </div>
                
                <!-- Add breathing session -->
                <div class="breathing-add">
                    <div class="input-group">
                        <label class="input-label"> </label>
                        <select class="input-field" id="breathingType">
                            <option value="resonance"> (6 /)</option>
                            <option value="478">4-7-8 </option>
                            <option value="box"> </option>
                            <option value="other"></option>
                        </select>
                    </div>
                    <div class="input-row" style="margin-bottom: 12px;">
                        <div class="input-group" style="flex: 1; margin-bottom: 0;">
                            <label class="input-label"></label>
                            <div class="input-row">
                                <input type="number" class="input-field center" id="breathingDuration" placeholder="5" min="1" max="60">
                                <span class="input-unit"></span>
                            </div>
                        </div>
                        <div class="input-group" style="flex: 1; margin-bottom: 0;">
                            <label class="input-label">RMSSD </label>
                            <div class="input-row">
                                <input type="number" class="input-field center" id="breathingRmssd" placeholder="45">
                                <span class="input-unit"></span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="addBreathingSession()">  </button>
                </div>
                
                <!-- Breathing log -->
                <div id="breathingLogContainer" style="margin-top: 16px;"></div>
            </div>
            
            <!-- Day summary -->
            <div class="card">
                <div class="card-title">  </div>
                <div class="day-summary">
                    <div class="day-summary-row">
                        <span class="day-summary-label"> </span>
                        <span class="day-summary-value" id="summaryDayType"></span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label"></span>
                        <span class="day-summary-value" id="summaryHabits"></span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label"> </span>
                        <span class="day-summary-value" id="summaryCalories"></span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label"> </span>
                        <span class="day-summary-value" id="summaryProtein"></span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label"> </span>
                        <span class="day-summary-value" id="summaryWorkouts"></span>
                    </div>
                    <div class="day-summary-row">
                        <span class="day-summary-label"> </span>
                        <span class="day-summary-value" id="summaryBreathing"></span>
                    </div>
                </div>
            </div>

            <!-- Nutrition feedback -->
            <div class="card">
                <div class="card-title">    </div>

                <!-- How was eating today -->
                <div class="feedback-section">
                    <div class="feedback-label">  ?</div>
                    <div class="feedback-buttons" id="nutritionFeelingBtns">
                        <button class="feedback-btn" data-value="overate" onclick="setNutritionFeeling('overate')"> </button>
                        <button class="feedback-btn" data-value="normal" onclick="setNutritionFeeling('normal')">  </button>
                        <button class="feedback-btn" data-value="underate" onclick="setNutritionFeeling('underate')"> </button>
                    </div>
                </div>

                <!-- Was everything logged -->
                <div class="feedback-section" style="margin-top: 16px;">
                    <div class="feedback-label">  ?</div>
                    <div class="feedback-buttons" id="nutritionLoggedBtns">
                        <button class="feedback-btn" data-value="yes" onclick="setNutritionLogged(true)"> </button>
                        <button class="feedback-btn" data-value="no" onclick="setNutritionLogged(false)"> </button>
                    </div>
                </div>

                <!-- Missed food input (hidden by default) -->
                <div id="missedFoodSection" class="hidden" style="margin-top: 16px;">
                    <div class="feedback-label">  ?</div>
                    <textarea class="input-field" id="missedFoodInput" placeholder=":    ,  2   ..." rows="3" style="width: 100%; resize: none;"></textarea>
                    <button class="btn btn-secondary" onclick="analyzeMissedFood()" id="analyzeMissedBtn" style="margin-top: 8px;">
                          AI
                    </button>
                    <div id="missedFoodResult" class="hidden" style="margin-top: 12px;"></div>
                </div>

                <!-- Feedback saved indicator -->
                <div id="nutritionFeedbackSaved" class="feedback-saved hidden">
                     
                </div>
            </div>

            <!-- Get AI analysis -->
            <button class="btn btn-primary" id="getEveningAnalysis" onclick="getEveningAnalysis()">
                  AI- 
            </button>
            
            <!-- AI Analysis result -->
            <div id="eveningAnalysisResult" class="hidden">
                <div class="chat-container" style="margin-top: 16px;">
                    <div class="chat-header">
                        <div class="chat-avatar"></div>
                        <div class="chat-info">
                            <div class="chat-name"> </div>
                            <div class="chat-status" id="eveningChatStatus"></div>
                        </div>
                    </div>
                    <div class="chat-messages" id="eveningChatMessages"></div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="askEveningQuestion('  ?')"> </button>
                        <button class="quick-btn" onclick="askEveningQuestion('  ?')"> </button>
                        <button class="quick-btn" onclick="askEveningQuestion('  ')"> </button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="eveningChatInput" placeholder="  ..." onkeypress="handleEveningChatKeypress(event)">
                        <button class="chat-send" onclick="sendEveningChatMessage()"></button>
                    </div>
                </div>
            </div>
            
            <!-- Day rating -->
            <div class="card" style="margin-top: 16px;">
                <div class="card-title">  </div>
                <div class="day-rating" id="dayRating">
                    <button class="rating-btn" data-rating="1" onclick="rateDay(1)"></button>
                    <button class="rating-btn" data-rating="2" onclick="rateDay(2)"></button>
                    <button class="rating-btn" data-rating="3" onclick="rateDay(3)"></button>
                    <button class="rating-btn" data-rating="4" onclick="rateDay(4)"></button>
                    <button class="rating-btn" data-rating="5" onclick="rateDay(5)"></button>
                </div>
                <div class="day-rating-label" id="dayRatingLabel">  ?</div>
            </div>
            
            <!-- Sleep prep -->
            <div class="card">
                <div class="card-title">   </div>
                <div class="sleep-checklist" id="sleepChecklist">
                    <div class="sleep-item" data-id="no_screens" onclick="toggleSleepItem('no_screens')">
                        <div class="checkbox"><span class="checkbox-mark"></span></div>
                        <span>   30 </span>
                    </div>
                    <div class="sleep-item" data-id="no_caffeine" onclick="toggleSleepItem('no_caffeine')">
                        <div class="checkbox"><span class="checkbox-mark"></span></div>
                        <span>   14:00</span>
                    </div>
                    <div class="sleep-item" data-id="breathing_evening" onclick="toggleSleepItem('breathing_evening')">
                        <div class="checkbox"><span class="checkbox-mark"></span></div>
                        <span>  4-7-8</span>
                    </div>
                    <div class="sleep-item" data-id="room_ready" onclick="toggleSleepItem('room_ready')">
                        <div class="checkbox"><span class="checkbox-mark"></span></div>
                        <span> , </span>
                    </div>
                </div>
            </div>

            <!-- End Day Button -->
            <div class="end-day-section">
                <div class="end-day-time" id="endDayTime"></div>
                <button class="btn btn-end-day" id="endDayBtn" onclick="endDay()">
                      
                </button>
                <div class="end-day-hint">       </div>
            </div>

            <!-- Day completed message -->
            <div id="dayCompletedMessage" class="hidden">
                <div class="day-completed-card">
                    <div class="day-completed-icon"></div>
                    <div class="day-completed-title"> !</div>
                    <div class="day-completed-text"> !   </div>
                    <div class="day-completed-stats" id="completedDayStats"></div>
                    <button class="btn btn-undo-day" onclick="undoEndDay()">
                          
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== TRENDS SCREEN ========== -->
        <div id="trendsScreen" class="hidden">
            <div class="header">
                <div class="header-title"> </div>
                <div class="header-subtitle">   </div>
            </div>
            
            <!-- Period selector -->
            <div class="tabs" style="margin-bottom: 16px;">
                <button class="tab active" data-period="7" onclick="setPeriod(7)">7 </button>
                <button class="tab" data-period="14" onclick="setPeriod(14)">14 </button>
                <button class="tab" data-period="30" onclick="setPeriod(30)">30 </button>
            </div>

            <!-- AI Correlations -->
            <div class="card ai-correlations-card">
                <div class="card-title"> AI </div>
                <div class="card-subtitle">    </div>

                <!-- Navigation -->
                <div class="correlation-nav" id="correlationNav" style="display: none;">
                    <button class="correlation-nav-btn" onclick="prevCorrelation()"></button>
                    <span class="correlation-counter" id="correlationCounter">1 / 3</span>
                    <button class="correlation-nav-btn" onclick="nextCorrelation()"></button>
                </div>

                <div id="aiCorrelations" class="ai-correlations-content">
                    <div class="correlation-loading"> ...</div>
                </div>

                <button class="btn btn-secondary btn-small" onclick="loadCorrelations(true)" style="margin-top: 12px;">
                      
                </button>
            </div>

            <!-- Weekly Report -->
            <div class="card weekly-report-card">
                <div class="card-title">  </div>
                <div class="card-subtitle" id="weeklyReportPeriod">   7 </div>
                <div id="weeklyReport" class="weekly-report-content">
                    <div class="report-loading">    </div>
                </div>
                <button class="btn btn-primary" onclick="generateWeeklyReport()" id="generateReportBtn">
                      
                </button>
            </div>

            <!-- BP Chart -->
            <div class="card">
                <div class="card-title">  </div>
                <div class="chart-container">
                    <canvas id="bpChart" height="180"></canvas>
                </div>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-color" style="background: #ef4444;"></span></span>
                    <span class="legend-item"><span class="legend-color" style="background: #3b82f6;"></span></span>
                </div>
                <div class="chart-stats" id="bpStats"></div>
            </div>
            
            <!-- Oura Chart -->
            <div class="card">
                <div class="card-title"> Oura Readiness</div>
                <div class="chart-container">
                    <canvas id="ouraChart" height="150"></canvas>
                </div>
                <div class="chart-stats" id="ouraStats"></div>
            </div>
            
            <!-- Nutrition Chart -->
            <div class="card">
                <div class="card-title"> </div>
                <div class="chart-container">
                    <canvas id="nutritionChart" height="150"></canvas>
                </div>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-color" style="background: #8b5cf6;"></span></span>
                    <span class="legend-item"><span class="legend-color" style="background: #10b981;"></span></span>
                </div>
                <div class="chart-stats" id="nutritionStats"></div>
            </div>
            
            <!-- Habits Chart -->
            <div class="card">
                <div class="card-title"> </div>
                <div class="chart-container">
                    <canvas id="habitsChart" height="120"></canvas>
                </div>
                <div class="chart-stats" id="habitsStats"></div>
            </div>
            
            <!-- Breathing Chart -->
            <div class="card">
                <div class="card-title"> </div>
                <div class="chart-container">
                    <canvas id="breathingChart" height="120"></canvas>
                </div>
                <div class="chart-stats" id="breathingStats"></div>
            </div>

            <!-- Workouts Chart -->
            <div class="card">
                <div class="card-title"> </div>
                <div class="chart-container">
                    <canvas id="workoutsChart" height="150"></canvas>
                </div>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-color" style="background: #f59e0b;"></span></span>
                    <span class="legend-item"><span class="legend-color" style="background: #ef4444;"></span></span>
                    <span class="legend-item"><span class="legend-color" style="background: #10b981;"></span></span>
                    <span class="legend-item"><span class="legend-color" style="background: #8b5cf6;"></span></span>
                </div>
                <div class="chart-stats" id="workoutsStats"></div>
            </div>

            <!-- Weight Chart -->
            <div class="card" id="weightChartCard" style="display: none;">
                <div class="card-title"> </div>
                <div class="chart-container">
                    <canvas id="weightChart" height="150"></canvas>
                </div>
                <div class="chart-stats" id="weightStats"></div>
            </div>

            <!-- HRV Chart -->
            <div class="card" id="hrvChartCard" style="display: none;">
                <div class="card-title"> HRV ()</div>
                <div class="chart-container">
                    <canvas id="hrvChart" height="150"></canvas>
                </div>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-color" style="background: #10b981;"></span>HRV ()</span>
                    <span class="legend-item"><span class="legend-color" style="background: #ef4444;"></span> </span>
                </div>
                <div class="chart-stats" id="hrvStats"></div>
            </div>

            <!-- Summary -->
            <div class="card">
                <div class="card-title">  </div>
                <div class="trends-summary">
                    <div class="trends-summary-item">
                        <div class="trends-summary-label">  </div>
                        <div class="trends-summary-value" id="summaryDaysInSystem">0</div>
                    </div>
                    <div class="trends-summary-item">
                        <div class="trends-summary-label"> streak</div>
                        <div class="trends-summary-value" id="summaryStreak"> 0</div>
                    </div>
                    <div class="trends-summary-item">
                        <div class="trends-summary-label"> </div>
                        <div class="trends-summary-value" id="summaryAvgBP"></div>
                    </div>
                    <div class="trends-summary-item">
                        <div class="trends-summary-label"> Oura</div>
                        <div class="trends-summary-value" id="summaryAvgOura"></div>
                    </div>
                    <div class="trends-summary-item">
                        <div class="trends-summary-label"></div>
                        <div class="trends-summary-value" id="summaryWorkouts"> 0</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateAndShowReport()" style="margin-top: 16px; width: 100%;">
                      
                </button>
                <div id="emailStatus" style="text-align: center; margin-top: 8px; font-size: 12px; color: #64748b;"></div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay hidden" id="reportModal">
        <div class="modal-content report-modal">
            <div class="modal-header">
                <h3>  Life Tracker</h3>
                <button class="modal-close" onclick="closeReportModal()"></button>
            </div>
            <div class="report-preview" id="reportPreview"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="copyReport()">
                     
                </button>
                <button class="btn btn-secondary" onclick="shareToTelegram()">
                     Telegram
                </button>
                <button class="btn btn-primary" onclick="openMailClient()">
                     Email
                </button>
            </div>
            <div id="reportActionStatus" style="text-align: center; margin-top: 8px; font-size: 12px; color: #10b981;"></div>
        </div>
    </div>
    
    <div class="bottom-nav hidden" id="bottomNav">
        <div class="nav-item active" data-screen="main" onclick="navigateTo('main')">
            <span class="nav-item-icon"></span>
            <span class="nav-item-label"></span>
        </div>
        <div class="nav-item" data-screen="nutrition" onclick="navigateTo('nutrition')">
            <span class="nav-item-icon"></span>
            <span class="nav-item-label"></span>
        </div>
        <div class="nav-item" data-screen="workouts" onclick="navigateTo('workouts')">
            <span class="nav-item-icon"></span>
            <span class="nav-item-label"></span>
        </div>
        <div class="nav-item" data-screen="trends" onclick="navigateTo('trends')">
            <span class="nav-item-icon"></span>
            <span class="nav-item-label"></span>
        </div>
        <div class="nav-item" data-screen="evening" onclick="navigateTo('evening')">
            <span class="nav-item-icon"></span>
            <span class="nav-item-label"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCq10f_AzUXLjsfWEQNRbTUGjBLy-u4hnI",
            authDomain: "life-tracker-54732.firebaseapp.com",
            databaseURL: "https://life-tracker-54732-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "life-tracker-54732",
            storageBucket: "life-tracker-54732.firebasestorage.app",
            messagingSenderId: "322679590707",
            appId: "1:322679590707:web:dee9c025719d986e987846"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const userRef = ref(database, 'users/sergey');
        
        // === CONFIG ===
        let API_KEY = localStorage.getItem('openrouter_api_key') || '';
        let OURA_KEY = localStorage.getItem('oura_api_key') || '';
        const AI_MODEL = 'google/gemini-2.5-flash';  // , reasoning, 66K output
        const VISION_MODEL = 'google/gemini-2.5-flash'; //    Gemini 2.5
        
        //  Cloudflare Worker  Oura API ( CORS)
        const OURA_PROXY = 'https://oura-proxy.skomisarov.workers.dev';

        // OpenRouter API URL
        const OPENROUTER_URL = 'https://openrouter.ai/api/v1/chat/completions';
        
        const BIRTH_DATE = new Date(1977, 3, 29);
        const PENSION_AGE = 65;
        const LIFE_GOAL = 90;
        
        //   (   )
        function getToday() { return new Date(); }
        // :   ,  UTC!
        function getDateKey(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        //      Date 
        function dateToKey(d) {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }
        
        let currentDate = new Date(); //   
        let userData = { days: {}, stats: {} };
        let todayData = null;
        let showElite = false;
        let chatHistory = [];
        let mainChatHistory = [];
        let nutritionChatHistory = [];
        let currentPhotoBase64 = null;
        let ouraData = null; //   Oura
        
        // Nutrition targets
        const TARGETS = {
            calories: 2100,
            protein: 200,
            fat: 65,
            carbs: 135,
            fiber: 30,
            salt: 5,
            caffeine: 150
        };

        // HRV thresholds for age 48 (based on population data)
        const HRV_THRESHOLDS = {
            age: 48,
            //   45-50:  30-65
            excellent: 55,    //  10% 
            good: 45,         //  
            average: 35,      //   
            low: 28,          //   -  
            //     ( 45-50)
            populationMedian: 38,
            populationP25: 30,  // 25- 
            populationP75: 48,  // 75- 
            populationP90: 58   // 90-  ( 10%)
        };

        // === AI SYSTEM PROMPTS ===
        const AI_SYSTEM = `   AI-  .

  ():
 48 ,     90
  I .,  
 : ,  5
  ~350     !
   
 : 2100 ,  200,  65,  135

:
  130  
 : max 150 ,  14:00
 : max 5/

HRV ( 48 ,     45-50):
 55    ( 10%)
 45    ( )
 35     
 28     ( )
 <28    (/)
 : 38 

 :
 : Oura 85 +  <125/80 + HRV  baseline
 : Oura 70-84 +  <130/85
 : Oura <70   140/90  HRV   baseline

  HRV :  ,  ,  .
  HRV:   .

        !
 ,   .`;

        //      
        function getMorningSystemPrompt() {
            const recentContext = buildRecentContext(7);
            const memoryContext = buildMemoryContext(['health', 'sleep', 'preferences']);
            return AI_SYSTEM + (recentContext ? '\n\n' + recentContext : '') + memoryContext;
        }

        const NUTRITION_AI_SYSTEM = `  AI-  .

 :
 2100 /
 : 200 (!)
 : 65 ( 17)
 : 135
 : 30
 : 4700, : 400
 -3: 1

:
        
  150  14:00
  5
   

   .`;

        const FOOD_ANALYSIS_PROMPT = `   -   20+ .

 :
1.  ( )   :
   -   
   -     /
   -   

2.   ( )   :
   -   ( )
   -   (    !)
   - /

 :           !

  (   ):
1.   ~25,  ~150 ,  ~100 
2. :  ~1.1/,  ~0.9/,  ~0.4/

  ( 100    ):
-  : 31 , 3.6 , 0 , 165 
-  : 2.7 , 0.3 , 28 , 130 
- : 26 , 15 , 0 , 250 
- : 20 , 13 , 0 , 208 
-  5%: 17 , 5 , 1.8 , 121 
- : 2 , 3 , 5 , 50 /100

  :
-   : +100-150 
- : +50-150 
-   :      

  JSON:
{
  "name": " ",
  "description": " ",
  "emoji": "",
  "weight":  ,
  "calories": ,
  "protein": ,
  "fat": ,
  "carbs": ,
  "fiber": ,
  "salt":  (  !),
  "caffeine":   0,
  "ingredients": [" ~X"],
  "confidence": "high" | "medium" | "low",
  "warnings": ["  /"]  [],
  "source": "photo" | "text" | "combined"
}

  ,   !
  JSON.`;

        const habits = {
            minimum: { title: " ", color: "green", items: [
                { id: 'steps_min', label: '4000 ' },
                { id: 'protein_meal', label: ' 40 + ' },
                { id: 'breathing', label: '5  ' }
            ]},
            normal: { title: " ", color: "blue", items: [
                { id: 'steps_full', label: '700010000 ' },
                { id: 'training', label: '' },
                { id: 'nutrition_track', label: ' ' },
                { id: 'breathing_2x', label: '2  ' },
                { id: 'sleep_time', label: '  23:30' }
            ]},
            strong: { title: " ", color: "purple", items: [
                { id: 'extra_training', label: ' ' },
                { id: 'full_tracking', label: ' ' }
            ]}
        };

        // === UTILITY ===
        function formatDate(d) { return d.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' }); }
        function formatNum(n) { return n.toLocaleString('ru-RU'); }
        function formatTime(d) { return new Date(d).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }
        //     "2025-01-31" -> "31 "
        function formatDateDisplay(dateKey) {
            const d = new Date(dateKey + 'T12:00:00'); //     timezone 
            return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }

        function calcDates(forDate) {
            const targetDate = forDate ? new Date(forDate) : new Date();
            targetDate.setHours(0,0,0,0);
            const pension = new Date(BIRTH_DATE); pension.setFullYear(pension.getFullYear() + PENSION_AGE);
            const goal = new Date(BIRTH_DATE); goal.setFullYear(goal.getFullYear() + LIFE_GOAL);
            const ms = 24*60*60*1000;
            return {
                lived: Math.floor((targetDate - BIRTH_DATE) / ms),
                toPension: Math.max(0, Math.floor((pension - targetDate) / ms)),
                toGoal: Math.max(0, Math.floor((goal - targetDate) / ms))
            };
        }
        
        function updateSync(s) {
            document.getElementById('syncStatus').className = 'sync-status ' + s;
            document.getElementById('syncIcon').textContent = s === 'synced' ? '' : s === 'syncing' ? '' : '';
            document.getElementById('syncText').textContent = s === 'synced' ? '' : s === 'syncing' ? '...' : '';
        }
        
        function hideAllScreens() {
            ['loadingScreen', 'setupScreen', 'settingsScreen', 'morningScreen', 'mainScreen', 'nutritionScreen', 'workoutsScreen', 'eveningScreen', 'trendsScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function showScreen(name) {
            hideAllScreens();
            document.getElementById(name + 'Screen').classList.remove('hidden');
            document.getElementById('bottomNav').classList.toggle('hidden', !['main', 'nutrition', 'workouts', 'evening', 'trends'].includes(name));
            document.getElementById('settingsBtn').classList.toggle('hidden', ['setup', 'settings', 'loading'].includes(name));

            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.screen === name);
            });

            //    Oura   
            if (name === 'morning') {
                checkOuraAvailable();
                updateWeightChange();
            }
        }

        window.navigateTo = function(screen) {
            showScreen(screen);
            if (screen === 'main') updateMain();
            if (screen === 'nutrition') updateNutrition();
            if (screen === 'workouts') updateWorkouts();
            if (screen === 'evening') updateEvening();
            if (screen === 'trends') updateTrends();
        };
        
        // === API KEY ===
        window.saveApiKey = function() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key || !key.startsWith('sk-or-')) { alert(' '); return; }
            API_KEY = key;
            localStorage.setItem('openrouter_api_key', key);
            proceedAfterSetup();
        };
        
        window.skipApiKey = function() { API_KEY = ''; proceedAfterSetup(); };
        
        window.showSettings = function() {
            showScreen('settings');
            updateKeyStatus();
            renderMemoryList();
        };

        window.closeSettings = function() {
            todayData?.morning ? (showScreen('main'), updateMain()) : showScreen('morning');
        };

        //   
        function renderMemoryList() {
            const container = document.getElementById('memoryList');
            const countEl = document.getElementById('memoryCount');
            const facts = userData.memory || [];

            countEl.textContent = `${facts.length}/50 `;

            if (facts.length === 0) {
                container.innerHTML = '<div style="color: #64748b; font-size: 13px; padding: 12px; text-align: center;"> . AI      .</div>';
                return;
            }

            container.innerHTML = facts.map(f => `
                <div class="memory-item" style="display: flex; align-items: flex-start; gap: 8px; padding: 8px; background: #1e293b; border-radius: 8px; margin-bottom: 6px;">
                    <span style="font-size: 16px;">${MEMORY_CATEGORIES[f.category]?.split(' ')[0] || ''}</span>
                    <div style="flex: 1; font-size: 13px;">
                        <div style="color: #e2e8f0;">${f.fact}</div>
                        <div style="color: #64748b; font-size: 11px; margin-top: 2px;">
                            ${f.source === 'ai' ? ' AI' : ' '}  ${f.date}
                        </div>
                    </div>
                    <button onclick="deleteMemoryAndRefresh(${f.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px;"></button>
                </div>
            `).join('');
        }

        window.deleteMemoryAndRefresh = async function(id) {
            await deleteMemoryFact(id);
            renderMemoryList();
        };

        window.addMemoryFromInput = async function() {
            const input = document.getElementById('newMemoryInput');
            const fact = input.value.trim();
            if (!fact) return;

            const added = await addMemoryFact(fact, 'preferences', 'user');
            if (added) {
                input.value = '';
                renderMemoryList();
            } else {
                alert('     ');
            }
        };
        
        window.updateApiKey = function() {
            const key = document.getElementById('apiKeyEdit').value.trim();
            if (!key || key.includes('') || !key.startsWith('sk-or-')) { alert(' '); return; }
            API_KEY = key;
            localStorage.setItem('openrouter_api_key', key);
            alert('!');
            updateKeyStatus();
        };
        
        window.deleteApiKey = function() {
            if (confirm(' ?')) {
                API_KEY = '';
                localStorage.removeItem('openrouter_api_key');
                updateKeyStatus();
            }
        };
        
        function updateKeyStatus() {
            const valid = !!API_KEY;
            document.getElementById('keyStatus').className = 'key-status ' + (valid ? 'valid' : 'invalid');
            document.getElementById('keyStatusIcon').textContent = valid ? '' : '';
            document.getElementById('keyStatusText').textContent = valid ? '' : ' ';
            document.getElementById('apiKeyEdit').value = valid ? '' + API_KEY.slice(-8) : '';

            // Oura key status
            updateOuraKeyStatus();
        }
        
        function updateOuraKeyStatus() {
            const valid = !!OURA_KEY;
            document.getElementById('ouraKeyStatus').className = 'key-status ' + (valid ? 'valid' : 'invalid');
            document.getElementById('ouraKeyStatusIcon').textContent = valid ? '' : '';
            document.getElementById('ouraKeyStatusText').textContent = valid ? '' : ' ';
            document.getElementById('ouraKeyEdit').value = valid ? '' + OURA_KEY.slice(-8) : '';
        }
        
        window.updateOuraKey = async function() {
            const key = document.getElementById('ouraKeyEdit').value.trim();
            if (!key || key.includes('')) { 
                alert(' Oura Personal Access Token'); 
                return; 
            }
            
            //  
            document.getElementById('ouraKeyStatusText').textContent = '...';
            
            try {
                const testResult = await testOuraConnection(key);
                if (testResult) {
                    OURA_KEY = key;
                    localStorage.setItem('oura_api_key', key);
                    alert(' Oura !');
                    updateOuraKeyStatus();
                    checkOuraAvailable();
                } else {
                    alert('  .    .');
                    updateOuraKeyStatus();
                }
            } catch (e) {
                alert('  : ' + e.message);
                updateOuraKeyStatus();
            }
        };
        
        window.deleteOuraKey = function() {
            if (confirm(' Oura?')) {
                OURA_KEY = '';
                localStorage.removeItem('oura_api_key');
                updateOuraKeyStatus();
                document.getElementById('ouraImportSection').classList.add('hidden');
            }
        };

        async function testOuraConnection(token) {
            try {
                const response = await fetch(`${OURA_PROXY}/personal_info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return response.ok;
            } catch (e) {
                console.error('Oura connection test failed:', e);
                return false;
            }
        }

        //    Oura   
        function mapOuraWorkoutType(ouraActivity) {
            const mapping = {
                'rowing': 'rowing',
                'indoor_rowing': 'rowing',
                'weight_training': 'strength',
                'strength_training': 'strength',
                'walking': 'walking',
                'hiking': 'walking',
                'stretching': 'stretch',
                'yoga': 'stretch',
                'pilates': 'stretch',
                'cycling': 'other',
                'running': 'other',
                'swimming': 'other'
            };
            return mapping[ouraActivity?.toLowerCase()] || 'other';
        }

        function checkOuraAvailable() {
            const section = document.getElementById('ouraImportSection');
            if (OURA_KEY) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
            //    Oura
            displaySavedOuraData();
        }

        //     Oura  todayData
        function displaySavedOuraData() {
            const oura = todayData?.oura;
            if (!oura) return;

            //  
            if (oura.sleep_duration) {
                const hours = Math.floor(oura.sleep_duration / 3600);
                const mins = Math.floor((oura.sleep_duration % 3600) / 60);
                document.getElementById('ouraSleepDuration').textContent = `${hours} ${mins}`;
                document.getElementById('ouraSleepDuration').className = 'oura-data-value ' +
                    (hours >= 7 ? 'good' : hours >= 6 ? 'warning' : 'bad');
            }

            //  
            if (oura.sleep_efficiency) {
                document.getElementById('ouraSleepEfficiency').textContent = oura.sleep_efficiency + '%';
                document.getElementById('ouraSleepEfficiency').className = 'oura-data-value ' +
                    (oura.sleep_efficiency >= 85 ? 'good' : oura.sleep_efficiency >= 75 ? 'warning' : 'bad');
            }

            // HRV
            if (oura.hrv) {
                const hrvRounded = Math.round(oura.hrv);
                let percentileLabel = '';
                if (oura.hrv >= HRV_THRESHOLDS.populationP90) percentileLabel = ' ';
                else if (oura.hrv >= HRV_THRESHOLDS.populationP75) percentileLabel = ' ';
                else if (oura.hrv < HRV_THRESHOLDS.populationP25) percentileLabel = ' ';
                document.getElementById('ouraHRV').textContent = hrvRounded + percentileLabel;
                document.getElementById('ouraHRV').className = 'oura-data-value ' +
                    (oura.hrv >= HRV_THRESHOLDS.good ? 'good' : oura.hrv >= HRV_THRESHOLDS.low ? 'warning' : 'bad');
            }

            //  
            if (oura.resting_hr) {
                document.getElementById('ouraRestingHR').textContent = oura.resting_hr;
                document.getElementById('ouraRestingHR').className = 'oura-data-value ' +
                    (oura.resting_hr <= 60 ? 'good' : oura.resting_hr <= 70 ? 'warning' : 'bad');
            }

            // SpO2
            if (oura.spo2) {
                document.getElementById('ouraSpO2').textContent = oura.spo2 + '%';
                document.getElementById('ouraSpO2').className = 'oura-data-value ' +
                    (oura.spo2 >= 96 ? 'good' : oura.spo2 >= 94 ? 'warning' : 'bad');
            }
        }

        window.importFromOura = async function() {
            if (!OURA_KEY) {
                alert('  Oura  ');
                return;
            }
            
            const btn = document.getElementById('ouraImportBtn');
            const status = document.getElementById('ouraImportStatus');
            
            btn.disabled = true;
            btn.textContent = ' ...';
            status.textContent = ' ...';
            
            try {
                //       (     )
                const now = getToday();
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                const startDate = yesterday.toISOString().split('T')[0];
                const endDate = getDateKey();
                
                //    Oura (readiness, sleep, spo2, workouts)
                //      - Oura API      1 
                const [readinessData, sleepData, spo2Data, workoutData] = await Promise.all([
                    fetchOuraData('daily_readiness', startDate, endDate),
                    fetchOuraData('sleep', startDate, endDate),
                    fetchOuraData('daily_spo2', startDate, endDate),
                    fetchOuraData('workout', startDate, endDate)
                ]);

                console.log('Oura readiness:', readinessData);
                console.log('Oura sleep:', sleepData);
                console.log('Oura spo2:', spo2Data);
                console.log('Oura workouts:', workoutData);

                //     (  )
                const today = getDateKey();
                const findToday = (arr) => arr?.find(d => d.day === today);
                const findLatest = (arr) => arr?.slice(-1)[0]; // fallback  

                const readiness = findToday(readinessData?.data) || findLatest(readinessData?.data);
                const sleep = findToday(sleepData?.data) || findLatest(sleepData?.data);
                const spo2 = findToday(spo2Data?.data) || findLatest(spo2Data?.data);
                const workouts = workoutData?.data || [];

                console.log('Selected readiness:', readiness?.day, 'score:', readiness?.score);
                console.log('Selected sleep:', sleep?.day);
                
                if (!readiness && !sleep) {
                    status.textContent = '   ';
                    btn.disabled = false;
                    btn.textContent = ' ';
                    return;
                }
                
                //  
                ouraData = { readiness, sleep };
                
                if (readiness?.score) {
                    document.getElementById('ouraReadiness').value = readiness.score;
                }
                
                //   
                if (sleep) {
                    console.log('Sleep data fields:', Object.keys(sleep));
                    
                    //   (total_sleep_duration  )
                    const duration = sleep.total_sleep_duration;
                    if (duration) {
                        const hours = Math.floor(duration / 3600);
                        const mins = Math.floor((duration % 3600) / 60);
                        document.getElementById('ouraSleepDuration').textContent = `${hours} ${mins}`;
                        document.getElementById('ouraSleepDuration').className = 'oura-data-value ' + 
                            (hours >= 7 ? 'good' : hours >= 6 ? 'warning' : 'bad');
                    }
                    
                    //  
                    const efficiency = sleep.efficiency;
                    if (efficiency) {
                        document.getElementById('ouraSleepEfficiency').textContent = `${efficiency}%`;
                        document.getElementById('ouraSleepEfficiency').className = 'oura-data-value ' + 
                            (efficiency >= 85 ? 'good' : efficiency >= 75 ? 'warning' : 'bad');
                    }
                    
                    // HRV (average_hrv)
                    const hrv = sleep.average_hrv;
                    if (hrv) {
                        const hrvRounded = Math.round(hrv);
                        //  HRV    
                        let percentileLabel = '';
                        if (hrv >= HRV_THRESHOLDS.populationP90) percentileLabel = ' ';
                        else if (hrv >= HRV_THRESHOLDS.populationP75) percentileLabel = ' ';
                        else if (hrv < HRV_THRESHOLDS.populationP25) percentileLabel = ' ';

                        document.getElementById('ouraHRV').textContent = hrvRounded + percentileLabel;
                        document.getElementById('ouraHRV').className = 'oura-data-value ' +
                            (hrv >= HRV_THRESHOLDS.good ? 'good' : hrv >= HRV_THRESHOLDS.low ? 'warning' : 'bad');
                    }
                    
                    // Resting HR (lowest_heart_rate)
                    const restingHR = sleep.lowest_heart_rate;
                    if (restingHR) {
                        document.getElementById('ouraRestingHR').textContent = restingHR;
                        document.getElementById('ouraRestingHR').className = 'oura-data-value ' +
                            (restingHR <= 60 ? 'good' : restingHR <= 70 ? 'warning' : 'bad');
                    }
                }

                // SpO2 (blood oxygen saturation)
                if (spo2?.spo2_percentage?.average) {
                    const spo2Value = Math.round(spo2.spo2_percentage.average);
                    document.getElementById('ouraSpO2').textContent = spo2Value + '%';
                    document.getElementById('ouraSpO2').className = 'oura-data-value ' +
                        (spo2Value >= 96 ? 'good' : spo2Value >= 94 ? 'warning' : 'bad');
                }

                //  todayData   ( ,   )
                if (!todayData) todayData = { habits: {}, meals: [], breathing: [], workouts: [] };
                if (!todayData.habits) todayData.habits = {};
                if (!todayData.workouts) todayData.workouts = [];

                //    
                const todayWorkouts = workouts.filter(w => w.day === getDateKey());
                if (todayWorkouts.length > 0) {
                    console.log('Found today workouts:', todayWorkouts);

                    for (const w of todayWorkouts) {
                        // ,      
                        const alreadyImported = todayData.workouts.some(
                            existing => existing.oura_id === w.id
                        );

                        if (!alreadyImported) {
                            const workoutType = mapOuraWorkoutType(w.activity);
                            todayData.workouts.push({
                                type: workoutType,
                                duration: Math.round((w.end_datetime ?
                                    (new Date(w.end_datetime) - new Date(w.start_datetime)) / 60000 :
                                    w.active_duration) || 30),
                                calories: w.calories || 0,
                                time: w.start_datetime,
                                oura_id: w.id,
                                source: 'oura'
                            });
                        }
                    }
                }

                //   Oura  todayData ( : readiness + sleep + spo2)
                todayData.oura = {
                    readiness: readiness?.score,
                    sleep_duration: sleep?.total_sleep_duration,
                    sleep_efficiency: sleep?.efficiency,
                    hrv: sleep?.average_hrv,
                    resting_hr: sleep?.lowest_heart_rate,
                    spo2: spo2?.spo2_percentage?.average ? Math.round(spo2.spo2_percentage.average) : null,
                    imported_at: new Date().toISOString()
                };

                //   Firebase
                userData.days[getDateKey()] = todayData;
                await saveData();

                status.textContent = '  !';
                btn.textContent = ' ';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = ' ';
                    status.textContent = '';
                }, 2000);
                
            } catch (e) {
                console.error('Oura import error:', e);
                status.textContent = ' : ' + e.message;
                btn.disabled = false;
                btn.textContent = ' ';
            }
        };
        
        async function fetchOuraData(endpoint, startDate, endDate) {
            const url = `${OURA_PROXY}/${endpoint}?start_date=${startDate}&end_date=${endDate}`;
            
            try {
                console.log(`Fetching Oura data: ${endpoint}`);
                const response = await fetch(url, {
                    headers: { 
                        'Authorization': `Bearer ${OURA_KEY}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                } else {
                    console.error(`Oura API error: ${response.status}`);
                    return null;
                }
            } catch (e) {
                console.error(`Oura fetch failed:`, e.message);
                return null;
            }
        }
        
        function proceedAfterSetup() {
            todayData?.morning ? (showScreen('main'), updateMain()) : showScreen('morning');
        }
        
        // === FIREBASE ===
        async function saveData() {
            updateSync('syncing');
            try {
                await set(userRef, userData);
                updateSync('synced');
                localStorage.setItem('ltBackup', JSON.stringify(userData));
            } catch(e) { 
                updateSync('offline'); 
                localStorage.setItem('ltBackup', JSON.stringify(userData)); 
            }
        }
        
        async function loadData() {
            console.log('loadData started');
            try {
                console.log('Fetching from Firebase...');
                const snap = await get(userRef);
                console.log('Firebase response:', snap.exists());
                if (snap.val()) userData = snap.val();
                updateSync('synced');
            } catch(e) {
                console.warn('Firebase error, using backup:', e.message);
                const b = localStorage.getItem('ltBackup');
                if (b) userData = JSON.parse(b);
                updateSync('offline');
            }
            if (!userData.days) userData.days = {};
            if (!userData.stats) userData.stats = {};
            if (!userData.memory) userData.memory = [];
            todayData = userData.days[getDateKey()] || null;
            console.log('loadData finished, memory facts:', userData.memory?.length || 0);
        }
        
        // === AI ===

        //     N  ( AI)
        function buildRecentContext(days = 7) {
            const lines = [];
            const dates = Object.keys(userData.days || {}).sort().reverse().slice(0, days);

            let hrvTrend = [];
            let readinessTrend = [];

            for (const date of dates) {
                const d = userData.days[date];
                if (!d) continue;

                const info = [];
                const dayName = date === getDateKey() ? '' :
                    date === getDateKey(new Date(Date.now() - 86400000)) ? '' :
                    new Date(date + 'T12:00:00').toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric' });

                // Oura 
                if (d.oura?.hrv) {
                    hrvTrend.push(Math.round(d.oura.hrv));
                    info.push(`HRV ${Math.round(d.oura.hrv)}`);
                }
                if (d.oura?.readiness) {
                    readinessTrend.push(d.oura.readiness);
                    if (d.oura.readiness < 70) info.push(`Readiness ${d.oura.readiness}`);
                }
                if (d.oura?.sleep_duration) {
                    const hrs = Math.round(d.oura.sleep_duration / 3600 * 10) / 10;
                    if (hrs < 6) info.push(`  ${hrs}`);
                    else if (hrs >= 8) info.push(`  ${hrs}`);
                }

                // 
                if (d.morning?.bp_sys) {
                    if (d.morning.bp_sys >= 145) info.push(`  ${d.morning.bp_sys}/${d.morning.bp_dia}`);
                    else if (d.morning.bp_sys >= 135) info.push(` ${d.morning.bp_sys}/${d.morning.bp_dia}`);
                }

                // 
                if (d.workouts?.length) {
                    const workoutTypes = {
                        rowing: '', strength: '', cardio: '',
                        stretching: '', walking: '', cycling: ''
                    };
                    const w = d.workouts.map(x => {
                        const name = workoutTypes[x.type] || x.type;
                        return `${name} ${x.duration}`;
                    }).join(', ');
                    info.push(w);
                }

                //  
                if (d.morning?.day_type === 'rest') info.push(' ');

                if (info.length > 0) {
                    lines.push(`${dayName}: ${info.join(', ')}`);
                }
            }

            //  
            let trends = [];
            if (hrvTrend.length >= 3) {
                const recent = hrvTrend.slice(0, 3);
                const avg = recent.reduce((a, b) => a + b, 0) / recent.length;
                if (recent[0] < recent[2] - 5) trends.push(`HRV  (${recent[0]}  ${recent[2]})`);
                if (avg < 30) trends.push('HRV    ');
            }
            if (readinessTrend.length >= 2 && readinessTrend[0] < 65 && readinessTrend[1] < 65) {
                trends.push('Readiness  2+    ');
            }

            let result = '';
            if (lines.length > 0) {
                result = ' :\n' + lines.join('\n');
            }
            if (trends.length > 0) {
                result += '\n\n : ' + trends.join('; ');
            }

            return result;
        }

        // ===   ===
        const MEMORY_CATEGORIES = {
            health: ' ',
            nutrition: ' ',
            workouts: ' ',
            sleep: ' ',
            preferences: ' ',
            other: ' '
        };

        //    
        async function addMemoryFact(fact, category = 'other', source = 'user') {
            if (!fact || fact.trim().length < 5) return false;

            //    ( )
            const isDuplicate = userData.memory.some(m =>
                m.fact.toLowerCase().includes(fact.toLowerCase().substring(0, 20)) ||
                fact.toLowerCase().includes(m.fact.toLowerCase().substring(0, 20))
            );
            if (isDuplicate) {
                console.log('Memory: duplicate fact skipped');
                return false;
            }

            userData.memory.push({
                id: Date.now(),
                fact: fact.trim(),
                category: category,
                source: source, // 'user' | 'ai' | 'correlation'
                date: getDateKey(),
                used: 0 //     
            });

            //  50 ,   
            if (userData.memory.length > 50) {
                userData.memory.sort((a, b) => b.used - a.used || b.id - a.id);
                userData.memory = userData.memory.slice(0, 50);
            }

            await saveData();
            console.log('Memory: added fact', fact.substring(0, 50));
            return true;
        }

        //    
        async function deleteMemoryFact(id) {
            userData.memory = userData.memory.filter(m => m.id !== id);
            await saveData();
        }

        //     
        function getRelevantMemory(categories = null, limit = 10) {
            let facts = userData.memory || [];

            if (categories) {
                const cats = Array.isArray(categories) ? categories : [categories];
                facts = facts.filter(m => cats.includes(m.category));
            }

            //     
            facts.sort((a, b) => b.used - a.used || b.id - a.id);

            //   
            facts.slice(0, limit).forEach(f => f.used = (f.used || 0) + 1);

            return facts.slice(0, limit);
        }

        //     
        function buildMemoryContext(categories = null) {
            const facts = getRelevantMemory(categories, 10);
            if (facts.length === 0) return '';

            const lines = facts.map(f => ` ${f.fact}`);
            return '\n\n  (   ):\n' + lines.join('\n');
        }

        //      AI
        async function extractFactsFromConversation(conversation, context = 'general') {
            if (!API_KEY || !conversation) return;

            const prompt = `    0-2    ,    .

:
${conversation}

:
-        
-     ( ,  )
- : , , ,  
-   ( 100 )

  :
- "     "
- "      "
- "     "
- "  "

 JSON       :
[{"fact": " ", "category": "health|nutrition|workouts|sleep|preferences|other"}]`;

            try {
                const response = await callAI([{ role: 'user', content: prompt }],
                    '      .   JSON.');

                const facts = extractJSON(response);
                if (facts && Array.isArray(facts)) {
                    for (const f of facts) {
                        if (f.fact && f.fact.length >= 10) {
                            await addMemoryFact(f.fact, f.category || 'other', 'ai');
                        }
                    }
                }
            } catch (e) {
                console.error('extractFactsFromConversation error:', e);
            }
        }

        //   ""  
        function parseRememberCommand(message) {
            const patterns = [
                /^[:\s]+(.+)/i,
                /^remember[:\s]+(.+)/i,
                /^[:\s]+(.+)/i
            ];

            for (const pattern of patterns) {
                const match = message.match(pattern);
                if (match) return match[1].trim();
            }
            return null;
        }

        async function callAI(messages, systemPrompt = AI_SYSTEM) {
            if (!API_KEY) return 'AI .   ';
            
            const statusEl = document.getElementById('chatStatus');
            if (statusEl) statusEl.textContent = '...';
            
            //    ( + fallback)
            const models = [AI_MODEL, 'openai/gpt-4o-mini'];
            
            for (const model of models) {
                try {
                    console.log(`Trying model: ${model}`);
                    const res = await fetch(OPENROUTER_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_KEY}`,
                            'HTTP-Referer': location.origin,
                            'X-Title': 'Life Tracker AI'
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [{ role: 'system', content: systemPrompt }, ...messages],
                            max_tokens: 800,
                            temperature: 0.7
                        })
                    });
                    const data = await res.json();
                    
                    if (data.error) {
                        console.warn(`Model ${model} error:`, data.error.message);
                        continue; //   
                    }
                    
                    if (statusEl) statusEl.textContent = '';
                    return data.choices[0].message.content;
                } catch(e) { 
                    console.warn(`Model ${model} fetch error:`, e.message);
                    continue;
                }
            }
            
            //    
            if (statusEl) statusEl.textContent = '';
            return 'AI  .  .';
        }
        
        async function callVisionAI(imageBase64, prompt) {
            if (!API_KEY) {
                console.error('Vision AI: No API key');
                return null;
            }

            try {
                const res = await fetch(OPENROUTER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': location.origin,
                        'X-Title': 'Life Tracker AI'
                    },
                    body: JSON.stringify({
                        model: VISION_MODEL,
                        messages: [{
                            role: 'user',
                            content: [
                                { type: 'text', text: prompt },
                                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${imageBase64}` } }
                            ]
                        }],
                        max_tokens: 1000
                    })
                });
                const data = await res.json();
                console.log('Vision AI response:', data);
                if (data.error) {
                    console.error('Vision AI error:', data.error);
                    return null;
                }
                return data.choices[0].message.content;
            } catch(e) {
                console.error('Vision AI exception:', e);
                return null;
            }
        }
        
        function addMessage(container, role, text) {
            const div = document.createElement('div');
            div.className = 'message ' + role;
            div.innerHTML = `
                <div class="message-avatar">${role === 'ai' ? '' : ''}</div>
                <div class="message-bubble">${text.replace(/\n/g, '<br>')}</div>
            `;
            document.getElementById(container).appendChild(div);
            document.getElementById(container).scrollTop = 99999;
        }
        
        function addTypingIndicator(container) {
            const div = document.createElement('div');
            div.className = 'message ai';
            div.id = 'typingIndicator';
            div.innerHTML = `<div class="message-avatar"></div><div class="message-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
            document.getElementById(container).appendChild(div);
            document.getElementById(container).scrollTop = 99999;
        }
        
        function removeTypingIndicator() {
            document.getElementById('typingIndicator')?.remove();
        }

        //   JSON   AI
        function extractJSON(response) {
            if (!response) return null;
            let str = response;
            //  markdown code blocks ( )
            str = str.replace(/```json\s*/gi, '');
            str = str.replace(/```\s*/g, '');
            str = str.replace(/`{3,}/g, '');
            str = str.trim();

            //    JSON
            function findBalancedJSON(text, startChar, endChar) {
                const startIdx = text.indexOf(startChar);
                if (startIdx === -1) return null;

                let depth = 0;
                let inString = false;
                let escape = false;

                for (let i = startIdx; i < text.length; i++) {
                    const char = text[i];

                    if (escape) {
                        escape = false;
                        continue;
                    }

                    if (char === '\\' && inString) {
                        escape = true;
                        continue;
                    }

                    if (char === '"') {
                        inString = !inString;
                        continue;
                    }

                    if (!inString) {
                        if (char === startChar) depth++;
                        else if (char === endChar) {
                            depth--;
                            if (depth === 0) {
                                return text.substring(startIdx, i + 1);
                            }
                        }
                    }
                }
                return null;
            }

            //     -   
            const arrayStart = str.indexOf('[');
            const objectStart = str.indexOf('{');

            let jsonStr;
            if (arrayStart !== -1 && (objectStart === -1 || arrayStart < objectStart)) {
                //    -   JSON
                jsonStr = findBalancedJSON(str, '[', ']');
            } else {
                //   
                jsonStr = findBalancedJSON(str, '{', '}');
            }

            if (!jsonStr) jsonStr = str;

            try {
                return JSON.parse(jsonStr.trim());
            } catch(e) {
                console.error('extractJSON parse error:', e.message);
                console.error('Attempted to parse:', jsonStr.substring(0, 300));
                return null;
            }
        }

        // === MORNING ===
        window.toggleEliteHRV = function() {
            showElite = !showElite;
            document.getElementById('eliteToggle').classList.toggle('active', showElite);
            document.getElementById('eliteFields').classList.toggle('hidden', !showElite);
        };
        
        window.analyzeMorning = async function() {
            const oura = parseInt(document.getElementById('ouraReadiness').value);
            const sys = parseInt(document.getElementById('bpSystolic').value) || null;
            const dia = parseInt(document.getElementById('bpDiastolic').value) || null;
            const pulse = parseInt(document.getElementById('pulse').value) || null;
            const weight = parseFloat(document.getElementById('morningWeight').value) || null;

            //  Oura ,  
            if (!oura) { alert(' Oura Readiness'); return; }

            const elite = showElite ? parseInt(document.getElementById('eliteScore').value) || null : null;

            document.getElementById('analyzeBtn').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            addTypingIndicator('chatMessages');

            const dayOfWeek = getToday().toLocaleDateString('ru-RU', { weekday: 'long' });

            //     
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = getDateKey(yesterday);
            const yesterdayData = userData.days[yesterdayKey];
            let yesterdaySalt = 0;
            let lastWeight = null;

            if (yesterdayData?.meals?.length > 0) {
                yesterdaySalt = yesterdayData.meals.reduce((s, m) => s + (m.salt || 0), 0);
            }

            //   
            const dates = Object.keys(userData.days).sort().reverse();
            for (const date of dates) {
                const w = userData.days[date]?.morning?.weight;
                if (w && date !== getDateKey()) {
                    lastWeight = w;
                    break;
                }
            }

            //   HRV  Oura  
            const todayOura = todayData?.oura;
            const hrv = todayOura?.hrv;
            const restingHr = todayOura?.resting_hr;
            const sleepDuration = todayOura?.sleep_duration ? Math.round(todayOura.sleep_duration / 3600 * 10) / 10 : null;

            let aiRequest = ` ${dayOfWeek}. :\n Oura Readiness: ${oura}/100`;
            if (sys && dia) aiRequest += `\n : ${sys}/${dia}`;
            if (pulse) aiRequest += `\n  : ${pulse}`;

            if (hrv) {
                const hrvRounded = Math.round(hrv);
                aiRequest += `\n HRV: ${hrvRounded} `;

                //    baseline
                const hrvBaseline = getHRVvsBaseline(hrv);
                if (hrvBaseline) {
                    const sign = hrvBaseline.diff > 0 ? '+' : '';
                    aiRequest += ` [ baseline: ${hrvBaseline.baseline},  ${sign}${Math.round(hrvBaseline.diff)}]`;
                }

                //    45-50 
                if (hrv >= HRV_THRESHOLDS.excellent) {
                    aiRequest += `   10%  48 !`;
                } else if (hrv >= HRV_THRESHOLDS.good) {
                    aiRequest += `     48 `;
                } else if (hrv >= HRV_THRESHOLDS.average) {
                    aiRequest += `    48 `;
                } else if (hrv >= HRV_THRESHOLDS.low) {
                    aiRequest += `   ,  `;
                } else {
                    aiRequest += `  !  `;
                }
            }
            if (restingHr) {
                aiRequest += `\n  : ${restingHr}`;
            }
            if (sleepDuration) {
                aiRequest += `\n : ${sleepDuration}`;
            }

            if (weight) {
                aiRequest += `\n : ${weight} `;
                if (lastWeight) {
                    const weightDiff = weight - lastWeight;
                    if (Math.abs(weightDiff) >= 0.3) {
                        aiRequest += ` (${weightDiff > 0 ? '+' : ''}${weightDiff.toFixed(1)} )`;
                    }
                }
            }
            if (elite) aiRequest += `\n EliteHRV: ${elite}/10`;

            //      
            if (yesterdaySalt > 0) {
                aiRequest += `\n  : ${yesterdaySalt.toFixed(1)}`;
                if (weight && lastWeight && (weight - lastWeight) >= 0.5 && yesterdaySalt > 4) {
                    aiRequest += `  (   !)`;
                }
            }

            aiRequest += `\n\n  ,    3 .`;

            chatHistory = [{ role: 'user', content: aiRequest }];
            const response = await callAI(chatHistory, getMorningSystemPrompt());
            removeTypingIndicator();

            chatHistory.push({ role: 'assistant', content: response });
            addMessage('chatMessages', 'ai', response);

            let dayType = 'normal';
            if (response.includes('') || response.includes('') || response.includes('')) dayType = 'strong';
            else if (response.includes('') || response.includes('') || response.includes('')) dayType = 'recovery';
            else if (oura >= 85 && (!sys || sys < 125)) dayType = 'strong';
            else if (oura < 70 || (sys && sys >= 140)) dayType = 'recovery';

            document.getElementById('dayBadge').className = 'day-badge ' + dayType;
            document.getElementById('dayBadge').innerHTML = dayType === 'strong' ? ' ' : dayType === 'normal' ? ' ' : ' ';

            if (!userData.days[getDateKey()]) userData.days[getDateKey()] = { habits: {}, meals: [] };
            userData.days[getDateKey()].morning = { ts: new Date().toISOString(), oura, bp_sys: sys, bp_dia: dia, pulse, weight, elite, day_type: dayType, ai: response };
            todayData = userData.days[getDateKey()];
            await saveData();

            document.getElementById('startDayBtn').classList.remove('hidden');
        };
        
        window.askQuestion = async function(q) {
            //   ""
            const factToRemember = parseRememberCommand(q);
            if (factToRemember) {
                const added = await addMemoryFact(factToRemember, 'preferences', 'user');
                addMessage('chatMessages', 'user', q);
                addMessage('chatMessages', 'ai', added ?
                    ` : "${factToRemember}"` :
                    `         .`);
                return;
            }

            chatHistory.push({ role: 'user', content: q });
            addMessage('chatMessages', 'user', q);
            addTypingIndicator('chatMessages');
            const response = await callAI(chatHistory, getMorningSystemPrompt());
            removeTypingIndicator();
            chatHistory.push({ role: 'assistant', content: response });
            addMessage('chatMessages', 'ai', response);
        };
        
        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askQuestion(msg);
        };
        
        window.handleChatKeypress = function(e) { if (e.key === 'Enter') sendChatMessage(); };
        
        window.startDay = function() {
            viewingDate = new Date(); //   
            showScreen('main');
            updateMain();
        };

        //   baseline HRV (   30 )
        function getPersonalHRVBaseline() {
            const dates = Object.keys(userData.days).sort().reverse();
            const hrvValues = [];

            for (const date of dates) {
                if (hrvValues.length >= 30) break;
                const hrv = userData.days[date]?.oura?.hrv;
                if (hrv) hrvValues.push(hrv);
            }

            if (hrvValues.length < 5) return null;

            const avg = Math.round(hrvValues.reduce((a, b) => a + b, 0) / hrvValues.length);
            const min = Math.min(...hrvValues);
            const max = Math.max(...hrvValues);

            return { avg, min, max, count: hrvValues.length };
        }

        //   HRV  baseline
        function getHRVvsBaseline(currentHrv) {
            const baseline = getPersonalHRVBaseline();
            if (!baseline || !currentHrv) return null;

            const diff = currentHrv - baseline.avg;
            const percentDiff = Math.round((diff / baseline.avg) * 100);

            return {
                baseline: baseline.avg,
                diff,
                percentDiff,
                status: diff >= 5 ? 'above' : diff <= -5 ? 'below' : 'normal'
            };
        }

        //   (   )
        let viewingDate = new Date();
        
        window.changeDay = function(delta) {
            viewingDate.setDate(viewingDate.getDate() + delta);
            
            const today = getToday();
            const todayStr = getDateKey(today);
            const viewingStr = getDateKey(viewingDate);
            
            //     
            if (viewingDate > today) {
                viewingDate = new Date(today);
            }
            
            updateMain();
        };
        
        window.editMorning = function() {
            //    
            if (todayData?.morning) {
                document.getElementById('ouraReadiness').value = todayData.morning.oura || '';
                document.getElementById('bpSystolic').value = todayData.morning.bp_sys || '';
                document.getElementById('bpDiastolic').value = todayData.morning.bp_dia || '';
                document.getElementById('pulse').value = todayData.morning.pulse || '';
                document.getElementById('morningWeight').value = todayData.morning.weight || '';
            }

            //   
            updateWeightChange();

            //  Oura
            checkOuraAvailable();

            //    (   )
            document.getElementById('analyzeBtn').classList.remove('hidden');
            document.getElementById('chatContainer').classList.add('hidden');
            document.getElementById('startDayBtn').classList.add('hidden');

            showScreen('morning');
        };

        //    
        function updateWeightChange() {
            const weightChangeEl = document.getElementById('weightChange');
            const edemaWarning = document.getElementById('edemaWarning');
            const edemaText = document.getElementById('edemaText');

            if (!weightChangeEl) return;

            //      
            if (edemaWarning) edemaWarning.classList.add('hidden');

            //       
            const dates = Object.keys(userData.days).sort().reverse();
            let lastWeight = null;
            let lastWeightDate = null;
            let yesterdaySalt = 0;

            for (const date of dates) {
                const w = userData.days[date]?.morning?.weight;
                if (w && date !== getDateKey()) {
                    lastWeight = w;
                    lastWeightDate = date;
                    break;
                }
            }

            //   
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = getDateKey(yesterday);
            const yesterdayData = userData.days[yesterdayKey];
            if (yesterdayData?.meals?.length > 0) {
                yesterdaySalt = yesterdayData.meals.reduce((s, m) => s + (m.salt || 0), 0);
            }

            if (!lastWeight) {
                weightChangeEl.textContent = '';
                return;
            }

            const currentWeight = parseFloat(document.getElementById('morningWeight').value);
            if (!currentWeight) {
                weightChangeEl.textContent = `: ${lastWeight} `;
                weightChangeEl.className = 'weight-change same';
                return;
            }

            const diff = currentWeight - lastWeight;
            if (Math.abs(diff) < 0.1) {
                weightChangeEl.textContent = `  (${lastWeight} )`;
                weightChangeEl.className = 'weight-change same';
            } else if (diff < 0) {
                weightChangeEl.textContent = ` ${Math.abs(diff).toFixed(1)}  ( ${lastWeight})`;
                weightChangeEl.className = 'weight-change down';
            } else {
                weightChangeEl.textContent = ` ${diff.toFixed(1)}  ( ${lastWeight})`;
                weightChangeEl.className = 'weight-change up';

                //   :   0.5+     
                if (diff >= 0.5 && edemaWarning && edemaText) {
                    let warnings = [];

                    if (yesterdaySalt > 5) {
                        warnings.push(` : ${yesterdaySalt.toFixed(1)} ( 5)`);
                    }

                    if (diff >= 1.0) {
                        warnings.push(`  +${diff.toFixed(1)}  `);
                    } else if (yesterdaySalt > 5) {
                        warnings.push(` +${diff.toFixed(1)}   `);
                    }

                    if (warnings.length > 0 || (diff >= 0.7 && yesterdaySalt > 3)) {
                        if (warnings.length === 0) {
                            warnings.push(` +${diff.toFixed(1)},   ${yesterdaySalt.toFixed(1)}`);
                        }
                        warnings.push('    .  ,   .');
                        edemaText.innerHTML = warnings.join('<br>');
                        edemaWarning.classList.remove('hidden');
                    }
                }
            }
        }

        //    
        document.addEventListener('DOMContentLoaded', () => {
            const weightInput = document.getElementById('morningWeight');
            if (weightInput) {
                weightInput.addEventListener('input', updateWeightChange);
            }
        });

        //        
        function getWeightChange(currentWeight) {
            const dates = Object.keys(userData.days).sort().reverse();
            let lastWeight = null;
            const currentDateKey = getDateKey(viewingDate);

            for (const date of dates) {
                const w = userData.days[date]?.morning?.weight;
                if (w && date !== currentDateKey) {
                    lastWeight = w;
                    break;
                }
            }

            if (!lastWeight) return '';

            const diff = currentWeight - lastWeight;
            if (Math.abs(diff) < 0.1) return '';
            return diff < 0 ? ` (${Math.abs(diff).toFixed(1)})` : ` (${diff.toFixed(1)})`;
        }

        // === MAIN SCREEN ===
        function updateMain() {
            const today = getToday();
            const todayStr = getDateKey(today);
            const viewingStr = getDateKey(viewingDate);
            const isToday = todayStr === viewingStr;
            
            //     
            const dayData = userData.days[viewingStr] || null;
            
            //    
            document.getElementById('mainDate').textContent = formatDate(viewingDate);
            
            const dayLabel = document.getElementById('dayLabel');
            if (isToday) {
                dayLabel.textContent = '';
                dayLabel.className = 'date-nav-label';
            } else {
                const diff = Math.floor((today - viewingDate) / (1000 * 60 * 60 * 24));
                dayLabel.textContent = diff === 1 ? '' : `${diff}  `;
                dayLabel.className = 'date-nav-label past';
            }
            
            //  "" -   
            document.getElementById('nextDayBtn').disabled = isToday;
            
            const dt = dayData?.morning?.day_type || 'normal';
            document.getElementById('mainBadge').className = 'day-badge ' + dt;
            document.getElementById('mainBadge').innerHTML = dt === 'strong' ? '' : dt === 'normal' ? '' : '';
            
            if (dayData?.morning) {
                const m = dayData.morning;
                document.getElementById('sumOura').textContent = m.oura || '';
                document.getElementById('sumOura').className = 'morning-data-value ' + (m.oura >= 85 ? 'good' : m.oura >= 70 ? '' : 'warning');

                //    
                if (m.bp_sys && m.bp_dia) {
                    document.getElementById('sumBP').textContent = `${m.bp_sys}/${m.bp_dia}`;
                    document.getElementById('sumBP').className = 'morning-data-value ' + (m.bp_sys < 130 ? 'good' : m.bp_sys < 140 ? 'warning' : 'bad');
                } else {
                    document.getElementById('sumBP').textContent = '';
                    document.getElementById('sumBP').className = 'morning-data-value';
                }

                if (m.pulse) {
                    document.getElementById('sumPulse').textContent = `${m.pulse} /`;
                } else {
                    document.getElementById('sumPulse').textContent = '';
                }

                //    
                if (m.weight) {
                    document.getElementById('weightRow').style.display = 'flex';
                    const weightChange = getWeightChange(m.weight);
                    document.getElementById('sumWeight').textContent = `${m.weight} ${weightChange}`;
                } else {
                    document.getElementById('weightRow').style.display = 'none';
                }
            } else {
                document.getElementById('sumOura').textContent = '';
                document.getElementById('sumBP').textContent = '';
                document.getElementById('sumPulse').textContent = '';
                document.getElementById('weightRow').style.display = 'none';
            }
            
            const d = calcDates(viewingDate);
            document.getElementById('daysLived').textContent = formatNum(d.lived);
            document.getElementById('daysToPension').textContent = formatNum(d.toPension);
            document.getElementById('daysToGoal').textContent = formatNum(d.toGoal);
            
            //        
            const savedTodayData = todayData;
            todayData = dayData;
            
            updateStatus();
            renderHabits();
            
            //  todayData    
            if (!isToday) {
                todayData = savedTodayData;
            }
            
            if (mainChatHistory.length === 0 && dayData?.morning) {
                const m = dayData.morning;
                mainChatHistory = [{ role: 'system', content: `: ${m.day_type} , Oura ${m.oura},  ${m.bp_sys}/${m.bp_dia}` }];
            }

            //       
            if (isToday) {
                loadBPPrediction();
            } else {
                document.getElementById('bpPredictionCard').style.display = 'none';
            }
        }

        function updateStatus() {
            const min = ['steps_min', 'protein_meal', 'breathing'];
            const ch = todayData?.habits || {};
            const done = min.filter(id => ch[id]).length;
            const complete = done === min.length;
            
            document.getElementById('systemStatus').className = 'system-status ' + (complete ? 'complete' : 'incomplete');
            document.getElementById('systemIcon').textContent = complete ? '' : '';
            document.getElementById('systemTitle').textContent = complete ? '  !' : ' ';
            document.getElementById('systemSubtitle').textContent = complete ? ' !' : `: ${min.length - done}  3`;
            document.getElementById('streakBadge').textContent = ' ' + (userData.stats.current_streak || 0);
        }
        
        function renderHabits() {
            const c = document.getElementById('habitsContainer');
            c.innerHTML = '';
            const dt = todayData?.morning?.day_type || 'normal';
            const ch = todayData?.habits || {};
            
            Object.entries(habits).forEach(([key, sec]) => {
                const active = key === 'minimum' || (key === 'normal' && dt !== 'recovery') || (key === 'strong' && dt === 'strong');
                const cnt = sec.items.filter(i => ch[i.id]).length;
                
                const div = document.createElement('div');
                div.className = `habit-section ${sec.color} ${active ? '' : 'inactive'}`;
                div.innerHTML = `
                    <div class="habit-header">
                        <span class="habit-title ${sec.color}">${sec.title}</span>
                        <span class="habit-counter ${sec.color}">${cnt}/${sec.items.length}</span>
                    </div>
                    ${sec.items.map(i => `
                        <div class="habit-item ${ch[i.id] ? 'checked' : ''} ${sec.color}" data-id="${i.id}">
                            <div class="checkbox"><span class="checkbox-mark"></span></div>
                            <span class="habit-item-label">${i.label}</span>
                        </div>
                    `).join('')}
                `;
                c.appendChild(div);
            });
            
            c.querySelectorAll('.habit-item').forEach(el => {
                el.addEventListener('click', () => toggleHabit(el.dataset.id));
            });
        }
        
        async function toggleHabit(id) {
            if (!todayData) todayData = { habits: {}, meals: [] };
            if (!todayData.habits) todayData.habits = {};
            todayData.habits[id] = !todayData.habits[id];
            userData.days[getDateKey()] = todayData;
            await saveData();
            updateStatus();
            renderHabits();
        }
        
        window.toggleMainChat = function() {
            document.getElementById('mainChatBody').classList.toggle('hidden');
            document.getElementById('chatToggleIcon').textContent = document.getElementById('mainChatBody').classList.contains('hidden') ? '' : '';
        };
        
        window.askMainQuestion = async function(q) {
            document.getElementById('mainChatBody').classList.remove('hidden');
            document.getElementById('chatToggleIcon').textContent = '';
            mainChatHistory.push({ role: 'user', content: q });
            addMessage('mainChatMessages', 'user', q);
            addTypingIndicator('mainChatMessages');
            const response = await callAI(mainChatHistory);
            removeTypingIndicator();
            mainChatHistory.push({ role: 'assistant', content: response });
            addMessage('mainChatMessages', 'ai', response);
        };
        
        window.sendMainChatMessage = async function() {
            const input = document.getElementById('mainChatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askMainQuestion(msg);
        };
        
        window.handleMainChatKeypress = function(e) { if (e.key === 'Enter') sendMainChatMessage(); };
        
        // === NUTRITION ===
        function getTotals() {
            const meals = todayData?.meals || [];
            return meals.reduce((acc, m) => ({
                calories: acc.calories + (m.calories || 0),
                protein: acc.protein + (m.protein || 0),
                fat: acc.fat + (m.fat || 0),
                carbs: acc.carbs + (m.carbs || 0),
                fiber: acc.fiber + (m.fiber || 0),
                salt: acc.salt + (m.salt || 0),
                caffeine: acc.caffeine + (m.caffeine || 0)
            }), { calories: 0, protein: 0, fat: 0, carbs: 0, fiber: 0, salt: 0, caffeine: 0 });
        }
        
        function updateNutrition() {
            document.getElementById('nutritionDate').textContent = formatDate(getToday());
            
            const totals = getTotals();

            // Update summary cards (  )
            document.getElementById('caloriesValue').textContent = Math.round(totals.calories);
            document.getElementById('proteinValue').textContent = Math.round(totals.protein) + '';
            document.getElementById('fatValue').textContent = Math.round(totals.fat) + '';
            document.getElementById('carbsValue').textContent = Math.round(totals.carbs) + '';
            document.getElementById('fiberValue').textContent = Math.round(totals.fiber) + '';
            document.getElementById('saltValue').textContent = totals.salt.toFixed(1) + '';

            // Progress bars
            updateProgressBar('calories', totals.calories, TARGETS.calories);
            updateProgressBar('protein', totals.protein, TARGETS.protein);
            updateProgressBar('fat', totals.fat, TARGETS.fat);
            updateProgressBar('carbs', totals.carbs, TARGETS.carbs);
            updateProgressBar('fiber', totals.fiber, TARGETS.fiber);
            updateSaltProgress(totals.salt, TARGETS.salt);

            // Remaining
            const remaining = Math.round(TARGETS.calories - totals.calories);
            document.getElementById('caloriesRemaining').textContent = remaining > 0 ? `: ${remaining} ` : `  ${-remaining} `;

            // Table (  )
            document.getElementById('tableCalories').textContent = Math.round(totals.calories);
            document.getElementById('tableProtein').textContent = Math.round(totals.protein) + '';
            document.getElementById('tableFat').textContent = Math.round(totals.fat) + '';
            document.getElementById('tableCarbs').textContent = Math.round(totals.carbs) + '';
            document.getElementById('tableFiber').textContent = Math.round(totals.fiber) + '';
            document.getElementById('tableSalt').textContent = totals.salt.toFixed(1) + '';
            document.getElementById('tableCaffeine').textContent = Math.round(totals.caffeine) + '';
            
            // Color coding for table
            setTableColor('tableCalories', totals.calories, TARGETS.calories);
            setTableColor('tableProtein', totals.protein, TARGETS.protein);
            setTableColor('tableFat', totals.fat, TARGETS.fat);
            setTableColor('tableCarbs', totals.carbs, TARGETS.carbs);
            setTableColor('tableFiber', totals.fiber, TARGETS.fiber, true);
            setTableColor('tableSalt', totals.salt, TARGETS.salt);
            setTableColor('tableCaffeine', totals.caffeine, TARGETS.caffeine);
            
            // Render food log
            renderFoodLog();
        }
        
        function updateProgressBar(id, value, target) {
            const percent = Math.min((value / target) * 100, 100);
            const bar = document.getElementById(id + 'Bar');
            bar.style.width = percent + '%';
            bar.className = 'nutrition-progress-bar ' + (value > target * 1.1 ? 'over' : value > target * 0.9 ? 'warning' : 'good');
        }

        function updateSaltProgress(value, target) {
            const percent = Math.min((value / target) * 100, 100);
            const bar = document.getElementById('saltBar');
            const card = document.querySelector('.nutrition-card.salt-card');
            const remaining = document.getElementById('saltRemaining');

            bar.style.width = percent + '%';

            // Remove previous states
            card.classList.remove('warning', 'danger');
            remaining.classList.remove('danger');

            if (value > target) {
                bar.className = 'nutrition-progress-bar over';
                card.classList.add('danger');
                remaining.classList.add('danger');
                remaining.textContent = ` ! +${(value - target).toFixed(1)}`;
            } else if (value > target * 0.8) {
                bar.className = 'nutrition-progress-bar warning';
                card.classList.add('warning');
                remaining.textContent = ` : ${(target - value).toFixed(1)}`;
            } else {
                bar.className = 'nutrition-progress-bar good';
                remaining.textContent = value > 0 ? ` : ${(target - value).toFixed(1)}` : '';
            }
        }
        
        function setTableColor(id, value, target, inverse = false) {
            const el = document.getElementById(id);
            el.className = 'nutrition-table-fact';
            if (inverse) {
                if (value >= target) el.classList.add('good');
                else if (value >= target * 0.7) el.classList.add('warning');
            } else {
                if (value > target * 1.1) el.classList.add('over');
                else if (value > target * 0.9) el.classList.add('warning');
                else el.classList.add('good');
            }
        }
        
        function renderFoodLog() {
            const container = document.getElementById('foodLogContainer');
            const meals = todayData?.meals || [];

            if (meals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-text">   </div></div>';
                return;
            }

            container.innerHTML = meals.map((m, i) => {
                const hasWarnings = m.warnings && m.warnings.length > 0;
                const saltWarning = m.salt && m.salt > 2;
                const weightStr = m.weight ? `${m.weight}` : '';

                return `
                    <div class="food-log-item ${hasWarnings || saltWarning ? 'has-warning' : ''}">
                        <div class="food-log-icon">${m.emoji || ''}</div>
                        <div class="food-log-info">
                            <div class="food-log-name">${m.name} ${weightStr ? `<span class="food-log-weight">${weightStr}</span>` : ''}</div>
                            <div class="food-log-macros">
                                <span class="macro protein">${m.protein}</span>
                                <span class="macro fat">${m.fat}</span>
                                <span class="macro carbs">${m.carbs}</span>
                                ${m.salt ? `<span class="macro salt ${m.salt > 2 ? 'high' : ''}">${m.salt}</span>` : ''}
                            </div>
                            ${m.description ? `<div class="food-log-desc">${m.description}</div>` : ''}
                            ${hasWarnings ? `<div class="food-log-warnings">${m.warnings.map(w => ` ${w}`).join('<br>')}</div>` : ''}
                            <div class="food-log-time">${formatTime(m.time)}</div>
                        </div>
                        <div class="food-log-calories">${m.calories}<span class="kcal-label"></span></div>
                        <button class="food-log-delete" onclick="deleteMeal(${i})"></button>
                    </div>
                `;
            }).join('');
        }
        
        window.deleteMeal = async function(index) {
            if (!confirm('?')) return;
            todayData.meals.splice(index, 1);
            userData.days[getDateKey()] = todayData;
            await saveData();
            updateNutrition();
        };
        
        // Food photo handling - multi photo support
        let foodPhotos = [];

        window.handleFoodPhotoSelect = function(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;

            files.forEach(file => {
                if (foodPhotos.length >= 5) return; // Max 5 photos

                const reader = new FileReader();
                reader.onload = function(e) {
                    foodPhotos.push({
                        dataUrl: e.target.result,
                        base64: e.target.result.split(',')[1]
                    });
                    renderFoodPhotosPreview();
                };
                reader.readAsDataURL(file);
            });

            event.target.value = ''; // Reset for re-selection
        };

        function renderFoodPhotosPreview() {
            const container = document.getElementById('foodPhotosPreview');
            const hintEl = document.getElementById('foodInputHint');
            const labelEl = document.getElementById('foodInputLabel');

            if (foodPhotos.length === 0) {
                container.classList.add('hidden');
                //   -  
                labelEl.textContent = '   :';
                hintEl.textContent = ': " 300,  50"  "  200  "';
                return;
            }

            container.classList.remove('hidden');
            //   + 
            labelEl.textContent = '   ():';
            hintEl.textContent = '      : " 300"  " 150,  200"';

            container.innerHTML = foodPhotos.map((p, i) => `
                <div class="photo-thumb">
                    <img src="${p.dataUrl}" alt=" ${i + 1}">
                    <button class="photo-thumb-delete" onclick="removeFoodPhoto(${i})"></button>
                    <span class="photo-thumb-num">${i + 1}</span>
                </div>
            `).join('') + (foodPhotos.length < 5 ? `
                <div class="photo-thumb add-more" onclick="document.getElementById('foodGalleryInput').click()">
                    <span>+</span>
                </div>
            ` : '');
        }

        window.removeFoodPhoto = function(index) {
            foodPhotos.splice(index, 1);
            renderFoodPhotosPreview();
        };

        //   :  +  
        window.analyzeFood = async function() {
            const textInput = document.getElementById('foodTextInput');
            const text = textInput.value.trim();
            const hasPhotos = foodPhotos.length > 0;

            if (!hasPhotos && !text) {
                alert('     ');
                return;
            }

            document.getElementById('foodAnalyzing').classList.remove('hidden');
            document.getElementById('analyzeFoodBtn').disabled = true;

            try {
                let response;

                if (hasPhotos) {
                    //  :  + 
                    const totalPhotos = foodPhotos.length;
                    let successCount = 0;

                    for (let i = 0; i < totalPhotos; i++) {
                        document.getElementById('foodAnalyzingText').textContent =
                            `AI  ${text ? ' + ' : ''} ${i + 1}/${totalPhotos}...`;

                        //     
                        let combinedPrompt = FOOD_ANALYSIS_PROMPT;
                        if (text) {
                            combinedPrompt += `\n\n   :\n"${text}"\n\n        !`;
                        }

                        try {
                            response = await callVisionAI(foodPhotos[i].base64, combinedPrompt);

                            if (response) {
                                let json = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                                const food = JSON.parse(json);
                                food.hasPhoto = true;
                                food.userDescription = text || null;
                                await addMeal(food);
                                successCount++;
                            }
                        } catch(e) {
                            console.error('Parse error for photo', i, e);
                        }
                    }

                    //  
                    foodPhotos = [];
                    renderFoodPhotosPreview();
                    textInput.value = '';

                    if (successCount === 0) {
                        alert('  .   .');
                    } else if (successCount < totalPhotos) {
                        alert(` ${successCount}  ${totalPhotos} `);
                    }

                } else {
                    //   ( )
                    document.getElementById('foodAnalyzingText').textContent = 'AI  ...';

                    response = await callAI([{ role: 'user', content: text }], FOOD_ANALYSIS_PROMPT);

                    let json = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    const food = JSON.parse(json);
                    food.hasPhoto = false;
                    await addMeal(food);
                    textInput.value = '';
                }

            } catch(e) {
                console.error('Food analysis error:', e);
                alert(' .   .');
            }

            document.getElementById('foodAnalyzing').classList.add('hidden');
            document.getElementById('analyzeFoodBtn').disabled = false;
            document.getElementById('foodAnalyzingText').textContent = 'AI ...';
        };

        window.handleFoodKeypress = function(e) { if (e.key === 'Enter') analyzeFood(); };
        
        async function addMeal(food) {
            if (!todayData) todayData = { habits: {}, meals: [] };
            if (!todayData.meals) todayData.meals = [];
            
            todayData.meals.push({
                ...food,
                time: new Date().toISOString()
            });
            
            userData.days[getDateKey()] = todayData;
            await saveData();
            updateNutrition();
            
            // Show AI comment
            if (food.comment) {
                alert(' ' + food.comment);
            }
        }
        
        // Nutrition chat
        window.toggleNutritionChat = function() {
            document.getElementById('nutritionChatBody').classList.toggle('hidden');
            document.getElementById('nutritionChatToggle').textContent = document.getElementById('nutritionChatBody').classList.contains('hidden') ? '' : '';
        };
        
        window.askNutritionQuestion = async function(q) {
            document.getElementById('nutritionChatBody').classList.remove('hidden');
            document.getElementById('nutritionChatToggle').textContent = '';
            
            const totals = getTotals();
            const context = `: ${totals.calories} , ${totals.protein}, ${totals.fat}, ${totals.carbs},  ${totals.fiber}. : ${TARGETS.calories - totals.calories} ,    ${TARGETS.protein - totals.protein}.`;
            
            nutritionChatHistory.push({ role: 'user', content: context + '\n\n' + q });
            addMessage('nutritionChatMessages', 'user', q);
            addTypingIndicator('nutritionChatMessages');
            
            const response = await callAI(nutritionChatHistory, NUTRITION_AI_SYSTEM);
            removeTypingIndicator();
            
            nutritionChatHistory.push({ role: 'assistant', content: response });
            addMessage('nutritionChatMessages', 'ai', response);
        };
        
        window.sendNutritionChatMessage = async function() {
            const input = document.getElementById('nutritionChatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askNutritionQuestion(msg);
        };
        
        window.handleNutritionChatKeypress = function(e) { if (e.key === 'Enter') sendNutritionChatMessage(); };

        // === WORKOUTS ===
        let workoutChatHistory = [];
        let selectedWorkoutType = null;
        let selectedFeeling = 'normal';
        let workoutPhotos = []; //  base64  ( 5)

        const WORKOUT_TYPES = {
            strength: { name: '', emoji: '', caloriesPerMin: 6 },
            rowing: { name: '', emoji: '', caloriesPerMin: 10 },
            walking: { name: '', emoji: '', caloriesPerMin: 5 },
            stretch: { name: '', emoji: '', caloriesPerMin: 3 }
        };

        const FEELING_MULTIPLIER = { hard: 1.2, normal: 1.0, easy: 0.8 };

        const WORKOUT_AI_SYSTEM_BASE = `  AI-     .

  ():
 48 ,  I .,  
 : ,  5
 ACTN3 XX     
      

  :
     
    (  140-150)
   HIIT
   

 , ,  .       !`;

        //     
        function getWorkoutSystemPrompt() {
            const recentContext = buildRecentContext(7);
            const memoryContext = buildMemoryContext(['workouts', 'health', 'preferences']);
            return WORKOUT_AI_SYSTEM_BASE + (recentContext ? '\n\n' + recentContext : '') + memoryContext;
        }

        const WORKOUT_ANALYSIS_PROMPT = `    -   .

  ,     .   JSON:
{
  "type": "strength" | "rowing" | "walking" | "stretch" | null,
  "duration":    null,
  "distance":    null,
  "calories":    null,
  "avgHR":   ()  null,
  "maxHR":   ()  null,
  "hrZones": {
    "zone1":    1  null,
    "zone2":    2  null,
    "zone3":    3  null,
    "zone4":    4  null,
    "zone5":    5  null
  }  null,
  "pace": " (:/500    :/  )"  null,
  "power":     ()  null,
  "strokeRate":    ()  null,
  "exercises": [
    {
      "name": " ",
      "sets":    null,
      "reps": " (  )"  null,
      "weight": " ()"  null,
      "recommendation": "      (1 )"
    }
  ]  null,
  "notes": "    (1-2   )",
  "overallRecommendation": "    ( ,    )"
}

:
- strength: , , , 
- rowing: ,  , Concept2, ErgData
- walking: , , ,   
- stretch: , , , 

:          !

  JSON  markdown.`;

        function updateWorkouts() {
            const dateKey = getDateKey();
            todayData = userData.days?.[dateKey] || { habits: {}, meals: [], breathing: [], workouts: [] };
            if (!todayData.workouts) todayData.workouts = [];

            document.getElementById('workoutsDate').textContent = formatDateDisplay(dateKey);

            //    AI-   
            workoutChatHistory = [];
            const chatMessages = document.getElementById('workoutChatMessages');
            if (chatMessages) chatMessages.innerHTML = '';

            renderWeekCalendar();
            renderWorkoutHistory();
            loadWorkoutInsights();
            resetWorkoutForm();
        }

        function renderWeekCalendar() {
            const container = document.getElementById('weekCalendar');
            const today = getToday();
            const dayOfWeek = today.getDay() || 7;
            const monday = new Date(today);
            monday.setDate(today.getDate() - dayOfWeek + 1);

            const days = ['', '', '', '', '', '', ''];
            let weekWorkouts = 0;
            let html = '';

            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                const localKey = dateToKey(d);
                const utcKey = d.toISOString().split('T')[0];

                //     
                const dayData = userData.days?.[localKey] || userData.days?.[utcKey];
                const workoutCount = dayData?.workouts?.length || 0;
                const hasWorkout = workoutCount > 0;
                const isToday = localKey === getDateKey();

                if (hasWorkout) weekWorkouts += workoutCount; //   ,  

                //       1
                let workoutDisplay;
                if (!hasWorkout) {
                    workoutDisplay = '';
                } else if (workoutCount === 1) {
                    workoutDisplay = WORKOUT_TYPES[dayData.workouts[0]?.type]?.emoji || '';
                } else {
                    //   -  
                    workoutDisplay = `<span class="multi-workout">${workoutCount}</span>`;
                }

                html += `
                    <div class="week-day">
                        <div class="week-day-label">${days[i]}</div>
                        <div class="week-day-icon ${hasWorkout ? 'has-workout' : ''} ${isToday ? 'today' : ''}">${workoutDisplay}</div>
                    </div>
                `;
            }

            container.innerHTML = html;
            document.getElementById('weekProgress').textContent = `${weekWorkouts}/4`;
        }

        function renderWorkoutHistory() {
            const container = document.getElementById('workoutHistoryContainer');
            const allWorkouts = [];
            const today = getToday();

            //     7 
            //    :   UTC (    )
            const checkedKeys = new Set();

            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);

                //   ( )
                const localKey = dateToKey(d);
                // UTC  ( ) -  
                const utcKey = d.toISOString().split('T')[0];

                //   ,      
                [localKey, utcKey].forEach(key => {
                    if (checkedKeys.has(key)) return;
                    checkedKeys.add(key);

                    const dayData = userData.days?.[key];
                    if (dayData?.workouts?.length > 0) {
                        dayData.workouts.forEach((w, idx) => {
                            allWorkouts.push({ ...w, dateKey: key, index: idx, daysAgo: i });
                        });
                    }
                });
            }

            if (allWorkouts.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-text">  </div></div>`;
                return;
            }

            container.innerHTML = allWorkouts.map(w => {
                const type = WORKOUT_TYPES[w.type] || WORKOUT_TYPES.strength;
                const timeStr = new Date(w.time).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const dayStr = w.daysAgo === 0 ? '' : w.daysAgo === 1 ? '' : formatDateDisplay(w.dateKey);
                const feelingEmoji = w.feeling === 'hard' ? '' : w.feeling === 'easy' ? '' : '';

                // Build metrics string
                const metrics = [];
                if (w.distance) metrics.push(`${w.distance}`);
                if (w.pace) metrics.push(` ${w.pace}`);
                if (w.avgHR) metrics.push(` ${w.avgHR}${w.maxHR ? '/' + w.maxHR : ''}`);
                if (w.power) metrics.push(`${w.power}`);
                const metricsStr = metrics.join('  ');

                return `
                    <div class="workout-history-item">
                        <div class="workout-history-header">
                            <span class="workout-history-date">${dayStr} ${timeStr}</span>
                            <span class="workout-history-feeling">${feelingEmoji}</span>
                        </div>
                        <div class="workout-history-main">
                            <div class="workout-history-icon">${type.emoji}</div>
                            <div class="workout-history-info">
                                <div class="workout-history-title">${type.name}  ${w.duration} </div>
                                <div class="workout-history-details">${metricsStr}</div>
                            </div>
                            <div class="workout-history-stats">
                                <div class="workout-history-calories"> ${w.calories} </div>
                            </div>
                            ${w.daysAgo === 0 ? `<button class="workout-history-delete" onclick="deleteWorkout('${w.dateKey}', ${w.index})"></button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadWorkoutInsights() {
            const container = document.getElementById('workoutInsights');
            if (!API_KEY) {
                container.innerHTML = '<div class="ai-insights-loading"> API   AI-</div>';
                return;
            }

            const weekWorkouts = getWeekWorkouts();

            if (weekWorkouts.length === 0) {
                container.innerHTML = `<div class="ai-insights-loading">   </div>`;
                return;
            }

            //   -  
            const lastWorkout = weekWorkouts[0];
            const type = WORKOUT_TYPES[lastWorkout.type] || WORKOUT_TYPES.strength;

            container.innerHTML = `<div class="ai-insights-context">  :</div><div class="ai-insights-loading">...</div>`;

            //    
            const workoutDetails = [];
            workoutDetails.push(`: ${type.name}`);
            workoutDetails.push(`: ${lastWorkout.duration} `);
            if (lastWorkout.distance) workoutDetails.push(`: ${lastWorkout.distance}`);
            if (lastWorkout.pace) workoutDetails.push(`: ${lastWorkout.pace}`);
            if (lastWorkout.power) workoutDetails.push(`: ${lastWorkout.power}`);
            if (lastWorkout.strokeRate) workoutDetails.push(`Stroke rate: ${lastWorkout.strokeRate} /`);
            if (lastWorkout.avgHR) workoutDetails.push(` : ${lastWorkout.avgHR}`);
            if (lastWorkout.maxHR) workoutDetails.push(` : ${lastWorkout.maxHR}`);
            if (lastWorkout.hrZones) {
                const zones = lastWorkout.hrZones;
                workoutDetails.push(`: Z1=${zones.zone1||0}, Z2=${zones.zone2||0}, Z3=${zones.zone3||0}, Z4=${zones.zone4||0}, Z5=${zones.zone5||0}`);
            }
            workoutDetails.push(`: ${lastWorkout.calories} `);
            workoutDetails.push(`: ${lastWorkout.feeling === 'hard' ? '' : lastWorkout.feeling === 'easy' ? '' : ''}`);

            //   
            const weekStats = {
                total: weekWorkouts.length,
                rowing: weekWorkouts.filter(w => w.type === 'rowing').length,
                strength: weekWorkouts.filter(w => w.type === 'strength').length,
                walking: weekWorkouts.filter(w => w.type === 'walking').length,
                stretch: weekWorkouts.filter(w => w.type === 'stretch').length
            };

            try {
                const prompt = `     2-3    .

:
${workoutDetails.join('\n')}

 : ${weekStats.total}  (: ${weekStats.rowing}, : ${weekStats.strength}, : ${weekStats.walking}, : ${weekStats.stretch})

     :
-  :  , stroke rate,   
-    (>150):     
-     Z2 ( ):  
-     : 
-    !

     " "    .`;

                const response = await callAI([{ role: 'user', content: prompt }], getWorkoutSystemPrompt());
                container.innerHTML = `<div class="ai-insights-context"> : ${type.emoji} ${type.name} ${lastWorkout.duration}</div><div>${response}</div>`;
            } catch (e) {
                container.innerHTML = `<div class="ai-insights-loading">   </div>`;
            }
        }

        function getWeekWorkouts() {
            const result = [];
            const today = getToday();
            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = dateToKey(d);
                const dayData = userData.days?.[key];
                if (dayData?.workouts) result.push(...dayData.workouts);
            }
            return result;
        }

        // === Workout Photos Handling ===
        window.handleWorkoutPhotos = function(event) {
            const files = Array.from(event.target.files).slice(0, 5);
            if (files.length === 0) return;

            workoutPhotos = [];
            let loaded = 0;

            files.forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    workoutPhotos[i] = e.target.result;
                    loaded++;
                    if (loaded === files.length) {
                        renderWorkoutPhotosPreview();
                        document.getElementById('analyzePhotosBtn').disabled = false;
                    }
                };
                reader.readAsDataURL(file);
            });
        };

        function renderWorkoutPhotosPreview() {
            const container = document.getElementById('workoutPhotosPreview');
            if (workoutPhotos.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            let html = workoutPhotos.map((photo, i) => `
                <div class="workout-photo-item">
                    <img src="${photo}" alt="Photo ${i+1}">
                    <button class="workout-photo-remove" onclick="removeWorkoutPhoto(${i})"></button>
                </div>
            `).join('');

            if (workoutPhotos.length < 5) {
                html += `<div class="workout-photo-item workout-photo-add" onclick="document.getElementById('workoutPhotosInput').click()">+</div>`;
            }

            container.innerHTML = html;
        }

        window.removeWorkoutPhoto = function(index) {
            workoutPhotos.splice(index, 1);
            renderWorkoutPhotosPreview();
            document.getElementById('analyzePhotosBtn').disabled = workoutPhotos.length === 0;
        };

        window.analyzeWorkoutPhotos = async function() {
            if (workoutPhotos.length === 0) {
                alert('  ');
                return;
            }

            if (!API_KEY) {
                alert(' API   ');
                return;
            }

            // Show step 2 (analyzing)
            document.getElementById('workoutStep1').classList.add('hidden');
            document.getElementById('workoutStep2').classList.remove('hidden');
            document.getElementById('analyzeStatus').textContent = `AI  ${workoutPhotos.length} ${workoutPhotos.length > 1 ? '' : ''}...`;

            try {
                // Analyze all photos
                const analysisResults = [];

                for (let i = 0; i < workoutPhotos.length; i++) {
                    document.getElementById('analyzeStatus').textContent = `  ${i+1}  ${workoutPhotos.length}...`;

                    const base64Data = workoutPhotos[i].split(',')[1];
                    try {
                        const analysisText = await callVisionAI(base64Data, WORKOUT_ANALYSIS_PROMPT);
                        const parsed = JSON.parse(analysisText.replace(/```json\n?|\n?```/g, '').trim());
                        analysisResults.push(parsed);
                    } catch (e) {
                        console.log('Could not parse photo', i, e);
                    }
                }

                // Merge results
                const merged = mergeWorkoutAnalysis(analysisResults);

                // Fill form with AI data
                fillWorkoutForm(merged);

                // Show step 3 (form)
                document.getElementById('workoutStep2').classList.add('hidden');
                document.getElementById('workoutStep3').classList.remove('hidden');

            } catch (e) {
                console.error('Workout analysis failed:', e);
                alert(' : ' + e.message);
                document.getElementById('workoutStep2').classList.add('hidden');
                document.getElementById('workoutStep1').classList.remove('hidden');
            }
        };

        function mergeWorkoutAnalysis(results) {
            if (results.length === 0) return {};

            // Find most common type
            const types = results.map(r => r.type).filter(Boolean);
            const typeCount = {};
            types.forEach(t => { typeCount[t] = (typeCount[t] || 0) + 1; });
            const type = Object.keys(typeCount).sort((a, b) => typeCount[b] - typeCount[a])[0] || null;

            // Helper to get max numeric value
            const getMax = (key) => {
                const vals = results.map(r => r[key]).filter(v => v && v > 0);
                return vals.length > 0 ? Math.max(...vals) : null;
            };

            // Get first non-null string
            const getFirst = (key) => {
                return results.map(r => r[key]).find(v => v) || null;
            };

            // Merge HR zones
            let hrZones = null;
            const zonesResults = results.map(r => r.hrZones).filter(Boolean);
            if (zonesResults.length > 0) {
                hrZones = {
                    zone1: Math.max(...zonesResults.map(z => z.zone1 || 0)),
                    zone2: Math.max(...zonesResults.map(z => z.zone2 || 0)),
                    zone3: Math.max(...zonesResults.map(z => z.zone3 || 0)),
                    zone4: Math.max(...zonesResults.map(z => z.zone4 || 0)),
                    zone5: Math.max(...zonesResults.map(z => z.zone5 || 0))
                };
            }

            // Combine notes
            const notes = results.map(r => r.notes).filter(Boolean).join(' ');

            // Merge exercises from all results
            const exercises = results
                .map(r => r.exercises)
                .filter(Boolean)
                .flat();

            // Get overall recommendation
            const overallRecommendation = results
                .map(r => r.overallRecommendation)
                .filter(Boolean)
                .join(' ');

            return {
                type,
                duration: getMax('duration'),
                distance: getMax('distance'),
                calories: getMax('calories'),
                avgHR: getMax('avgHR'),
                maxHR: getMax('maxHR'),
                hrZones,
                pace: getFirst('pace'),
                power: getMax('power'),
                strokeRate: getMax('strokeRate'),
                notes,
                exercises: exercises.length > 0 ? exercises : null,
                overallRecommendation: overallRecommendation || null
            };
        }

        function fillWorkoutForm(data) {
            // Auto-select type
            if (data.type && WORKOUT_TYPES[data.type]) {
                selectedWorkoutType = data.type;
                document.querySelectorAll('.workout-type-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.type === data.type);
                });
                updateFormFieldsVisibility(data.type);
            }

            // Fill duration
            if (data.duration) {
                document.getElementById('workoutDuration').value = data.duration;
            }

            // Fill distance
            if (data.distance) {
                document.getElementById('workoutDistance').value = data.distance;
            }

            // Fill pace
            if (data.pace) {
                document.getElementById('workoutPace').value = data.pace;
            }

            // Fill power
            if (data.power) {
                document.getElementById('workoutPower').value = data.power;
            }

            // Fill stroke rate
            if (data.strokeRate) {
                document.getElementById('workoutStrokeRate').value = data.strokeRate;
            }

            // Fill heart rate
            if (data.avgHR) {
                document.getElementById('workoutAvgHR').value = data.avgHR;
            }
            if (data.maxHR) {
                document.getElementById('workoutMaxHR').value = data.maxHR;
            }

            // Fill HR zones
            if (data.hrZones) {
                if (data.hrZones.zone1) document.getElementById('workoutZone1').value = data.hrZones.zone1;
                if (data.hrZones.zone2) document.getElementById('workoutZone2').value = data.hrZones.zone2;
                if (data.hrZones.zone3) document.getElementById('workoutZone3').value = data.hrZones.zone3;
                if (data.hrZones.zone4) document.getElementById('workoutZone4').value = data.hrZones.zone4;
                if (data.hrZones.zone5) document.getElementById('workoutZone5').value = data.hrZones.zone5;
            }

            // Fill calories
            if (data.calories) {
                document.getElementById('workoutCalories').value = data.calories;
            }

            // Show AI notes
            if (data.notes) {
                document.getElementById('aiNotesContainer').classList.remove('hidden');
                document.getElementById('aiNotes').textContent = data.notes;
            }

            // Show exercises
            if (data.exercises && data.exercises.length > 0) {
                document.getElementById('exercisesContainer').classList.remove('hidden');
                const exercisesHtml = data.exercises.map(ex => `
                    <div class="exercise-item">
                        <div class="exercise-name">${ex.name || ''}</div>
                        <div class="exercise-details">
                            ${ex.sets ? `${ex.sets} .` : ''}
                            ${ex.reps ? `  ${ex.reps}` : ''}
                            ${ex.weight ? `  ${ex.weight} ` : ''}
                        </div>
                        ${ex.recommendation ? `<div class="exercise-recommendation"> ${ex.recommendation}</div>` : ''}
                    </div>
                `).join('');
                document.getElementById('exercisesList').innerHTML = exercisesHtml;
            }

            // Show overall recommendation
            if (data.overallRecommendation) {
                document.getElementById('overallRecommendationContainer').classList.remove('hidden');
                document.getElementById('overallRecommendation').textContent = data.overallRecommendation;
            }
        }

        function updateFormFieldsVisibility(type) {
            // Show/hide fields based on workout type
            const isRowing = type === 'rowing';
            const isCardio = type === 'rowing' || type === 'walking';
            const isStrength = type === 'strength';

            // Distance - show for cardio
            document.getElementById('distanceGroup').style.display = isCardio ? 'block' : 'none';

            // Pace - show for cardio
            document.getElementById('paceGroup').style.display = isCardio ? 'block' : 'none';
            document.getElementById('paceUnit').textContent = isRowing ? '/500' : '/';

            // Power - show for rowing
            document.getElementById('powerGroup').style.display = isRowing ? 'block' : 'none';

            // Stroke rate - show for rowing
            document.getElementById('strokeRateGroup').style.display = isRowing ? 'block' : 'none';
        }

        window.showManualWorkoutForm = function() {
            document.getElementById('workoutStep1').classList.add('hidden');
            document.getElementById('workoutStep3').classList.remove('hidden');
            // Hide type-specific fields until type is selected
            document.getElementById('distanceGroup').style.display = 'none';
            document.getElementById('paceGroup').style.display = 'none';
            document.getElementById('powerGroup').style.display = 'none';
            document.getElementById('strokeRateGroup').style.display = 'none';
        };

        window.selectWorkoutType = function(type) {
            selectedWorkoutType = type;
            document.querySelectorAll('.workout-type-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.type === type);
            });
            updateFormFieldsVisibility(type);
        };

        window.selectFeeling = function(feeling) {
            selectedFeeling = feeling;
            document.querySelectorAll('.feeling-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.feeling === feeling);
            });
        };

        window.saveWorkout = async function() {
            if (!selectedWorkoutType) {
                alert('  ');
                return;
            }

            const duration = parseInt(document.getElementById('workoutDuration').value) || 0;
            if (duration < 1) {
                alert(' ');
                return;
            }

            let calories = parseInt(document.getElementById('workoutCalories').value) || 0;

            // Calculate calories if not set
            if (!calories) {
                const type = WORKOUT_TYPES[selectedWorkoutType];
                const multiplier = FEELING_MULTIPLIER[selectedFeeling] || 1;
                calories = Math.round(duration * type.caloriesPerMin * multiplier);
            }

            // Get all metrics
            const distance = parseInt(document.getElementById('workoutDistance').value) || null;
            const pace = document.getElementById('workoutPace').value.trim() || null;
            const power = parseInt(document.getElementById('workoutPower').value) || null;
            const strokeRate = parseInt(document.getElementById('workoutStrokeRate').value) || null;
            const avgHR = parseInt(document.getElementById('workoutAvgHR').value) || null;
            const maxHR = parseInt(document.getElementById('workoutMaxHR').value) || null;

            // HR Zones
            const zone1 = parseInt(document.getElementById('workoutZone1').value) || 0;
            const zone2 = parseInt(document.getElementById('workoutZone2').value) || 0;
            const zone3 = parseInt(document.getElementById('workoutZone3').value) || 0;
            const zone4 = parseInt(document.getElementById('workoutZone4').value) || 0;
            const zone5 = parseInt(document.getElementById('workoutZone5').value) || 0;
            const hrZones = (zone1 || zone2 || zone3 || zone4 || zone5)
                ? { zone1, zone2, zone3, zone4, zone5 } : null;

            const workout = {
                time: new Date().toISOString(),
                type: selectedWorkoutType,
                duration,
                feeling: selectedFeeling,
                calories,
                distance,
                pace,
                power,
                strokeRate,
                avgHR,
                maxHR,
                hrZones,
                photoCount: workoutPhotos.length
            };

            if (!todayData.workouts) todayData.workouts = [];
            todayData.workouts.push(workout);

            //   userData.days 
            if (!userData.days) userData.days = {};
            userData.days[getDateKey()] = todayData;
            await saveData();

            //       
            const savedType = WORKOUT_TYPES[selectedWorkoutType] || WORKOUT_TYPES.strength;
            const workoutCount = todayData.workouts.length;

            //    userData
            renderWeekCalendar();
            renderWorkoutHistory();
            resetWorkoutForm();
            loadWorkoutInsights();

            //    
            showWorkoutToast(` ${savedType.name} ! (${workoutCount}  )`, workoutCount > 1);
        };

        function showWorkoutToast(message, showAddMore = false) {
            //     
            const oldToast = document.querySelector('.workout-toast');
            if (oldToast) oldToast.remove();

            const toast = document.createElement('div');
            toast.className = 'workout-toast';
            toast.innerHTML = `
                <div class="toast-message">${message}</div>
                ${showAddMore ? '<div class="toast-hint">    </div>' : ''}
            `;
            document.getElementById('workoutsScreen').appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function resetWorkoutForm() {
            selectedWorkoutType = null;
            selectedFeeling = 'normal';
            workoutPhotos = [];

            // Reset all steps
            document.getElementById('workoutStep1').classList.remove('hidden');
            document.getElementById('workoutStep2').classList.add('hidden');
            document.getElementById('workoutStep3').classList.add('hidden');

            // Reset photos
            document.getElementById('workoutPhotosPreview').classList.add('hidden');
            document.getElementById('workoutPhotosPreview').innerHTML = '';
            document.getElementById('analyzePhotosBtn').disabled = true;
            document.getElementById('workoutPhotosInput').value = '';

            // Reset form fields
            document.querySelectorAll('.workout-type-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.feeling-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.feeling === 'normal');
            });

            // Reset all input fields
            document.getElementById('workoutDuration').value = '';
            document.getElementById('workoutDistance').value = '';
            document.getElementById('workoutPace').value = '';
            document.getElementById('workoutPower').value = '';
            document.getElementById('workoutStrokeRate').value = '';
            document.getElementById('workoutAvgHR').value = '';
            document.getElementById('workoutMaxHR').value = '';
            document.getElementById('workoutZone1').value = '';
            document.getElementById('workoutZone2').value = '';
            document.getElementById('workoutZone3').value = '';
            document.getElementById('workoutZone4').value = '';
            document.getElementById('workoutZone5').value = '';
            document.getElementById('workoutCalories').value = '';
            document.getElementById('aiNotesContainer').classList.add('hidden');
            document.getElementById('aiNotes').textContent = '';
            document.getElementById('exercisesContainer').classList.add('hidden');
            document.getElementById('exercisesList').innerHTML = '';
            document.getElementById('overallRecommendationContainer').classList.add('hidden');
            document.getElementById('overallRecommendation').textContent = '';

            // Reset field visibility
            document.getElementById('distanceGroup').style.display = 'none';
            document.getElementById('paceGroup').style.display = 'none';
            document.getElementById('powerGroup').style.display = 'none';
            document.getElementById('strokeRateGroup').style.display = 'none';
        }

        window.deleteWorkout = async function(dateKey, index) {
            if (!confirm(' ?')) return;

            const dayData = userData.days?.[dateKey];
            if (dayData?.workouts) {
                dayData.workouts.splice(index, 1);
                await saveData();
                renderWeekCalendar();
                renderWorkoutHistory();
            }
        };

        window.openWorkoutChat = function() {
            const container = document.getElementById('workoutChatContainer');
            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth' });
        };

        window.toggleWorkoutChat = function() {
            document.getElementById('workoutChatContainer').classList.toggle('hidden');
        };

        window.askWorkoutQuestion = async function(question) {
            if (!API_KEY) { alert(' API   '); return; }

            const container = document.getElementById('workoutChatMessages');
            container.innerHTML += `
                <div class="message user"><div class="message-avatar"></div><div class="message-bubble">${question}</div></div>
                <div class="message ai" id="workoutTyping"><div class="message-avatar"></div><div class="message-bubble"><div class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div></div></div>
            `;
            container.scrollTop = container.scrollHeight;

            const weekWorkouts = getWeekWorkouts();
            const todayWorkoutsList = (todayData?.workouts || []).map(w => {
                const type = WORKOUT_TYPES[w.type] || { name: w.type, emoji: '' };
                return `${type.emoji} ${type.name} ${w.duration}`;
            }).join(', ');

            const context = `
  :
- Oura Readiness: ${todayData?.oura?.readiness || todayData?.morning?.oura || ' '}
- HRV: ${todayData?.oura?.hrv ? Math.round(todayData.oura.hrv) + ' ' : ' '}
-  : ${todayData?.morning?.bp_sys ? todayData.morning.bp_sys + '/' + todayData.morning.bp_dia : ' '}
-  : ${todayWorkoutsList || '  '}
-   : ${weekWorkouts.length}
`.trim();
            workoutChatHistory.push({ role: 'user', content: context + '\n\n: ' + question });

            try {
                const response = await callAI(workoutChatHistory, getWorkoutSystemPrompt());
                document.getElementById('workoutTyping')?.remove();
                workoutChatHistory.push({ role: 'assistant', content: response });
                container.innerHTML += `<div class="message ai"><div class="message-avatar"></div><div class="message-bubble">${response}</div></div>`;
            } catch (e) {
                document.getElementById('workoutTyping')?.remove();
                container.innerHTML += `<div class="message ai"><div class="message-avatar"></div><div class="message-bubble">: ${e.message}</div></div>`;
            }
            container.scrollTop = container.scrollHeight;
        };

        window.sendWorkoutChatMessage = async function() {
            const input = document.getElementById('workoutChatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askWorkoutQuestion(msg);
        };

        window.handleWorkoutChatKeypress = function(e) { if (e.key === 'Enter') sendWorkoutChatMessage(); };

        // === EVENING ===
        let eveningChatHistory = [];
        
        const EVENING_AI_SYSTEM_BASE = `  AI-      .

  ():
 48 ,  I .,  
 : ,  5
 : 2100 ,  200,   90
 ACTN3 XX      
   ~350   
    (6 /)  4-7-8

         :

  :
      ( ? ?)
     (//)
      

  (   !):
 HRV: //?   ?
 : ,   //
 :    ?
    

   :
   Readiness (   )
   :  /  / ?
 :   ?  ?

    (!):
      
    (1-2 )
   /

   ( ):
 HRV  3+      
       , 
      

 ,  .         !`;

        //      
        function getEveningSystemPrompt() {
            const recentContext = buildRecentContext(7);
            const memoryContext = buildMemoryContext(); //  
            return EVENING_AI_SYSTEM_BASE + (recentContext ? '\n\n' + recentContext : '') + memoryContext;
        }

        function updateEvening() {
            document.getElementById('eveningDate').textContent = formatDate(getToday());
            
            // Morning BP
            if (todayData?.morning?.bp_sys) {
                const m = todayData.morning;
                document.getElementById('morningBpValue').textContent = `${m.bp_sys}/${m.bp_dia}`;
            } else {
                document.getElementById('morningBpValue').textContent = '';
            }
            
            // Evening BP
            if (todayData?.evening?.bp_sys) {
                const e = todayData.evening;
                document.getElementById('eveningBpValue').textContent = `${e.bp_sys}/${e.bp_dia}`;
                document.getElementById('eveningBpSystolic').value = e.bp_sys;
                document.getElementById('eveningBpDiastolic').value = e.bp_dia;
                document.getElementById('eveningPulse').value = e.pulse;
                updateBpComparison();
            }
            
            // Day summary
            if (todayData?.morning) {
                const dt = todayData.morning.day_type;
                const el = document.getElementById('summaryDayType');
                el.textContent = dt === 'strong' ? ' ' : dt === 'normal' ? ' ' : ' ';
            }
            
            // Habits
            const min = ['steps_min', 'protein_meal', 'breathing'];
            const ch = todayData?.habits || {};
            const done = min.filter(id => ch[id]).length;
            const habitsEl = document.getElementById('summaryHabits');
            habitsEl.textContent = `${done}/3 `;
            habitsEl.className = 'day-summary-value ' + (done === 3 ? 'good' : done >= 2 ? 'warning' : 'bad');
            
            // Nutrition
            const totals = getTotals();
            const calEl = document.getElementById('summaryCalories');
            calEl.textContent = `${totals.calories} / 2100`;
            calEl.className = 'day-summary-value ' + (totals.calories > 2300 ? 'bad' : totals.calories > 2100 ? 'warning' : 'good');

            const protEl = document.getElementById('summaryProtein');
            protEl.textContent = `${totals.protein} / 200`;
            protEl.className = 'day-summary-value ' + (totals.protein >= 180 ? 'good' : totals.protein >= 150 ? 'warning' : 'bad');

            // Workouts
            const workoutsEl = document.getElementById('summaryWorkouts');
            const workouts = todayData?.workouts || [];
            if (workouts.length > 0) {
                const totalWorkoutMin = workouts.reduce((sum, w) => sum + (w.duration || 0), 0);
                const totalWorkoutCal = workouts.reduce((sum, w) => sum + (w.calories || 0), 0);
                workoutsEl.textContent = `${workouts.length} , ${totalWorkoutMin} , ${totalWorkoutCal} `;
                workoutsEl.className = 'day-summary-value good';
            } else {
                workoutsEl.textContent = ' ';
                workoutsEl.className = 'day-summary-value';
            }

            // Breathing summary
            const sessions = todayData?.breathing || [];
            const breathEl = document.getElementById('summaryBreathing');
            if (sessions.length > 0) {
                const totalMin = sessions.reduce((sum, s) => sum + (s.duration || 0), 0);
                breathEl.textContent = `${sessions.length} , ${totalMin} `;
                breathEl.className = 'day-summary-value good';
            } else {
                breathEl.textContent = ' ';
                breathEl.className = 'day-summary-value warning';
            }

            // End day time
            const now = new Date();
            document.getElementById('endDayTime').textContent = ` ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

            // Check if day already ended
            if (todayData?.dayEnded) {
                showDayCompletedMessage();
            }

            // Render breathing log
            renderBreathingLog();
            
            // Rating
            if (todayData?.evening?.rating) {
                updateRatingUI(todayData.evening.rating);
            }
            
            // Sleep checklist
            updateSleepChecklist();

            // Nutrition feedback
            updateNutritionFeedbackUI();
        }

        // === END DAY ===
        window.endDay = async function() {
            const btn = document.getElementById('endDayBtn');
            btn.disabled = true;
            btn.textContent = ' ...';

            try {
                if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
                if (!todayData.evening) todayData.evening = {};

                //    
                todayData.dayEnded = true;
                todayData.endedAt = new Date().toISOString();

                //   
                const totals = getTotals();
                const habits = todayData.habits || {};
                const minHabits = ['steps_min', 'protein_meal', 'breathing'];
                const habitsCompleted = minHabits.filter(h => habits[h]).length;

                todayData.daySummary = {
                    calories: totals.calories,
                    protein: totals.protein,
                    habitsCompleted: habitsCompleted,
                    workoutsCount: (todayData.workouts || []).length,
                    breathingSessions: (todayData.breathing || []).length,
                    rating: todayData.evening?.rating
                };

                userData.days[getDateKey()] = todayData;
                await saveData();

                //    
                showDayCompletedMessage();

            } catch(e) {
                console.error('End day error:', e);
                btn.disabled = false;
                btn.textContent = '  ';
                alert('  : ' + e.message);
            }
        };

        function showDayCompletedMessage() {
            //  
            document.querySelector('.end-day-section').classList.add('hidden');

            //  
            const msg = document.getElementById('dayCompletedMessage');
            msg.classList.remove('hidden');

            //  
            const stats = todayData?.daySummary || {};
            const statsHtml = `
                <div> : ${stats.habitsCompleted || 0}/3</div>
                <div> : ${stats.calories || 0} / 2100</div>
                <div> : ${stats.protein || 0} / 200</div>
                ${stats.rating ? `<div> : ${''.split('')[stats.rating-1] || stats.rating}/5</div>` : ''}
            `;
            document.getElementById('completedDayStats').innerHTML = statsHtml;
        }

        window.undoEndDay = async function() {
            if (!confirm('  ?    .')) return;

            try {
                //   
                delete todayData.dayEnded;
                delete todayData.endedAt;
                delete todayData.daySummary;

                userData.days[getDateKey()] = todayData;
                await saveData();

                //    
                document.getElementById('dayCompletedMessage').classList.add('hidden');

                //    
                const endSection = document.querySelector('.end-day-section');
                endSection.classList.remove('hidden');

                //  
                const btn = document.getElementById('endDayBtn');
                btn.disabled = false;
                btn.textContent = '  ';

            } catch(e) {
                console.error('Undo end day error:', e);
                alert(': ' + e.message);
            }
        };

        function updateBpComparison() {
            //       
            if (!todayData?.morning?.bp_sys || !todayData?.evening?.bp_sys) {
                const badge = document.getElementById('bpChangeValue');
                if (badge) {
                    badge.textContent = '';
                    badge.className = 'bp-change-badge';
                }
                return;
            }

            const m = todayData.morning;
            const e = todayData.evening;
            const diff = e.bp_sys - m.bp_sys;

            const badge = document.getElementById('bpChangeValue');
            if (diff < -5) {
                badge.textContent = ` ${Math.abs(diff)}   !`;
                badge.className = 'bp-change-badge good';
            } else if (diff <= 5) {
                badge.textContent = ` `;
                badge.className = 'bp-change-badge warning';
            } else {
                badge.textContent = ` ${diff}   `;
                badge.className = 'bp-change-badge bad';
            }
        }
        
        window.saveEveningBP = async function() {
            const sys = parseInt(document.getElementById('eveningBpSystolic').value);
            const dia = parseInt(document.getElementById('eveningBpDiastolic').value);
            const pulse = parseInt(document.getElementById('eveningPulse').value);
            
            if (!sys || !dia || !pulse) { alert('  '); return; }
            
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.evening) todayData.evening = {};
            
            todayData.evening.bp_sys = sys;
            todayData.evening.bp_dia = dia;
            todayData.evening.pulse = pulse;
            todayData.evening.bp_time = new Date().toISOString();
            
            userData.days[getDateKey()] = todayData;
            await saveData();
            
            document.getElementById('eveningBpValue').textContent = `${sys}/${dia}`;
            updateBpComparison();
            
            alert(' !');
        };
        
        // Breathing sessions
        const BREATHING_TYPES = {
            'resonance': { name: '', emoji: '', desc: '6 /' },
            '478': { name: '4-7-8', emoji: '', desc: '' },
            'box': { name: '', emoji: '', desc: '4-4-4-4' },
            'other': { name: '', emoji: '', desc: '' }
        };
        
        window.addBreathingSession = async function() {
            const type = document.getElementById('breathingType').value;
            const duration = parseInt(document.getElementById('breathingDuration').value);
            const rmssd = parseInt(document.getElementById('breathingRmssd').value) || null;
            
            if (!duration) { alert(' '); return; }
            
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.breathing) todayData.breathing = [];
            
            todayData.breathing.push({
                type,
                duration,
                rmssd,
                time: new Date().toISOString()
            });
            
            userData.days[getDateKey()] = todayData;
            await saveData();
            
            // Clear inputs
            document.getElementById('breathingDuration').value = '';
            document.getElementById('breathingRmssd').value = '';
            
            renderBreathingLog();
            updateEvening();
        };
        
        function renderBreathingLog() {
            const container = document.getElementById('breathingLogContainer');
            const sessions = todayData?.breathing || [];
            
            if (sessions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 12px;">  </div>';
                return;
            }
            
            container.innerHTML = sessions.map((s, i) => {
                const t = BREATHING_TYPES[s.type] || BREATHING_TYPES.other;
                return `
                    <div class="breathing-log-item">
                        <div class="breathing-log-icon">${t.emoji}</div>
                        <div class="breathing-log-info">
                            <div class="breathing-log-type">${t.name}</div>
                            <div class="breathing-log-details">${s.duration} ${s.rmssd ? `  RMSSD: ${s.rmssd}` : ''}</div>
                            <div class="breathing-log-time">${formatTime(s.time)}</div>
                        </div>
                        <button class="breathing-log-delete" onclick="deleteBreathingSession(${i})"></button>
                    </div>
                `;
            }).join('');
        }
        
        window.deleteBreathingSession = async function(index) {
            if (!confirm(' ?')) return;
            todayData.breathing.splice(index, 1);
            userData.days[getDateKey()] = todayData;
            await saveData();
            renderBreathingLog();
            updateEvening();
        };
        
        // Day rating
        window.rateDay = async function(rating) {
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.evening) todayData.evening = {};
            
            todayData.evening.rating = rating;
            userData.days[getDateKey()] = todayData;
            await saveData();
            
            updateRatingUI(rating);
        };
        
        function updateRatingUI(rating) {
            const labels = ['', '  ', '  ', ' ', '! ', ' ! '];
            document.getElementById('dayRatingLabel').textContent = labels[rating];

            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.rating) === rating);
            });
        }

        // === NUTRITION FEEDBACK ===
        window.setNutritionFeeling = async function(feeling) {
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.evening) todayData.evening = {};
            if (!todayData.evening.nutrition) todayData.evening.nutrition = {};

            todayData.evening.nutrition.feeling = feeling;
            userData.days[getDateKey()] = todayData;
            await saveData();

            // Update UI
            document.querySelectorAll('#nutritionFeelingBtns .feedback-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.value === feeling);
            });
            showFeedbackSaved();
        };

        window.setNutritionLogged = async function(isComplete) {
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.evening) todayData.evening = {};
            if (!todayData.evening.nutrition) todayData.evening.nutrition = {};

            todayData.evening.nutrition.fullyLogged = isComplete;
            userData.days[getDateKey()] = todayData;
            await saveData();

            // Update UI
            document.querySelectorAll('#nutritionLoggedBtns .feedback-btn').forEach(btn => {
                const btnValue = btn.dataset.value === 'yes';
                btn.classList.toggle('selected', btnValue === isComplete);
            });

            // Show/hide missed food section
            document.getElementById('missedFoodSection').classList.toggle('hidden', isComplete);

            if (isComplete) {
                showFeedbackSaved();
            }
        };

        window.analyzeMissedFood = async function() {
            const input = document.getElementById('missedFoodInput');
            const text = input.value.trim();
            if (!text) {
                alert('   ');
                return;
            }

            const btn = document.getElementById('analyzeMissedBtn');
            const result = document.getElementById('missedFoodResult');
            btn.disabled = true;
            btn.textContent = ' ...';

            try {
                const response = await callAI([{
                    role: 'user',
                    content: `      : "${text}".
    .    :
- : ~X 
- : ~X, : ~X, : ~X
- : ~X ( )
      .`
                }], FOOD_ANALYSIS_PROMPT);

                // Save the missed food info
                if (!todayData.evening.nutrition.missed) todayData.evening.nutrition.missed = {};
                todayData.evening.nutrition.missed.description = text;
                todayData.evening.nutrition.missed.aiAnalysis = response;
                userData.days[getDateKey()] = todayData;
                await saveData();

                // Show result
                result.classList.remove('hidden');
                result.innerHTML = `
                    <div style="margin-bottom: 8px;"><b> AI :</b></div>
                    <div>${response.replace(/\n/g, '<br>')}</div>
                    <div class="missed-food-added">    </div>
                `;
                showFeedbackSaved();

            } catch(e) {
                result.classList.remove('hidden');
                result.innerHTML = '<div style="color: #f87171;"> .  .</div>';
            }

            btn.disabled = false;
            btn.textContent = '  AI';
        };

        function showFeedbackSaved() {
            const el = document.getElementById('nutritionFeedbackSaved');
            el.classList.remove('hidden');
            el.classList.add('show');
            setTimeout(() => {
                el.classList.remove('show');
            }, 2000);
        }

        function updateNutritionFeedbackUI() {
            const nutrition = todayData?.evening?.nutrition;
            if (!nutrition) return;

            // Feeling buttons
            if (nutrition.feeling) {
                document.querySelectorAll('#nutritionFeelingBtns .feedback-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.value === nutrition.feeling);
                });
            }

            // Logged buttons
            if (nutrition.fullyLogged !== undefined) {
                document.querySelectorAll('#nutritionLoggedBtns .feedback-btn').forEach(btn => {
                    const btnValue = btn.dataset.value === 'yes';
                    btn.classList.toggle('selected', btnValue === nutrition.fullyLogged);
                });
                document.getElementById('missedFoodSection').classList.toggle('hidden', nutrition.fullyLogged);
            }

            // Missed food
            if (nutrition.missed?.description) {
                document.getElementById('missedFoodInput').value = nutrition.missed.description;
                if (nutrition.missed.aiAnalysis) {
                    const result = document.getElementById('missedFoodResult');
                    result.classList.remove('hidden');
                    result.innerHTML = `
                        <div style="margin-bottom: 8px;"><b> AI :</b></div>
                        <div>${nutrition.missed.aiAnalysis.replace(/\n/g, '<br>')}</div>
                        <div class="missed-food-added">    </div>
                    `;
                }
            }
        }

        // Sleep checklist
        function updateSleepChecklist() {
            const items = todayData?.evening?.sleep || {};
            document.querySelectorAll('.sleep-item').forEach(el => {
                el.classList.toggle('checked', !!items[el.dataset.id]);
            });
        }
        
        window.toggleSleepItem = async function(id) {
            if (!todayData) todayData = { habits: {}, meals: [], breathing: [] };
            if (!todayData.evening) todayData.evening = {};
            if (!todayData.evening.sleep) todayData.evening.sleep = {};
            
            todayData.evening.sleep[id] = !todayData.evening.sleep[id];
            userData.days[getDateKey()] = todayData;
            await saveData();
            
            updateSleepChecklist();
        };
        
        // Evening AI analysis
        window.getEveningAnalysis = async function() {
            document.getElementById('getEveningAnalysis').disabled = true;
            document.getElementById('eveningAnalysisResult').classList.remove('hidden');
            addTypingIndicator('eveningChatMessages');
            
            // Build context
            const m = todayData?.morning || {};
            const e = todayData?.evening || {};
            const totals = getTotals();
            const sessions = todayData?.breathing || [];
            const habits = todayData?.habits || {};
            const minDone = ['steps_min', 'protein_meal', 'breathing'].filter(id => habits[id]).length;
            
            let breathingInfo = ' ';
            if (sessions.length > 0) {
                breathingInfo = sessions.map(s => {
                    const t = BREATHING_TYPES[s.type];
                    return `${t.name} ${s.duration}${s.rmssd ? ` (RMSSD ${s.rmssd})` : ''}`;
                }).join(', ');
            }
            
            const request = `  :

:
 Oura Readiness: ${m.oura || '?'}/100
  : ${m.bp_sys || '?'}/${m.bp_dia || '?'}
  : ${m.day_type || '?'}

:
  : ${e.bp_sys || ' '}/${e.bp_dia || ''}
${e.bp_sys && m.bp_sys ? ` : ${e.bp_sys - m.bp_sys > 0 ? '+' : ''}${e.bp_sys - m.bp_sys} ` : ''}

:
 : ${totals.calories}/2100
 : ${totals.protein}/200
 : ${totals.fiber}/30

:
 ${breathingInfo}

:
  : ${minDone}/3

       .`;
            
            eveningChatHistory = [{ role: 'user', content: request }];
            const response = await callAI(eveningChatHistory, getEveningSystemPrompt());
            removeTypingIndicator();

            eveningChatHistory.push({ role: 'assistant', content: response });
            addMessage('eveningChatMessages', 'ai', response);

            document.getElementById('getEveningAnalysis').disabled = false;

            //      ( )
            extractFactsFromConversation(request + '\n\n AI:\n' + response, 'evening');
        };
        
        window.askEveningQuestion = async function(q) {
            eveningChatHistory.push({ role: 'user', content: q });
            addMessage('eveningChatMessages', 'user', q);
            addTypingIndicator('eveningChatMessages');
            
            const response = await callAI(eveningChatHistory, getEveningSystemPrompt());
            removeTypingIndicator();
            
            eveningChatHistory.push({ role: 'assistant', content: response });
            addMessage('eveningChatMessages', 'ai', response);
        };
        
        window.sendEveningChatMessage = async function() {
            const input = document.getElementById('eveningChatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            await askEveningQuestion(msg);
        };
        
        window.handleEveningChatKeypress = function(e) { if (e.key === 'Enter') sendEveningChatMessage(); };
        
        // === TRENDS ===
        let trendsPeriod = 7;
        
        window.setPeriod = function(days) {
            trendsPeriod = days;
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.dataset.period) === days);
            });
            updateTrends();
        };
        
        function getHistoricalData(days) {
            const data = [];
            const now = new Date();
            
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const key = dateToKey(d);
                const dayData = userData.days?.[key] || null;
                
                data.push({
                    date: key,
                    label: d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }),
                    shortLabel: d.getDate().toString(),
                    morning: dayData?.morning || null,
                    evening: dayData?.evening || null,
                    oura: dayData?.oura || null,
                    meals: dayData?.meals || [],
                    habits: dayData?.habits || {},
                    breathing: dayData?.breathing || [],
                    workouts: dayData?.workouts || []
                });
            }
            
            return data;
        }
        
        function drawLineChart(canvasId, datasets, options = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.clientWidth;
            const height = parseInt(canvas.getAttribute('height'));
            
            canvas.width = width;
            canvas.height = height;
            
            const padding = { top: 20, right: 15, bottom: 30, left: 40 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Clear
            ctx.clearRect(0, 0, width, height);
            
            // Find min/max
            let allValues = [];
            datasets.forEach(ds => {
                ds.data.forEach(v => { if (v !== null) allValues.push(v); });
            });
            
            if (allValues.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(' ', width / 2, height / 2);
                return;
            }
            
            const minVal = options.minY ?? Math.min(...allValues) * 0.9;
            const maxVal = options.maxY ?? Math.max(...allValues) * 1.1;
            const range = maxVal - minVal || 1;
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                // Y labels
                const val = Math.round(maxVal - (range / 4) * i);
                ctx.fillStyle = '#64748b';
                ctx.font = '10px -apple-system, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(val.toString(), padding.left - 8, y + 3);
            }
            
            // X labels
            const points = datasets[0].data.length;
            const stepX = chartWidth / (points - 1 || 1);
            
            ctx.fillStyle = '#64748b';
            ctx.font = '10px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            
            for (let i = 0; i < points; i++) {
                if (points <= 7 || i % Math.ceil(points / 7) === 0 || i === points - 1) {
                    const x = padding.left + stepX * i;
                    ctx.fillText(datasets[0].labels?.[i] || '', x, height - 8);
                }
            }
            
            // Draw lines
            datasets.forEach(ds => {
                ctx.strokeStyle = ds.color;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                let started = false;
                
                ds.data.forEach((val, i) => {
                    if (val === null) return;
                    
                    const x = padding.left + stepX * i;
                    const y = padding.top + chartHeight - ((val - minVal) / range) * chartHeight;
                    
                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // Draw points
                ds.data.forEach((val, i) => {
                    if (val === null) return;
                    
                    const x = padding.left + stepX * i;
                    const y = padding.top + chartHeight - ((val - minVal) / range) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = ds.color;
                    ctx.fill();
                });
            });
            
            // Draw target line if specified
            if (options.targetLine) {
                const targetY = padding.top + chartHeight - ((options.targetLine.value - minVal) / range) * chartHeight;
                ctx.strokeStyle = options.targetLine.color || '#fbbf24';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding.left, targetY);
                ctx.lineTo(width - padding.right, targetY);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        function drawBarChart(canvasId, data, options = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.clientWidth;
            const height = parseInt(canvas.getAttribute('height'));
            
            canvas.width = width;
            canvas.height = height;
            
            const padding = { top: 15, right: 15, bottom: 30, left: 30 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            ctx.clearRect(0, 0, width, height);
            
            const values = data.values.filter(v => v !== null);
            if (values.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(' ', width / 2, height / 2);
                return;
            }
            
            const maxVal = options.maxY ?? Math.max(...values, 1);
            const barCount = data.values.length;
            const barWidth = (chartWidth / barCount) * 0.7;
            const gap = (chartWidth / barCount) * 0.3;
            
            data.values.forEach((val, i) => {
                const x = padding.left + (chartWidth / barCount) * i + gap / 2;
                const barHeight = val !== null ? (val / maxVal) * chartHeight : 0;
                const y = padding.top + chartHeight - barHeight;
                
                // Bar
                const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                gradient.addColorStop(0, data.color || '#3b82f6');
                gradient.addColorStop(1, data.colorEnd || data.color || '#3b82f6');
                
                ctx.fillStyle = val !== null ? gradient : 'rgba(255,255,255,0.05)';
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight || 2, 4);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#64748b';
                ctx.font = '10px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(data.labels?.[i] || '', x + barWidth / 2, height - 8);
            });
        }

        function drawStackedBarChart(canvasId, data, options = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.clientWidth;
            const height = parseInt(canvas.getAttribute('height'));

            canvas.width = width;
            canvas.height = height;

            const padding = { top: 15, right: 15, bottom: 30, left: 30 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            ctx.clearRect(0, 0, width, height);

            const barCount = data.labels.length;
            const barWidth = (chartWidth / barCount) * 0.7;
            const gap = (chartWidth / barCount) * 0.3;
            const maxVal = options.maxY || 3;

            // Draw bars
            for (let i = 0; i < barCount; i++) {
                const x = padding.left + (chartWidth / barCount) * i + gap / 2;
                let currentY = padding.top + chartHeight;

                // Stack each dataset
                data.datasets.forEach(ds => {
                    const val = ds.data[i] || 0;
                    if (val > 0) {
                        const barHeight = (val / maxVal) * chartHeight;
                        currentY -= barHeight;

                        ctx.fillStyle = ds.color;
                        ctx.beginPath();
                        ctx.roundRect(x, currentY, barWidth, barHeight - 1, 3);
                        ctx.fill();
                    }
                });

                // X label
                ctx.fillStyle = '#64748b';
                ctx.font = '10px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(data.labels[i], x + barWidth / 2, height - 8);
            }

            // Draw grid lines
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= maxVal; i++) {
                const y = padding.top + chartHeight - (i / maxVal) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
            }
        }

        function updateTrends() {
            const data = getHistoricalData(trendsPeriod);
            
            // BP Chart
            const bpSysData = data.map(d => d.morning?.bp_sys || null);
            const bpDiaData = data.map(d => d.morning?.bp_dia || null);
            const labels = data.map(d => d.shortLabel);
            
            drawLineChart('bpChart', [
                { data: bpSysData, color: '#ef4444', labels },
                { data: bpDiaData, color: '#3b82f6', labels }
            ], { minY: 60, maxY: 160, targetLine: { value: 130, color: '#fbbf24' } });
            
            // BP Stats
            const validBpSys = bpSysData.filter(v => v !== null);
            const avgSys = validBpSys.length ? Math.round(validBpSys.reduce((a, b) => a + b, 0) / validBpSys.length) : null;
            const validBpDia = bpDiaData.filter(v => v !== null);
            const avgDia = validBpDia.length ? Math.round(validBpDia.reduce((a, b) => a + b, 0) / validBpDia.length) : null;
            
            document.getElementById('bpStats').innerHTML = avgSys ? `
                <div class="chart-stat">
                    <div class="chart-stat-value ${avgSys < 130 ? 'good' : avgSys < 140 ? 'warning' : 'bad'}">${avgSys}/${avgDia}</div>
                    <div class="chart-stat-label"></div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${Math.min(...validBpSys)}</div>
                    <div class="chart-stat-label"> .</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${Math.max(...validBpSys)}</div>
                    <div class="chart-stat-label"> .</div>
                </div>
            ` : '<div class="no-data-message"> </div>';
            
            // Oura Chart
            const ouraData = data.map(d => d.morning?.oura || null);
            drawLineChart('ouraChart', [
                { data: ouraData, color: '#8b5cf6', labels }
            ], { minY: 40, maxY: 100, targetLine: { value: 70, color: '#fbbf24' } });
            
            const validOura = ouraData.filter(v => v !== null);
            const avgOura = validOura.length ? Math.round(validOura.reduce((a, b) => a + b, 0) / validOura.length) : null;
            
            document.getElementById('ouraStats').innerHTML = avgOura ? `
                <div class="chart-stat">
                    <div class="chart-stat-value ${avgOura >= 80 ? 'good' : avgOura >= 65 ? 'warning' : 'bad'}">${avgOura}</div>
                    <div class="chart-stat-label"></div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${Math.max(...validOura)}</div>
                    <div class="chart-stat-label"></div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${validOura.filter(v => v >= 70).length}/${validOura.length}</div>
                    <div class="chart-stat-label"> 70</div>
                </div>
            ` : '<div class="no-data-message"> </div>';
            
            // Nutrition Chart
            const caloriesData = data.map(d => d.meals.length ? d.meals.reduce((sum, m) => sum + (m.calories || 0), 0) : null);
            const proteinData = data.map(d => d.meals.length ? d.meals.reduce((sum, m) => sum + (m.protein || 0), 0) : null);
            
            drawLineChart('nutritionChart', [
                { data: caloriesData.map(v => v ? v / 21 : null), color: '#8b5cf6', labels }, // Scale calories to fit with protein
                { data: proteinData, color: '#10b981', labels }
            ], { minY: 0, maxY: 220, targetLine: { value: 100, color: '#fbbf24' } });
            
            const validCal = caloriesData.filter(v => v !== null);
            const avgCal = validCal.length ? Math.round(validCal.reduce((a, b) => a + b, 0) / validCal.length) : null;
            const validProt = proteinData.filter(v => v !== null);
            const avgProt = validProt.length ? Math.round(validProt.reduce((a, b) => a + b, 0) / validProt.length) : null;
            
            document.getElementById('nutritionStats').innerHTML = avgCal ? `
                <div class="chart-stat">
                    <div class="chart-stat-value">${avgCal}</div>
                    <div class="chart-stat-label">/</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value ${avgProt >= 180 ? 'good' : avgProt >= 150 ? 'warning' : 'bad'}">${avgProt}</div>
                    <div class="chart-stat-label">/</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${validCal.length}</div>
                    <div class="chart-stat-label"> </div>
                </div>
            ` : '<div class="no-data-message"> </div>';
            
            // Habits Chart
            const habitsData = data.map(d => {
                const min = ['steps_min', 'protein_meal', 'breathing'];
                const done = min.filter(id => d.habits[id]).length;
                return done;
            });
            
            drawBarChart('habitsChart', {
                values: habitsData,
                labels,
                color: '#10b981',
                colorEnd: '#059669'
            }, { maxY: 3 });
            
            const daysComplete = habitsData.filter(v => v === 3).length;
            document.getElementById('habitsStats').innerHTML = `
                <div class="chart-stat">
                    <div class="chart-stat-value ${daysComplete >= trendsPeriod * 0.8 ? 'good' : daysComplete >= trendsPeriod * 0.5 ? 'warning' : 'bad'}">${daysComplete}/${trendsPeriod}</div>
                    <div class="chart-stat-label">  </div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${Math.round(daysComplete / trendsPeriod * 100)}%</div>
                    <div class="chart-stat-label"></div>
                </div>
            `;
            
            // Breathing Chart
            const breathingData = data.map(d => d.breathing.length ? d.breathing.reduce((sum, s) => sum + (s.duration || 0), 0) : null);
            
            drawBarChart('breathingChart', {
                values: breathingData.map(v => v || 0),
                labels,
                color: '#8b5cf6',
                colorEnd: '#7c3aed'
            }, { maxY: 30 });
            
            const validBreathing = breathingData.filter(v => v !== null && v > 0);
            const avgBreathing = validBreathing.length ? Math.round(validBreathing.reduce((a, b) => a + b, 0) / validBreathing.length) : 0;
            
            document.getElementById('breathingStats').innerHTML = `
                <div class="chart-stat">
                    <div class="chart-stat-value">${avgBreathing}</div>
                    <div class="chart-stat-label">/</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${validBreathing.length}</div>
                    <div class="chart-stat-label"> </div>
                </div>
            `;

            // Workouts Chart
            const workoutsPerDay = data.map(d => d.workouts.length || 0);
            const rowingData = data.map(d => d.workouts.filter(w => w.type === 'rowing').length);
            const strengthData = data.map(d => d.workouts.filter(w => w.type === 'strength').length);
            const walkingData = data.map(d => d.workouts.filter(w => w.type === 'walking').length);
            const stretchData = data.map(d => d.workouts.filter(w => w.type === 'stretch').length);

            // Draw stacked bar chart for workouts
            drawStackedBarChart('workoutsChart', {
                labels,
                datasets: [
                    { data: rowingData, color: '#f59e0b' },
                    { data: strengthData, color: '#ef4444' },
                    { data: walkingData, color: '#10b981' },
                    { data: stretchData, color: '#8b5cf6' }
                ]
            }, { maxY: 3 });

            // Workout stats
            const totalWorkouts = workoutsPerDay.reduce((a, b) => a + b, 0);
            const daysWithWorkout = workoutsPerDay.filter(v => v > 0).length;
            const totalRowing = rowingData.reduce((a, b) => a + b, 0);
            const totalStrength = strengthData.reduce((a, b) => a + b, 0);
            const totalWalking = walkingData.reduce((a, b) => a + b, 0);
            const totalStretch = stretchData.reduce((a, b) => a + b, 0);

            // Calculate total duration and calories
            let totalDuration = 0;
            let totalCalories = 0;
            data.forEach(d => {
                d.workouts.forEach(w => {
                    totalDuration += w.duration || 0;
                    totalCalories += w.calories || 0;
                });
            });

            document.getElementById('workoutsStats').innerHTML = totalWorkouts > 0 ? `
                <div class="chart-stat">
                    <div class="chart-stat-value ${daysWithWorkout >= 4 ? 'good' : daysWithWorkout >= 2 ? 'warning' : 'bad'}">${totalWorkouts}</div>
                    <div class="chart-stat-label"></div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${daysWithWorkout}/${trendsPeriod}</div>
                    <div class="chart-stat-label"></div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${totalDuration}</div>
                    <div class="chart-stat-label"></div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-value">${totalCalories}</div>
                    <div class="chart-stat-label"></div>
                </div>
            ` : '<div class="no-data-message"> </div>';

            // Weight Chart
            const weightData = data.map(d => d.morning?.weight || null);
            const validWeight = weightData.filter(v => v !== null);

            if (validWeight.length > 0) {
                document.getElementById('weightChartCard').style.display = 'block';

                const minWeight = Math.min(...validWeight);
                const maxWeight = Math.max(...validWeight);
                const range = maxWeight - minWeight;
                const chartMinY = Math.floor(minWeight - range * 0.5 - 1);
                const chartMaxY = Math.ceil(maxWeight + range * 0.5 + 1);

                drawLineChart('weightChart', [
                    { data: weightData, color: '#f59e0b', labels }
                ], { minY: chartMinY, maxY: chartMaxY });

                const avgWeight = (validWeight.reduce((a, b) => a + b, 0) / validWeight.length).toFixed(1);
                const firstWeight = validWeight[0];
                const lastWeight = validWeight[validWeight.length - 1];
                const weightDiff = (lastWeight - firstWeight).toFixed(1);
                const diffClass = weightDiff < 0 ? 'good' : weightDiff > 0 ? 'warning' : '';
                const diffSign = weightDiff > 0 ? '+' : '';

                document.getElementById('weightStats').innerHTML = `
                    <div class="chart-stat">
                        <div class="chart-stat-value">${avgWeight}</div>
                        <div class="chart-stat-label">, </div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-value ${diffClass}">${diffSign}${weightDiff}</div>
                        <div class="chart-stat-label"></div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-value">${validWeight.length}</div>
                        <div class="chart-stat-label"></div>
                    </div>
                `;
            } else {
                document.getElementById('weightChartCard').style.display = 'none';
            }

            // HRV Chart
            const hrvData = data.map(d => d.oura?.hrv || null);
            const restingHrData = data.map(d => d.oura?.resting_hr || null);
            const validHrv = hrvData.filter(v => v !== null);
            const validRestingHr = restingHrData.filter(v => v !== null);

            if (validHrv.length > 0) {
                document.getElementById('hrvChartCard').style.display = 'block';

                //        HRV
                // HRV  20-80,   50-70 -   
                drawLineChart('hrvChart', [
                    { data: hrvData, color: '#10b981', labels },
                    { data: restingHrData, color: '#ef4444', labels }
                ], { minY: 30, maxY: 80 });

                const avgHrv = Math.round(validHrv.reduce((a, b) => a + b, 0) / validHrv.length);
                const maxHrv = Math.max(...validHrv);
                const minHrv = Math.min(...validHrv);
                const avgRestingHr = validRestingHr.length
                    ? Math.round(validRestingHr.reduce((a, b) => a + b, 0) / validRestingHr.length)
                    : null;

                //   HRV
                let hrvTrend = '';
                if (validHrv.length >= 3) {
                    const recent = validHrv.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
                    const older = validHrv.slice(-3).reduce((a, b) => a + b, 0) / validHrv.slice(-3).length;
                    const diff = recent - older;
                    if (Math.abs(diff) >= 3) {
                        hrvTrend = diff > 0 ? '' : '';
                    }
                }

                //     45-50 
                let percentileText = '';
                let percentileClass = '';
                if (avgHrv >= HRV_THRESHOLDS.populationP90) {
                    percentileText = ' 10%';
                    percentileClass = 'good';
                } else if (avgHrv >= HRV_THRESHOLDS.populationP75) {
                    percentileText = ' 25%';
                    percentileClass = 'good';
                } else if (avgHrv >= HRV_THRESHOLDS.populationMedian) {
                    percentileText = ' ';
                    percentileClass = '';
                } else if (avgHrv >= HRV_THRESHOLDS.populationP25) {
                    percentileText = ' ';
                    percentileClass = 'warning';
                } else {
                    percentileText = '';
                    percentileClass = 'bad';
                }

                document.getElementById('hrvStats').innerHTML = `
                    <div class="chart-stat">
                        <div class="chart-stat-value ${avgHrv >= HRV_THRESHOLDS.good ? 'good' : avgHrv >= HRV_THRESHOLDS.low ? 'warning' : 'bad'}">${avgHrv}${hrvTrend}</div>
                        <div class="chart-stat-label"> HRV</div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-value ${percentileClass}">${percentileText}</div>
                        <div class="chart-stat-label">vs 45-50 </div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-value">${minHrv}-${maxHrv}</div>
                        <div class="chart-stat-label"></div>
                    </div>
                    ${avgRestingHr ? `
                    <div class="chart-stat">
                        <div class="chart-stat-value ${avgRestingHr <= 55 ? 'good' : avgRestingHr <= 65 ? 'warning' : 'bad'}">${avgRestingHr}</div>
                        <div class="chart-stat-label"> </div>
                    </div>` : ''}
                `;
            } else {
                document.getElementById('hrvChartCard').style.display = 'none';
            }

            // Summary
            document.getElementById('summaryDaysInSystem').textContent = daysComplete;
            document.getElementById('summaryStreak').textContent = ' ' + (userData.stats?.current_streak || 0);
            document.getElementById('summaryAvgBP').textContent = avgSys ? `${avgSys}/${avgDia}` : '';
            document.getElementById('summaryAvgOura').textContent = avgOura || '';
            document.getElementById('summaryWorkouts').textContent = ' ' + totalWorkouts;

            //  AI 
            loadCorrelations();
        }

        // === EMAIL REPORT ===
        const REPORT_EMAIL = 'komissarov@kamenskvolokno.ru';
        let currentReportText = '';
        let currentReportSubject = '';

        window.generateAndShowReport = async function() {
            const statusEl = document.getElementById('emailStatus');
            statusEl.textContent = '  AI-...';

            try {
                //    AI-
                const data = getHistoricalData(trendsPeriod);
                const stats = {
                    period: trendsPeriod,
                    bp: data.filter(d => d.morning?.bp_sys).map(d => ({ sys: d.morning.bp_sys, dia: d.morning.bp_dia })),
                    hrv: data.filter(d => d.oura?.hrv).map(d => d.oura.hrv),
                    oura: data.filter(d => d.morning?.oura).map(d => d.morning.oura),
                    weight: data.filter(d => d.morning?.weight).map(d => d.morning.weight),
                    workouts: data.reduce((sum, d) => sum + (d.workouts?.length || 0), 0)
                };

                //  AI- (  )
                let conclusions = null;
                if (API_KEY) {
                    conclusions = await generateReportConclusions(stats);
                }

                statusEl.textContent = '  ...';
                const report = generateTrendsReport();

                //  AI-  
                let fullBody = report.body;
                if (conclusions) {
                    let aiSection = `\n AI-  \n`;
                    aiSection += `${''.repeat(30)}\n\n`;

                    const trendIcon = conclusions.trend === 'improving' ? '' : conclusions.trend === 'declining' ? '' : '';
                    const trendText = conclusions.trend === 'improving' ? '' : conclusions.trend === 'declining' ? '' : '';
                    aiSection += `: ${trendIcon} ${trendText}\n\n`;

                    if (conclusions.summary) {
                        aiSection += `: ${conclusions.summary}\n\n`;
                    }

                    if (conclusions.keyFindings?.length) {
                        aiSection += ` :\n`;
                        conclusions.keyFindings.forEach((f, i) => {
                            aiSection += `${i + 1}. ${f}\n`;
                        });
                        aiSection += `\n`;
                    }

                    if (conclusions.recommendations?.length) {
                        aiSection += `:\n`;
                        conclusions.recommendations.forEach((r, i) => {
                            aiSection += `${i + 1}. ${r}\n`;
                        });
                        aiSection += `\n`;
                    }

                    if (conclusions.warnings?.length) {
                        aiSection += ` :\n`;
                        conclusions.warnings.forEach(w => {
                            aiSection += ` ${w}\n`;
                        });
                        aiSection += `\n`;
                    }

                    fullBody = fullBody.replace(
                        `${''.repeat(40)}\n: Life Tracker PWA`,
                        aiSection + `${''.repeat(40)}\n: Life Tracker PWA ( AI-)`
                    );
                }

                //   
                currentReportText = fullBody;
                currentReportSubject = report.subject;

                //   
                document.getElementById('reportPreview').textContent = fullBody;
                document.getElementById('reportModal').classList.remove('hidden');
                statusEl.textContent = '';

            } catch (e) {
                console.error('Report generation error:', e);
                statusEl.textContent = ' : ' + e.message;
            }
        };

        window.closeReportModal = function() {
            document.getElementById('reportModal').classList.add('hidden');
        };

        window.copyReport = async function() {
            const statusEl = document.getElementById('reportActionStatus');
            try {
                await navigator.clipboard.writeText(currentReportText);
                statusEl.textContent = '   !';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            } catch (e) {
                statusEl.textContent = '  ';
            }
        };

        window.shareToTelegram = function() {
            const text = encodeURIComponent(currentReportText);
            // Telegram  ,     
            if (currentReportText.length > 4000) {
                //      Telegram
                navigator.clipboard.writeText(currentReportText);
                document.getElementById('reportActionStatus').textContent = '  ,   Telegram';
                window.open('https://t.me/', '_blank');
            } else {
                window.open(`https://t.me/share/url?text=${text}`, '_blank');
            }
        };

        window.openMailClient = function() {
            const subject = encodeURIComponent(currentReportSubject);
            const body = encodeURIComponent(currentReportText);
            const mailtoUrl = `mailto:${REPORT_EMAIL}?subject=${subject}&body=${body}`;

            if (mailtoUrl.length > 2000) {
                navigator.clipboard.writeText(currentReportText);
                document.getElementById('reportActionStatus').innerHTML = '  !<br>  ';
                window.open(`mailto:${REPORT_EMAIL}?subject=${subject}`, '_blank');
            } else {
                window.open(mailtoUrl, '_blank');
            }
        };

        function generateTrendsReport() {
            const data = getHistoricalData(trendsPeriod);
            const today = new Date().toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });

            //  
            const bpData = data.filter(d => d.morning?.bp_sys).map(d => ({ sys: d.morning.bp_sys, dia: d.morning.bp_dia }));
            const avgSys = bpData.length ? Math.round(bpData.reduce((a, b) => a + b.sys, 0) / bpData.length) : null;
            const avgDia = bpData.length ? Math.round(bpData.reduce((a, b) => a + b.dia, 0) / bpData.length) : null;
            const maxSys = bpData.length ? Math.max(...bpData.map(b => b.sys)) : null;
            const minSys = bpData.length ? Math.min(...bpData.map(b => b.sys)) : null;

            const ouraData = data.filter(d => d.morning?.oura).map(d => d.morning.oura);
            const avgOura = ouraData.length ? Math.round(ouraData.reduce((a, b) => a + b, 0) / ouraData.length) : null;

            const hrvData = data.filter(d => d.oura?.hrv).map(d => d.oura.hrv);
            const avgHrv = hrvData.length ? Math.round(hrvData.reduce((a, b) => a + b, 0) / hrvData.length) : null;

            const weightData = data.filter(d => d.morning?.weight).map(d => d.morning.weight);
            const currentWeight = weightData.length ? weightData[0] : null;
            const startWeight = weightData.length ? weightData[weightData.length - 1] : null;
            const weightChange = currentWeight && startWeight ? (currentWeight - startWeight).toFixed(1) : null;

            const workouts = data.reduce((sum, d) => sum + (d.workouts?.length || 0), 0);
            const workoutMins = data.reduce((sum, d) => sum + (d.workouts?.reduce((s, w) => s + (w.duration || 0), 0) || 0), 0);

            const breathingMins = data.reduce((sum, d) => sum + (d.breathing?.reduce((s, b) => s + (b.duration || 0), 0) || 0), 0);

            // 
            const nutritionDays = data.filter(d => d.meals?.length > 0);
            const avgCalories = nutritionDays.length
                ? Math.round(nutritionDays.reduce((sum, d) => sum + d.meals.reduce((s, m) => s + (m.calories || 0), 0), 0) / nutritionDays.length)
                : null;
            const avgProtein = nutritionDays.length
                ? Math.round(nutritionDays.reduce((sum, d) => sum + d.meals.reduce((s, m) => s + (m.protein || 0), 0), 0) / nutritionDays.length)
                : null;
            const avgSalt = nutritionDays.length
                ? (nutritionDays.reduce((sum, d) => sum + d.meals.reduce((s, m) => s + (m.salt || 0), 0), 0) / nutritionDays.length).toFixed(1)
                : null;

            // HRV 
            let hrvPercentile = '';
            if (avgHrv) {
                if (avgHrv >= HRV_THRESHOLDS.populationP90) hrvPercentile = ' 10%';
                else if (avgHrv >= HRV_THRESHOLDS.populationP75) hrvPercentile = ' 25%';
                else if (avgHrv >= HRV_THRESHOLDS.populationMedian) hrvPercentile = ' ';
                else hrvPercentile = ' ';
            }

            //   
            const subject = `Life Tracker:   ${trendsPeriod}  (${today})`;

            let body = ` LIFE TRACKER\n`;
            body += `: ${trendsPeriod} \n`;
            body += `: ${today}\n`;
            body += `${''.repeat(40)}\n\n`;

            body += `  \n`;
            body += `${''.repeat(30)}\n`;
            if (avgSys) {
                body += `: ${avgSys}/${avgDia}  ..\n`;
                body += ` : ${minSys}-${maxSys}\n`;
                body += `: ${avgSys < 130 ? '  ' : avgSys < 140 ? ' ' : ' '}\n`;
            } else {
                body += ` \n`;
            }
            body += `\n`;

            body += ` HRV ()\n`;
            body += `${''.repeat(30)}\n`;
            if (avgHrv) {
                body += ` HRV: ${avgHrv} \n`;
                body += `Vs  45-50 : ${hrvPercentile}\n`;
                body += ` : ${HRV_THRESHOLDS.populationMedian} \n`;
            } else {
                body += `  (  Oura)\n`;
            }
            body += `\n`;

            body += ` OURA READINESS\n`;
            body += `${''.repeat(30)}\n`;
            if (avgOura) {
                body += `: ${avgOura}/100\n`;
                body += `: ${avgOura >= 85 ? ' ' : avgOura >= 70 ? ' ' : '  '}\n`;
            } else {
                body += ` \n`;
            }
            body += `\n`;

            body += ` \n`;
            body += `${''.repeat(30)}\n`;
            if (currentWeight) {
                body += `: ${currentWeight} \n`;
                if (weightChange) {
                    const sign = weightChange > 0 ? '+' : '';
                    body += `  : ${sign}${weightChange} \n`;
                }
            } else {
                body += ` \n`;
            }
            body += `\n`;

            body += ` \n`;
            body += `${''.repeat(30)}\n`;
            body += `: ${workouts}\n`;
            body += ` : ${workoutMins} \n`;
            body += `\n`;

            body += ` \n`;
            body += `${''.repeat(30)}\n`;
            body += ` : ${breathingMins} \n`;
            body += `\n`;

            body += `  (/)\n`;
            body += `${''.repeat(30)}\n`;
            if (avgCalories) {
                body += `: ${avgCalories} \n`;
                body += `: ${avgProtein} ${avgProtein >= 180 ? '' : ''}\n`;
                body += `: ${avgSalt} ${parseFloat(avgSalt) <= 5 ? '' : ''}\n`;
            } else {
                body += ` \n`;
            }
            body += `\n`;

            // AI-
            if (correlationsCache && correlationsCache.length > 0) {
                body += ` AI-\n`;
                body += `${''.repeat(30)}\n`;
                correlationsCache.forEach((c, i) => {
                    const impactIcon = c.impact === 'positive' ? '' : c.impact === 'negative' ? '' : '';
                    body += `${i + 1}. ${c.icon || ''} ${c.title} ${impactIcon}\n`;
                    body += `   ${c.details}\n`;
                    if (c.action) {
                        body += `    ${c.action}\n`;
                    }
                    body += `\n`;
                });
            }

            body += `${''.repeat(40)}\n`;
            body += `: Life Tracker PWA\n`;

            return { subject, body };
        }

        //  AI-  
        async function generateReportConclusions(stats) {
            if (!API_KEY) return null;

            const prompt = `        .

:
${JSON.stringify(stats, null, 2)}

${correlationsCache ? `AI-:\n${JSON.stringify(correlationsCache, null, 2)}` : ''}

 JSON:
{
  "summary": "1-2   ",
  "trend": "improving" | "stable" | "declining",
  "keyFindings": [" 1", " 2", " 3"],
  "recommendations": [" 1", " 2", " 3"],
  "warnings": ["  "]
}`;

            const system = `  AI- . : 48 ,  I .,   <130/85.
      .  ,    .`;

            try {
                const response = await callAI([{ role: 'user', content: prompt }], system);
                return extractJSON(response);
            } catch (e) {
                console.error('Report conclusions error:', e);
                return null;
            }
        }

        // === BP PREDICTION ===
        const BP_PREDICTION_SYSTEM = `  AI-    .

 :
 48 ,  I .,  
 :  5,  25
  : <130/85
 ACTN3 XX   

 :
          .

  (  ):
1. Oura Readiness <65      5-10
2.   (<6   <70%)   
3.    (, , )     5-15
4.   ( 20:00)    
5.     
6.          (  )
7. /    
8.      

 JSON:
{
  "risk": "low" | "medium" | "high",
  "predicted_range": "120-125/78-82",
  "confidence":  1-100,
  "factors": [" 1", " 2"],
  "recommendation": "   "
}`;

        async function loadBPPrediction() {
            const container = document.getElementById('bpPrediction');
            const card = document.getElementById('bpPredictionCard');

            if (!API_KEY) {
                card.style.display = 'none';
                return;
            }

            //     7    
            const historyData = [];
            const now = new Date();

            for (let i = 1; i <= 7; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const key = dateToKey(d);
                const dayData = userData.days?.[key];

                if (dayData) {
                    historyData.push({
                        date: key,
                        daysAgo: i,
                        morning: dayData.morning || null,
                        evening: dayData.evening || null,
                        meals: dayData.meals || [],
                        workouts: dayData.workouts || [],
                        breathing: dayData.breathing || []
                    });
                }
            }

            //      ( )
            const yesterdayDate = new Date(now);
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterdayKey = dateToKey(yesterdayDate);
            const yesterday = userData.days?.[yesterdayKey];

            //    (  )
            const todayMorning = todayData?.morning;

            if (historyData.length < 3) {
                container.innerHTML = `<div class="ai-prediction-loading">    (  3 )</div>`;
                return;
            }

            //          
            if (todayMorning?.bp_sys) {
                card.style.display = 'none';
                return;
            }

            container.innerHTML = `<div class="ai-prediction-loading">  ...</div>`;

            //    AI
            const bpHistory = historyData
                .filter(d => d.morning?.bp_sys)
                .map(d => `${d.daysAgo} : ${d.morning.bp_sys}/${d.morning.bp_dia}, Oura ${d.morning.oura || '?'}`);

            const yesterdayDetails = [];
            if (yesterday) {
                if (yesterday.morning?.oura) yesterdayDetails.push(`Oura: ${yesterday.morning.oura}`);
                if (yesterday.evening?.sleep_quality) yesterdayDetails.push(`: ${yesterday.evening.sleep_quality}/5`);
                if (yesterday.evening?.mood) yesterdayDetails.push(`: ${yesterday.evening.mood}/5`);
                if (yesterday.meals?.length) {
                    const lastMeal = yesterday.meals[yesterday.meals.length - 1];
                    const lastMealTime = new Date(lastMeal.time).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
                    yesterdayDetails.push(`  : ${lastMealTime}`);
                    yesterdayDetails.push(`: ${yesterday.meals.map(m => m.description || m.name).join(', ')}`);
                }
                if (yesterday.workouts?.length) {
                    const w = yesterday.workouts[0];
                    yesterdayDetails.push(`: ${WORKOUT_TYPES[w.type]?.name || w.type} ${w.duration}`);
                }
                if (yesterday.breathing?.length) {
                    const totalBreath = yesterday.breathing.reduce((s, b) => s + (b.duration || 0), 0);
                    yesterdayDetails.push(`: ${totalBreath}`);
                }
            }

            //  Oura ( )
            const todayOura = todayData?.morning?.oura;

            try {
                const prompt = `      .

  ( ):
${bpHistory.join('\n') || ' '}

:
${yesterdayDetails.join('\n') || ' '}

:
Oura Readiness: ${todayOura || '  '}

      .  JSON.`;

                const response = await callAI([{ role: 'user', content: prompt }], BP_PREDICTION_SYSTEM);

                let prediction = extractJSON(response);
                if (!prediction) {
                    //   JSON,   
                    container.innerHTML = `<div class="ai-prediction-content">${response}</div>`;
                    return;
                }

                const riskClass = prediction.risk || 'medium';
                const riskIcon = riskClass === 'high' ? '' : riskClass === 'medium' ? '' : '';
                const riskText = riskClass === 'high' ? ' ' : riskClass === 'medium' ? ' ' : ' ';
                const riskDesc = prediction.predicted_range ? ` : ${prediction.predicted_range}` : '';

                let html = `
                    <div class="prediction-risk ${riskClass}">
                        <div class="prediction-risk-icon">${riskIcon}</div>
                        <div class="prediction-risk-text">
                            <div class="prediction-risk-level">${riskText}</div>
                            <div class="prediction-risk-desc">${riskDesc}</div>
                        </div>
                    </div>
                `;

                if (prediction.factors && prediction.factors.length > 0) {
                    html += `
                        <div class="prediction-factors">
                            <div class="prediction-factors-title"> :</div>
                            ${prediction.factors.map(f => ` ${f}`).join('<br>')}
                        </div>
                    `;
                }

                if (prediction.recommendation) {
                    html += `
                        <div class="prediction-recommendation">
                             ${prediction.recommendation}
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (e) {
                console.error('BP Prediction error:', e);
                container.innerHTML = `<div class="ai-prediction-loading">   </div>`;
            }
        }

        // === AI CORRELATIONS ===
        const CORRELATIONS_SYSTEM = `  AI-   .

:  3-5    .

    JSON ,  :
[
  {
    "icon": "",
    "title": "  ",
    "details": "  >5,       8-10 ",
    "impact": "negative",
    "action": "  5"
  }
]

:
- impact: "positive" (), "negative" (), "neutral" ()
-  3 ,  5
-    
-      JSON!`;

        let correlationsCache = null;
        let correlationsCacheTime = 0;
        let correlationsData = [];
        let currentCorrelationIndex = 0;

        window.loadCorrelations = async function(forceRefresh = false) {
            const container = document.getElementById('aiCorrelations');

            if (!API_KEY) {
                container.innerHTML = `<div class="correlation-loading"> API   </div>`;
                return;
            }

            //   1  (   )
            const cacheAge = Date.now() - correlationsCacheTime;
            if (!forceRefresh && correlationsCache && cacheAge < 3600000) {
                renderCorrelations(correlationsCache);
                return;
            }

            container.innerHTML = `<div class="correlation-loading">    ${trendsPeriod} ...</div>`;

            //     
            const allData = [];
            const now = new Date();

            for (let i = 0; i < Math.max(trendsPeriod, 30); i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const key = dateToKey(d);
                const dayData = userData.days?.[key];

                if (dayData) {
                    allData.push({
                        date: key,
                        daysAgo: i,
                        morning: dayData.morning || null,
                        evening: dayData.evening || null,
                        oura: dayData.oura || null,
                        meals: dayData.meals || [],
                        workouts: dayData.workouts || [],
                        breathing: dayData.breathing || [],
                        habits: dayData.habits || {}
                    });
                }
            }

            if (allData.length < 7) {
                container.innerHTML = `<div class="correlation-loading">  (  7 )</div>`;
                return;
            }

            //    
            const dataForAI = allData.map(d => {
                const row = { date: d.date };

                //  
                if (d.morning) {
                    row.bp = d.morning.bp_sys ? `${d.morning.bp_sys}/${d.morning.bp_dia}` : null;
                    row.oura = d.morning.oura;
                    row.pulse = d.morning.pulse;
                    row.weight = d.morning.weight || null;
                }

                //  Oura (HRV,  )
                if (d.oura) {
                    row.hrv = d.oura.hrv || null;
                    row.restingHR = d.oura.resting_hr || null;
                    row.sleepDuration = d.oura.sleep_duration ? Math.round(d.oura.sleep_duration / 3600) : null; //  
                    row.sleepEfficiency = d.oura.sleep_efficiency || null;
                }

                // 
                if (d.meals.length > 0) {
                    row.calories = d.meals.reduce((s, m) => s + (m.calories || 0), 0);
                    row.protein = d.meals.reduce((s, m) => s + (m.protein || 0), 0);
                    row.salt = d.meals.reduce((s, m) => s + (m.salt || 0), 0);
                    row.lastMealTime = d.meals.length > 0 ? new Date(d.meals[d.meals.length - 1].time).getHours() : null;
                    row.foods = d.meals.map(m => m.description || m.name).join(', ');
                }

                // 
                if (d.workouts.length > 0) {
                    row.workout = d.workouts.map(w => `${WORKOUT_TYPES[w.type]?.name || w.type} ${w.duration}`).join(', ');
                    row.workoutDuration = d.workouts.reduce((s, w) => s + (w.duration || 0), 0);
                    //        HRV
                    row.rowingMins = d.workouts.filter(w => w.type === 'rowing').reduce((s, w) => s + (w.duration || 0), 0) || null;
                    row.strengthMins = d.workouts.filter(w => w.type === 'strength').reduce((s, w) => s + (w.duration || 0), 0) || null;
                    row.walkingMins = d.workouts.filter(w => w.type === 'walking').reduce((s, w) => s + (w.duration || 0), 0) || null;
                    row.stretchMins = d.workouts.filter(w => w.type === 'stretch').reduce((s, w) => s + (w.duration || 0), 0) || null;
                    row.workoutCalories = d.workouts.reduce((s, w) => s + (w.calories || 0), 0) || null;
                }

                // 
                if (d.evening) {
                    row.sleepQuality = d.evening.sleep_quality;
                    row.mood = d.evening.mood;
                }

                // 
                if (d.breathing.length > 0) {
                    row.breathing = d.breathing.reduce((s, b) => s + (b.duration || 0), 0);
                }

                return row;
            }).filter(r => r.bp || r.oura || r.workout); //    

            console.log('Correlations data collected:', allData.length, 'raw days,', dataForAI.length, 'filtered days');

            if (dataForAI.length < 3) {
                container.innerHTML = `<div class="correlation-loading">    ( ${dataForAI.length}   )</div>`;
                return;
            }

            try {
                const prompt = `     ${dataForAI.length}     .

 (   ):
${JSON.stringify(dataForAI.slice(0, 30), null, 2)}

  :
- " [/]     [/]  X"
- " Oura [</>] X,  []"
- "  ( 20:00)  []"
- " [>/< X ]     "
- "   Oura "
- "   X    [/]"
- "  Y      Z"
- " >X      +Y (!)"
- " >X      "
- "   +X       "

HRV (  )    ! :
- "  >X  HRV    [/]  Y"
- " >X  HRV [/]"
- " X  HRV    "
- "/  HRV []"
- " <X  HRV   Y"
- " >X  HRV  ()"
- " <X  HRV "
- " >130  HRV  "
- "   HRV "
- "  X  HRV "

:
-          !
- HRV      
-  HRV =   

 JSON   3-5   .`;

                const response = await callAI([{ role: 'user', content: prompt }], CORRELATIONS_SYSTEM);
                console.log('Correlations AI raw response:', response);

                let correlations = extractJSON(response);
                console.log('Correlations after extractJSON:', correlations, 'isArray:', Array.isArray(correlations));

                //      
                if (correlations && !Array.isArray(correlations)) {
                    console.log('Correlations is object, looking for array property...');
                    if (correlations.correlations) correlations = correlations.correlations;
                    else if (correlations.data) correlations = correlations.data;
                    else if (correlations.results) correlations = correlations.results;
                    else {
                        // ,        ( icon/title/details)
                        console.log('No known array property, wrapping in array');
                        correlations = [correlations];
                    }
                }
                console.log('Final correlations count:', correlations?.length);

                if (!correlations || !Array.isArray(correlations) || correlations.length === 0) {
                    console.error('Correlations invalid, using fallback. Response:', response?.substring(0, 300));
                    // Fallback     
                    correlations = [
                        {
                            icon: "",
                            title: "   ",
                            details: "   >5      ",
                            impact: "negative",
                            action: "  5  "
                        },
                        {
                            icon: "",
                            title: "  ",
                            details: "   2 (, )   ",
                            impact: "positive",
                            action: " 30-45  3-4   "
                        },
                        {
                            icon: "",
                            title: "  HRV",
                            details: "  <6  HRV  ,  ",
                            impact: "negative",
                            action: ": 7-8  "
                        }
                    ];
                    console.log('Using fallback correlations');
                }

                // 
                correlationsCache = correlations;
                correlationsCacheTime = Date.now();

                renderCorrelations(correlations);

            } catch (e) {
                console.error('Correlations error:', e);
                container.innerHTML = `<div class="correlation-loading">   </div>`;
            }
        };

        function renderCorrelations(correlations) {
            const container = document.getElementById('aiCorrelations');
            const nav = document.getElementById('correlationNav');
            const counter = document.getElementById('correlationCounter');

            console.log('renderCorrelations called with', correlations?.length, 'items');

            if (!correlations || correlations.length === 0) {
                container.innerHTML = `<div class="correlation-loading">  .   .</div>`;
                if (nav) nav.style.display = 'none';
                return;
            }

            //   
            correlationsData = correlations;
            currentCorrelationIndex = 0;

            //      
            if (nav) {
                nav.style.display = 'flex';
            }

            renderCurrentCorrelation();
        }

        function renderCurrentCorrelation() {
            const container = document.getElementById('aiCorrelations');
            const counter = document.getElementById('correlationCounter');

            if (!correlationsData || correlationsData.length === 0) return;

            const c = correlationsData[currentCorrelationIndex];

            container.innerHTML = `
                <div class="correlation-item">
                    <div class="correlation-header">
                        <span class="correlation-icon">${c.icon || ''}</span>
                        <span class="correlation-title">${c.title}</span>
                        <span class="correlation-impact ${c.impact || 'neutral'}">${c.impact === 'positive' ? '' : c.impact === 'negative' ? '' : ''}</span>
                    </div>
                    <div class="correlation-details">${c.details}</div>
                    ${c.action ? `<div class="correlation-confidence"> ${c.action}</div>` : ''}
                </div>
            `;

            if (counter) {
                counter.textContent = `${currentCorrelationIndex + 1} / ${correlationsData.length}`;
            }
        }

        window.prevCorrelation = function() {
            if (correlationsData.length === 0) return;
            currentCorrelationIndex = (currentCorrelationIndex - 1 + correlationsData.length) % correlationsData.length;
            renderCurrentCorrelation();
        };

        window.nextCorrelation = function() {
            if (correlationsData.length === 0) return;
            currentCorrelationIndex = (currentCorrelationIndex + 1) % correlationsData.length;
            renderCurrentCorrelation();
        };

        // === WEEKLY REPORT ===
        const WEEKLY_REPORT_SYSTEM = `  AI- .   .

 :
 48 ,  I .,  
 :  5,  25
 :  <130/85,  4+ /,  180/

:
       .

 :    JSON  markdown,  \`\`\`,  !

 :
{
  "trend": {
    "direction": "improving" | "stable" | "declining",
    "title": "    ",
    "description": ":  ,    "
  },
  "wins": [
    {"icon": "", "text": "   (  )"}
  ],
  "concerns": [
    {"icon": "", "text": "     "}
  ],
  "actions": [
    {"priority": 1, "text": "    "},
    {"priority": 2, "text": "  "},
    {"priority": 3, "text": "  ()"}
  ],
  "summary": "1-2    "
}

   {   }   !`;

        window.generateWeeklyReport = async function() {
            const container = document.getElementById('weeklyReport');
            const btn = document.getElementById('generateReportBtn');

            if (!API_KEY) {
                container.innerHTML = `<div class="report-loading"> API   </div>`;
                return;
            }

            btn.disabled = true;
            btn.textContent = ' ...';
            container.innerHTML = `<div class="report-loading">    ...</div>`;

            //    7 
            const weekData = [];
            const now = new Date();

            for (let i = 0; i < 7; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const key = dateToKey(d);
                const dayData = userData.days?.[key];

                if (dayData) {
                    const day = {
                        date: key,
                        dayOfWeek: d.toLocaleDateString('ru-RU', { weekday: 'short' })
                    };

                    if (dayData.morning) {
                        day.bp = `${dayData.morning.bp_sys}/${dayData.morning.bp_dia}`;
                        day.bpSys = dayData.morning.bp_sys;
                        day.oura = dayData.morning.oura;
                        day.pulse = dayData.morning.pulse;
                    }

                    if (dayData.meals?.length) {
                        day.calories = dayData.meals.reduce((s, m) => s + (m.calories || 0), 0);
                        day.protein = dayData.meals.reduce((s, m) => s + (m.protein || 0), 0);
                    }

                    if (dayData.workouts?.length) {
                        day.workouts = dayData.workouts.map(w =>
                            `${WORKOUT_TYPES[w.type]?.name || w.type} ${w.duration}`
                        ).join(', ');
                        day.workoutCount = dayData.workouts.length;
                        day.workoutMinutes = dayData.workouts.reduce((s, w) => s + (w.duration || 0), 0);
                    }

                    if (dayData.breathing?.length) {
                        day.breathing = dayData.breathing.reduce((s, b) => s + (b.duration || 0), 0);
                    }

                    if (dayData.habits) {
                        const min = ['steps_min', 'protein_meal', 'breathing'];
                        day.habitsComplete = min.filter(id => dayData.habits[id]).length === 3;
                    }

                    weekData.push(day);
                }
            }

            //      
            let prevWeekBP = [];
            for (let i = 7; i < 14; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const key = dateToKey(d);
                const dayData = userData.days?.[key];
                if (dayData?.morning?.bp_sys) {
                    prevWeekBP.push(dayData.morning.bp_sys);
                }
            }
            const prevWeekAvgBP = prevWeekBP.length ? Math.round(prevWeekBP.reduce((a,b) => a+b, 0) / prevWeekBP.length) : null;

            //   
            const currentBP = weekData.filter(d => d.bpSys).map(d => d.bpSys);
            const currentAvgBP = currentBP.length ? Math.round(currentBP.reduce((a,b) => a+b, 0) / currentBP.length) : null;
            const totalWorkouts = weekData.reduce((s, d) => s + (d.workoutCount || 0), 0);
            const avgProtein = weekData.filter(d => d.protein).length ?
                Math.round(weekData.filter(d => d.protein).reduce((s, d) => s + d.protein, 0) / weekData.filter(d => d.protein).length) : null;

            //    
            if (weekData.length > 0) {
                const firstDate = weekData[weekData.length - 1]?.date;
                const lastDate = weekData[0]?.date;
                document.getElementById('weeklyReportPeriod').textContent =
                    `${new Date(firstDate).toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'})}  ${new Date(lastDate).toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'})}`;
            }

            try {
                const prompt = `     .

  :
${JSON.stringify(weekData, null, 2)}

:
-  : ${currentAvgBP || ' '} ( : ${prevWeekAvgBP || ''})
- : ${totalWorkouts}
-  : ${avgProtein || ' '}
-  : ${weekData.length}

    JSON ( \`\`\`,   /).`;

                let report = null;
                let attempts = 0;
                const maxAttempts = 2;

                while (!report && attempts < maxAttempts) {
                    attempts++;
                    const retryNote = attempts > 1 ? ' (retry)' : '';
                    container.innerHTML = `<div class="report-loading">    ...${retryNote}</div>`;

                    const response = await callAI([{ role: 'user', content: prompt }], WEEKLY_REPORT_SYSTEM);
                    console.log(`Weekly Report Raw Response (attempt ${attempts}):`, response);

                    report = extractJSON(response);

                    if (!report && attempts < maxAttempts) {
                        console.warn(`Weekly Report: attempt ${attempts} failed, retrying...`);
                    }
                }

                if (!report) {
                    console.error('Weekly Report: All attempts failed');
                    container.innerHTML = `<div class="report-loading"> AI    .   .</div>`;
                    btn.disabled = false;
                    btn.textContent = '  ';
                    return;
                }

                renderWeeklyReport(report, true);

            } catch (e) {
                console.error('Weekly report error:', e);
                container.innerHTML = `<div class="report-loading">   </div>`;
            }

            btn.disabled = false;
            btn.textContent = '  ';
        };

        function renderWeeklyReport(report, isAIReport = true) {
            const container = document.getElementById('weeklyReport');

            //   
            const sourceBadge = isAIReport
                ? '<div style="text-align:right;margin-bottom:8px;"><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:10px;font-size:11px;"> AI-</span></div>'
                : '<div style="text-align:right;margin-bottom:8px;"><span style="background:#fff3e0;color:#e65100;padding:2px 8px;border-radius:10px;font-size:11px;">  </span></div>';

            let html = sourceBadge;

            //  
            if (report.trend) {
                const trendClass = report.trend.direction || 'stable';
                const trendIcon = trendClass === 'improving' ? '' : trendClass === 'declining' ? '' : '';
                html += `
                    <div class="report-trend ${trendClass}">
                        <div class="report-trend-icon">${trendIcon}</div>
                        <div class="report-trend-text">
                            <div class="report-trend-title">${report.trend.title}</div>
                            <div class="report-trend-desc">${report.trend.description}</div>
                        </div>
                    </div>
                `;
            }

            //  
            if (report.wins?.length) {
                html += `
                    <div class="report-section">
                        <div class="report-section-header">
                            <span class="report-section-icon"></span>
                            <span class="report-section-title"> </span>
                        </div>
                        <ul class="report-list">
                            ${report.wins.map(w => `
                                <li>
                                    <span class="report-list-icon">${w.icon || ''}</span>
                                    <span>${w.text}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            //   
            if (report.concerns?.length) {
                html += `
                    <div class="report-section">
                        <div class="report-section-header">
                            <span class="report-section-icon"></span>
                            <span class="report-section-title"> </span>
                        </div>
                        <ul class="report-list">
                            ${report.concerns.map(c => `
                                <li>
                                    <span class="report-list-icon">${c.icon || ''}</span>
                                    <span>${c.text}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            //    
            if (report.actions?.length) {
                html += `
                    <div class="report-actions">
                        <div class="report-actions-title">    :</div>
                        ${report.actions.map(a => `
                            <div class="report-action-item">
                                <span>${a.priority}.</span>
                                <span>${a.text}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // 
            if (report.summary) {
                html += `
                    <div style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 13px; color: #94a3b8; text-align: center;">
                        ${report.summary}
                    </div>
                `;
            }

            container.innerHTML = html || '<div class="report-loading">   </div>';
        }

        // === INIT ===
        let lastDateKey = '';
        
        async function init() {
            console.log('Init started');
            try {
                await loadData();
                console.log('Data loaded');
                lastDateKey = getDateKey();
                
                //     
                todayData = userData.days[getDateKey()] || null;
                console.log('Today data:', todayData ? 'exists' : 'null');
                
                document.getElementById('morningDate').textContent = formatDate(getToday());
                
                //  Oura
                checkOuraAvailable();
                
                if (!API_KEY) { 
                    console.log('No API key, showing setup');
                    showScreen('setup'); 
                    return; 
                }
                if (todayData?.morning) { 
                    console.log('Morning data exists, showing main');
                    showScreen('main'); 
                    updateMain(); 
                } else { 
                    console.log('No morning data, showing morning');
                    showScreen('morning'); 
                }
            } catch(e) {
                console.error('Init error:', e);
                alert(' : ' + e.message);
            }
        }
        
        //        
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                const newDateKey = getDateKey();
                if (newDateKey !== lastDateKey) {
                    //  !
                    console.log(' :', newDateKey);
                    lastDateKey = newDateKey;
                    todayData = userData.days[newDateKey] || null;
                    
                    document.getElementById('morningDate').textContent = formatDate(getToday());
                    
                    if (todayData?.morning) { 
                        showScreen('main'); 
                        updateMain(); 
                    } else { 
                        showScreen('morning'); 
                    }
                }
            }
        });
        
        setTimeout(init, 500);
    </script>
</body>
</html>
